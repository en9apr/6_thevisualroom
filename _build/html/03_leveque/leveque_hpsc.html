<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>3. High Performance Scientific Computing - Projects &#8212; The Visual Room</title>
    
    <link rel="stylesheet" href="../_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="The Visual Room" href="../index.html" />
    <link rel="next" title="4. Literature" href="../04_literature/literature.html" />
    <link rel="prev" title="2.3.1. Finite Difference and Finite Volume Projects" href="../02_barba_projects/assignments.html" /> 
  </head>
  <body role="document">
      <div class="header" role="banner"><h1 class="heading"><a href="../index.html">
          <span>The Visual Room</span></a></h1>
        <h2 class="heading"><span>3. High Performance Scientific Computing - Projects</span></h2>
      </div>
      <div class="topnav" role="navigation" aria-label="top navigation">
      
        <p>
        «&#160;&#160;<a href="../02_barba_projects/assignments.html">2.3.1. Finite Difference and Finite Volume Projects</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="../04_literature/literature.html">4. Literature</a>&#160;&#160;»
        </p>

      </div>
      <div class="content">
        
        
  <div class="section" id="high-performance-scientific-computing-projects">
<h1>3. High Performance Scientific Computing - Projects<a class="headerlink" href="#high-performance-scientific-computing-projects" title="Permalink to this headline">¶</a></h1>
<p>This page contains the following codes:</p>
<ul>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#workspace-1-testing-scripts-and-dummy-code">Workspace 1: Testing Scripts and Dummy Code</a></dt>
<dd><ul class="first last simple">
<li><strong>test1.py</strong> (python script to test for environment variables and python version)</li>
<li><strong>test2.sh</strong> (shell script to test for environment variables, gfortran and ipython version)</li>
<li><strong>test3.f90</strong> (a dummy fortran code)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#workspace-2-quadratic-cubic-and-polynomial-interpolation">Workspace 2: Quadratic, Cubic and Polynomial Interpolation</a></dt>
<dd><ul class="first last simple">
<li><strong>hw2a.py</strong> (python script for quadratic interpolation)</li>
<li><strong>hw2b.py</strong> (python script for quadratic, cubic and polynomial interpolation)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#workspace-3-newton-s-method-and-convergence-criteria">Workspace 3: Newton&#8217;s Method and Convergence Criteria</a></dt>
<dd><ul class="first last simple">
<li><strong>newton.py</strong> (ipython module to compute square root of a number using Newton&#8217;s method)</li>
<li><strong>intersections.py</strong> (ipython script to plot a graph where two functions intersect - uses newton.py)</li>
<li><strong>test1.f90, newton.f90, intersections.f90, functions.f90, Makefile</strong> (fortran code for the intersection problem using max iterations for convergence)</li>
<li><strong>problem7/newton.f90, problem7/functions.f90, problem7/test_quartic.f90, problem7/Makefile, problem7/intersections.py</strong> (intersection problem using residual error for convergence)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#workspace-4-openmp">Workspace 4: OpenMP</a></dt>
<dd><ul class="first last simple">
<li><strong>quadrature.f90</strong> (module for integrating a function)</li>
<li><strong>test1.f90</strong> (cubic function - uses quadrature module)</li>
<li><strong>test2.f90</strong> (sinusoidal function - uses quadrature module)</li>
<li><strong>quadrature_omp.f90, test2_omp.f90</strong> (same as above but using OpenMP)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#workspace-5-load-balancing">Workspace 5: Load Balancing</a></dt>
<dd><ul class="first last simple">
<li><strong>Makefile</strong> (makefile for the 1D solution)</li>
<li><strong>functions.f90</strong> (sinusoidal function module)</li>
<li><strong>quadrature.f90, test.f90</strong> (trapezoid rule module + test - serial)</li>
<li><strong>quadrature2.f90, test2.f90</strong> (simpson&#8217;s rule module + test - serial)</li>
<li><strong>quadrature3.f90, test3.f90</strong> (trapezoid rule module + test - OpenMP)</li>
<li><strong>quad2d/functions.f90, quad2d/quadrature.f90, quad2d/test.f90, quad2d/Makefile</strong> (integrate a sinusoid with trapezoid rule in 2D with Open MP and load balancing)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#workspace-6-mpi">Workspace 6: MPI</a></dt>
<dd><ul class="first last simple">
<li><strong>Makefile</strong> (makefile for this directory)</li>
<li><strong>copyvalue.f90</strong> (passes a value from Process 0 to Processes 1-3 using MPI)</li>
<li><strong>copyvalue2.f90</strong> (passes a value from Process 3 to Processes 0-2 using MPI)</li>
<li><strong>part2/functions.f90, part2/quadrature.f90, part2/Makefile</strong> (the sinusoidal function, quadrature module and makefile)</li>
<li><strong>part2/test.f90</strong> (compute the same integral over all Processes using MPI)</li>
<li><strong>part2/test2.f90</strong> (integral using Master-Worker paradigm)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#project-1-1d-integral-and-mpi">Project 1: 1D Integral and MPI</a></dt>
<dd><ul class="first last simple">
<li><strong>functions.f90, quadrature.f90, test2.f90, Makefile</strong> (compute a 1D integral using MPI by dividing up intervals between an indeterminate number of processes)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#project-2-20d-integral-and-the-monte-carlo-method">Project 2: 20D Integral and the Monte Carlo Method</a></dt>
<dd><ul class="first last simple">
<li><strong>functions.f90, quadrature_mc.f90, random_util.f90, test_quad_mc.f90, Makefile</strong> (compute integral using Monte Carlo method for a 20 dimensional integral - serial)</li>
<li><strong>plot_mc_quad_error.py</strong> (plot the result)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#project-3-laplace-s-equation-and-the-monte-carlo-method">Project 3: Laplace&#8217;s Equation and the Monte Carlo Method</a></dt>
<dd><ul class="first last simple">
<li><strong>laplace_mc.py</strong> (python version)</li>
<li><strong>problem_description.f90, laplace_mc.f90, mc_walk.f90, random_util.f90, Makefile</strong> (compute the solution to Laplace&#8217;s Equation using the Monte Carlo Method - serial)</li>
<li><strong>test1.f90, test2.f90</strong> (trials I made along the way)</li>
<li><strong>plot_mc_quad_error.py</strong> (plot the result)</li>
</ul>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt><a class="reference internal" href="#project-4-laplace-s-equation-mpi-and-the-monte-carlo-method">Project 4: Laplace&#8217;s Equation, MPI and the Monte Carlo Method</a></dt>
<dd><ul class="first last simple">
<li><strong>problem_description.f90, laplace_mc.f90, mc_walk.f90, random_util.f90, Makefile</strong> (compute the solution to Laplace&#8217;s Equation using the Monte Carlo Method - using MPI)</li>
<li><strong>test1.f90, test1b.f90, test2.f90</strong> (trials I made along the way)</li>
<li><strong>plot_mc_quad_error.py</strong> (plot the result)</li>
</ul>
</dd>
</dl>
</li>
</ul>
<div class="section" id="workspace-1-testing-scripts-and-dummy-code">
<h2>3.1. Workspace 1: Testing Scripts and Dummy Code<a class="headerlink" href="#workspace-1-testing-scripts-and-dummy-code" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>test1.py</strong> (python script to test for environment variables and python version)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">test1.py file</span>

<span class="sd">Note: this is a Python script.  What you are reading now in the triple</span>
<span class="sd">quotes is a comment (a &quot;docstring&quot; since it&#39;s the first thing in this file).</span>

<span class="sd">This file is to test whether you have environment variables set properly and</span>
<span class="sd">are able to import numpy (for numerical computation), matplotlib, </span>
<span class="sd">and pylab (for plotting).</span>

<span class="sd">Instructions:</span>

<span class="sd">Make sure your environment variables $UWHPSC and $MYHPSC are set properly.</span>

<span class="sd">Insert your name where instructed below.</span>

<span class="sd">Type</span>
<span class="sd">    $ python test1.py</span>
<span class="sd">at the Unix prompt ($ represents the prompt) to run the code.</span>

<span class="sd">If the output looks ok, change the file to set debug_mode = False</span>
<span class="sd">below and run it again.  This time the results will go into a file</span>
<span class="sd">test1output.txt.   Check that these look ok.</span>

<span class="sd">Commit the final version of this file along with test1output.txt to your git</span>
<span class="sd">repository.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span>

<span class="n">debug_mode</span> <span class="o">=</span> <span class="kc">False</span>

<span class="k">if</span> <span class="n">debug_mode</span><span class="p">:</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>  <span class="c1"># send output to screen</span>
<span class="k">else</span><span class="p">:</span>
    <span class="c1"># Once it&#39;s working, send output to a file rather than screen:</span>
    <span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;test1output.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">output_file</span>

<span class="nb">print</span> <span class="s2">&quot;Code run by **Andrew Roberts**&quot;</span>

<span class="n">UWHPSC</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;UWHPSC&#39;</span><span class="p">,</span><span class="s1">&#39;** not set **&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Environment variable UWHPSC is </span><span class="si">%s</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="n">UWHPSC</span>

<span class="n">MYHPSC</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;MYHPSC&#39;</span><span class="p">,</span><span class="s1">&#39;** not set **&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="s2">&quot;Environment variable MYHPSC is </span><span class="si">%s</span><span class="s2">&quot;</span>  <span class="o">%</span> <span class="n">MYHPSC</span>


<span class="c1"># Check for various Python modules and print an error message if</span>
<span class="c1"># an exception occurs:</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">numpy</span>
    <span class="nb">print</span> <span class="s2">&quot;Imported numpy ok&quot;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;** Error importing numpy&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="nb">print</span> <span class="s2">&quot;Imported matplotlib ok&quot;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;** Error importing matplotlib&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">pylab</span>
    <span class="nb">print</span> <span class="s2">&quot;Imported pylab ok&quot;</span>
<span class="k">except</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;** Error importing pylab&quot;</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">debug_mode</span><span class="p">:</span>
    <span class="n">output_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c1"># close the text file</span>


</pre></div>
</div>
<ul class="simple">
<li><strong>test2.sh</strong> (shell script to test for environment variables, gfortran and ipython version)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>
# bash script to check for software 
# Insert your name where indicated below, then type
#    $ bash test2.sh
# When it looks good, redirect output to a file:
#    $ bash test2h.sh &gt; test2output.txt

echo 
echo Code run by  **Andrew Roberts**
echo Environment variable UWHPSC is $UWHPSC
echo Environment variable MYHPSC is $MYHPSC

echo 
echo which ipython returns...
which ipython

echo 
echo which gfortran returns...
which gfortran

echo 
echo gfortran --version returns...
gfortran --version

echo
echo Compiling and running a Fortran code...
gfortran test3.f90
./a.out

</pre></div>
</div>
<ul class="simple">
<li><strong>test3.f90</strong> (a dummy fortran code)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! Test fortran program.</span>
<span class="c">! Insert your name where indicated below.  </span>
<span class="c">! This code will be compiled and run when you execute the test2.sh script.</span>

   <span class="k">program </span><span class="n">test</span>
	   <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Code run by  **Andrew Roberts**&quot;</span>
       <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Successfully ran Fortran 90 program&quot;</span>
   <span class="k">end program </span><span class="n">test</span>
</pre></div>
</div>
</div>
<div class="section" id="workspace-2-quadratic-cubic-and-polynomial-interpolation">
<h2>3.2. Workspace 2: Quadratic, Cubic and Polynomial Interpolation<a class="headerlink" href="#workspace-2-quadratic-cubic-and-polynomial-interpolation" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>hw2a.py</strong> (python script for quadratic interpolation)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demonstration script for quadratic interpolation.</span>
<span class="sd">Update this docstring to describe your code.</span>
<span class="sd">Modified by: ** your name here **</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">solve</span>

<span class="c1"># Set up linear system to interpolate through data points:</span>

<span class="c1"># Data points:</span>
<span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">])</span>

<span class="c1"># It would be better to define A in terms of the xi points.</span>
<span class="c1"># Doing this is part of the homework assignment.</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">]])</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">yi</span>

<span class="c1"># Solve the system:</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

<span class="nb">print</span> <span class="s2">&quot;The polynomial coefficients are:&quot;</span>
<span class="nb">print</span> <span class="n">c</span>

<span class="c1"># Plot the resulting polynomial:</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1001</span><span class="p">)</span>   <span class="c1"># points to evaluate polynomial</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>       <span class="c1"># open plot figure window</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>           <span class="c1"># clear figure</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;b-&#39;</span><span class="p">)</span>  <span class="c1"># connect points with a blue line</span>

<span class="c1"># Add data points  (polynomial should go through these points!)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">,</span><span class="s1">&#39;ro&#39;</span><span class="p">)</span>   <span class="c1"># plot as red circles</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">8</span><span class="p">)</span>         <span class="c1"># set limits in y for plot</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Data points and interpolating polynomial&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;demo1plot.png&#39;</span><span class="p">)</span>   <span class="c1"># save figure as .png file</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>hw2b.py</strong> (python script for quadratic, cubic and polynomial interpolation)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Demonstration module for quadratic interpolation.</span>
<span class="sd">Update this docstring to describe your code.</span>
<span class="sd">Modified by: ** Andrew Roberts **</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">numpy.linalg</span> <span class="k">import</span> <span class="n">solve</span>

<span class="k">def</span> <span class="nf">quad_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Quadratic interpolation.  Compute the coefficients of the polynomial</span>
<span class="sd">    interpolating the points (xi[i],yi[i]) for i = 0,1,2.</span>
<span class="sd">    Returns c, an array containing the coefficients of</span>
<span class="sd">      p(x) = c[0] + c[1]*x + c[2]*x**2.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check inputs and print error message if not valid:</span>

    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;xi and yi should have type numpy.ndarray&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">error_message</span>

    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;xi and yi should have length 3&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span><span class="o">==</span><span class="mi">3</span><span class="p">,</span> <span class="n">error_message</span>

    <span class="c1"># Set up linear system to interpolate through data points:</span>

    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xi</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">yi</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">c</span>

<span class="k">def</span> <span class="nf">cubic_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Cubic interpolation.  Compute the coefficients of the polynomial</span>
<span class="sd">    interpolating the points (xi[i],yi[i]) for i = 0,1,2,3.</span>
<span class="sd">    Returns c, an array containing the coefficients of</span>
<span class="sd">      p(x) = c[0] + c[1]*x + c[2]*x**2 +c[3]x**3.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check inputs and print error message if not valid:</span>

    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;xi and yi should have type numpy.ndarray&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">error_message</span>

    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;xi and yi should have length 4&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span><span class="o">==</span><span class="mi">4</span><span class="p">,</span> <span class="n">error_message</span>

    <span class="c1"># Set up linear system to interpolate through data points:</span>
    
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">xi</span><span class="p">,</span> <span class="n">xi</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">xi</span><span class="o">**</span><span class="mi">3</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">yi</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">c</span>

<span class="k">def</span> <span class="nf">poly_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Polynomial interpolation.  Compute the coefficients of the polynomial</span>
<span class="sd">    interpolating the points (xi[i],yi[i]) for i = 0,1,2... n</span>
<span class="sd">    Returns c, an array containing the coefficients of</span>
<span class="sd">      p(x) = c[0] + c[1]*x + c[2]*x**2 + c[3]x**3 +...+ c[n]x**n.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># check inputs and print error message if not valid:</span>

    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;xi and yi should have type numpy.ndarray&quot;</span>
    <span class="k">assert</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">yi</span><span class="p">)</span> <span class="ow">is</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">),</span> <span class="n">error_message</span>

    <span class="n">error_message</span> <span class="o">=</span> <span class="s2">&quot;xi and yi should have the same length&quot;</span>
    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span><span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">yi</span><span class="p">),</span> <span class="n">error_message</span>

    <span class="c1"># Set up linear system to interpolate through data points:</span>

    <span class="c1">#stacks them vertically and then takes transpose</span>
    <span class="c1">#A = np.empty([len(xi),len(xi)])</span>
    <span class="c1">#A[:,0] = 1.</span>
    <span class="c1">#for i in range(0,len(xi),1):</span>
    <span class="c1">#    for j in range(1,len(xi),1):</span>
    <span class="c1">#        A[i,j]=xi[i]**(j)</span>

    <span class="c1"># Uses a list comprehension:</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">xi</span><span class="o">**</span><span class="n">j</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">yi</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">b</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">c</span>
    
<span class="k">def</span> <span class="nf">plot_quad</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">quad_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;b-&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">,</span><span class="s1">&#39;ro&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x (-)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y (-)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Data points and interpolated polynomial&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;quadratic.png&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_cubic</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cubic_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;b-&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">,</span><span class="s1">&#39;ro&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x (-)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y (-)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Data points and interpolated polynomial&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;cubic.png&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_poly</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">):</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">poly_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xi</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">xi</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">c</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="s1">&#39;b-&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">,</span><span class="s1">&#39;ro&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x (-)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y (-)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Data points and interpolated polynomial&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;poly.png&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_quad1</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test code, no return value or exception if test runs properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">])</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>  <span class="mf">7.</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">quad_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">c_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span>  <span class="mf">0.</span><span class="p">,</span>  <span class="mf">2.</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;c =      &quot;</span><span class="p">,</span> <span class="n">c</span>
    <span class="nb">print</span> <span class="s2">&quot;c_true = &quot;</span><span class="p">,</span> <span class="n">c_true</span>
    <span class="c1"># test that all elements have small error:</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c_true</span><span class="p">),</span> \
        <span class="s2">&quot;Incorrect result, c = </span><span class="si">%s</span><span class="s2">, Expected: c = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c_true</span><span class="p">)</span>
        
<span class="k">def</span> <span class="nf">test_quad2</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test code, no return value or exception if test runs properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">10.</span><span class="p">,</span>  <span class="mf">1.</span><span class="p">,</span>  <span class="mf">20.</span><span class="p">])</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">15.</span><span class="p">,</span> <span class="o">-</span><span class="mf">50.</span><span class="p">,</span>  <span class="mf">70.</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">quad_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">c_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">48.16586922</span><span class="p">,</span>  <span class="o">-</span><span class="mf">2.24162679</span><span class="p">,</span>   <span class="mf">0.40749601</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;c =      &quot;</span><span class="p">,</span> <span class="n">c</span>
    <span class="nb">print</span> <span class="s2">&quot;c_true = &quot;</span><span class="p">,</span> <span class="n">c_true</span>
    <span class="c1"># test that all elements have small error:</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c_true</span><span class="p">),</span> \
        <span class="s2">&quot;Incorrect result, c = </span><span class="si">%s</span><span class="s2">, Expected: c = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c_true</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_cubic1</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test code, no return value or exception if test runs properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">])</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cubic_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">c_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.41666667</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08333333</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;c =      &quot;</span><span class="p">,</span> <span class="n">c</span>
    <span class="nb">print</span> <span class="s2">&quot;c_true = &quot;</span><span class="p">,</span> <span class="n">c_true</span>
    <span class="c1"># test that all elements have small error:</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c_true</span><span class="p">),</span> \
        <span class="s2">&quot;Incorrect result, c = </span><span class="si">%s</span><span class="s2">, Expected: c = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c_true</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_poly1</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test code, no return value or exception if test runs properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">])</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">cubic_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">c_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">2.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.41666667</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.08333333</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;c =      &quot;</span><span class="p">,</span> <span class="n">c</span>
    <span class="nb">print</span> <span class="s2">&quot;c_true = &quot;</span><span class="p">,</span> <span class="n">c_true</span>
    <span class="c1"># test that all elements have small error:</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c_true</span><span class="p">),</span> \
        <span class="s2">&quot;Incorrect result, c = </span><span class="si">%s</span><span class="s2">, Expected: c = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c_true</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test_poly2</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Test code, no return value or exception if test runs properly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">])</span>
    <span class="n">yi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">,</span> <span class="mf">15.</span><span class="p">,</span> <span class="mf">25.</span><span class="p">])</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">poly_interp</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span><span class="n">yi</span><span class="p">)</span>
    <span class="n">c_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.22777778</span><span class="p">,</span> <span class="mf">2.51944444</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.66111111</span><span class="p">,</span> <span class="mf">0.04722222</span><span class="p">])</span>
    <span class="nb">print</span> <span class="s2">&quot;c =      &quot;</span><span class="p">,</span> <span class="n">c</span>
    <span class="nb">print</span> <span class="s2">&quot;c_true = &quot;</span><span class="p">,</span> <span class="n">c_true</span>
    <span class="c1"># test that all elements have small error:</span>
    <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">c_true</span><span class="p">),</span> \
        <span class="s2">&quot;Incorrect result, c = </span><span class="si">%s</span><span class="s2">, Expected: c = </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="n">c_true</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span><span class="o">==</span><span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># &quot;main program&quot;</span>
    <span class="c1"># the code below is executed only if the module is executed at the command line,</span>
    <span class="c1">#    $ python demo2.py</span>
    <span class="c1"># or run from within Python, e.g. in IPython with</span>
    <span class="c1">#    In[ ]:  run demo2</span>
    <span class="c1"># not if the module is imported.</span>
    <span class="nb">print</span> <span class="s2">&quot;Running test...&quot;</span>
    <span class="n">test_quad1</span><span class="p">()</span>

</pre></div>
</div>
</div>
<div class="section" id="workspace-3-newton-s-method-and-convergence-criteria">
<h2>3.3. Workspace 3: Newton&#8217;s Method and Convergence Criteria<a class="headerlink" href="#workspace-3-newton-s-method-and-convergence-criteria" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>newton.py</strong> (ipython module to compute square root of a number using Newton&#8217;s method)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module to compute the square root of a number</span>
<span class="sd">using Newton&#39;s method: f(x) = x**2 - n = 0</span>

<span class="sd">Parameters:</span>
<span class="sd">	max_iter :- maximum number of iterations for iterative method</span>
<span class="sd">	tol :- relative residual tolerance for iterative method</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">max_iter</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">tol</span> <span class="o">=</span> <span class="mf">1.0e-14</span>

<span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Compute the solution to the function using the initial guess &amp; allow debugging</span>

<span class="sd">	Inputs:</span>
<span class="sd">		fvals_sqrt :- function returning tuple containing values of f(x) and f&#39;(x)</span>
<span class="sd">		x0 :- initial guess of the square root</span>
<span class="sd">		debug :- prints x0 outside loop and x within loop, default = False</span>
<span class="sd">	Outputs:</span>
<span class="sd">		x :- computed value of the square root</span>
<span class="sd">		iters :- the number of iterations taken </span>
<span class="sd">	Example usage:</span>
<span class="sd">		import newton; solve(4., True)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="n">iters</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>	
	
	<span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
		<span class="nb">print</span> <span class="s2">&quot;Initial guess: x = </span><span class="si">%20.15e</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">x0</span>

	<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_iter</span><span class="p">):</span>

		<span class="p">(</span><span class="n">fx</span><span class="p">,</span><span class="n">dfx</span><span class="p">)</span> <span class="o">=</span> <span class="n">fvals_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

		<span class="k">if</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span><span class="o">&lt;</span><span class="n">tol</span><span class="p">):</span>			
			<span class="k">break</span>

		<span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="p">(</span><span class="n">fx</span><span class="o">/</span><span class="n">dfx</span><span class="p">)</span>
		<span class="n">iters</span> <span class="o">=</span> <span class="n">iters</span> <span class="o">+</span> <span class="mi">1</span>		
		
		<span class="k">if</span><span class="p">(</span><span class="n">debug</span><span class="p">):</span>
			<span class="nb">print</span> <span class="s2">&quot;At iteration </span><span class="si">%d</span><span class="s2"> x = </span><span class="si">%20.15e</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> 
	<span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">iters</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">fvals_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Return a tuple containing the value of the function &amp; it&#39;s derivative at x</span>
<span class="sd">	</span>
<span class="sd">	Inputs:</span>
<span class="sd">		x :- value for which f(x) and f&#39;(x) are to be returned </span>
<span class="sd">	Outputs:</span>
<span class="sd">		f :- the value of the function, f(x)</span>
<span class="sd">		fp :- the derivative of the function, f&#39;(x)</span>
<span class="sd">	Example usage:	</span>
<span class="sd">		(f, fp) = fvals_sqrt(10)</span>
<span class="sd">	&quot;&quot;&quot;</span>
	
	<span class="c1">#f = x**2 - 4.0</span>
	<span class="c1">#fp = 2.0*x</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mf">0.6</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mf">1.2</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">test1</span><span class="p">(</span><span class="n">debug_solve</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
	<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">	Test Newton&#39;s method using an array of initial gusses</span>
<span class="sd">	</span>
<span class="sd">	Inputs:</span>
<span class="sd">		None</span>
<span class="sd">	Outputs:</span>
<span class="sd">		Print x, iters, and f(x) to the screen</span>
<span class="sd">	Example usage:</span>
<span class="sd">		import newton; newton.test1()</span>
<span class="sd">	&quot;&quot;&quot;</span>
	<span class="c1">#for x in [1., 2., 100.]:</span>
	<span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">]:</span>

		<span class="nb">print</span> <span class="s2">&quot;&quot;</span>

		<span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">iters</span><span class="p">)</span> <span class="o">=</span> <span class="n">solve</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">debug_solve</span><span class="p">)</span>
		<span class="nb">print</span> <span class="s2">&quot;After </span><span class="si">%d</span><span class="s2"> iterations, the solver returns x = </span><span class="si">%20.15e</span><span class="s2">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">iters</span><span class="p">,</span><span class="n">xout</span><span class="p">)</span>
		
		<span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span> <span class="o">=</span> <span class="n">fvals_sqrt</span><span class="p">(</span><span class="n">xout</span><span class="p">)</span>
		<span class="nb">print</span> <span class="s2">&quot;The function f(x) = </span><span class="si">%20.15e</span><span class="s2">&quot;</span> <span class="o">%</span><span class="n">f</span>

		<span class="c1">#assert abs(xout-2.0) &lt; tol, &quot;***Unexpected result: x = %22.15e&quot; %xout</span>

</pre></div>
</div>
<ul class="simple">
<li><strong>intersections.py</strong> (ipython script to plot a graph where two functions intersect - uses newton.py)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script to plot g1(x) and g2(x) versus x</span>
<span class="sd">and to show where they intersect with black dots</span>

<span class="sd">Example use:</span>
<span class="sd">	&gt;&gt;&gt; run intersections</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">newton</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">guesses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">2.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">])</span>
<span class="n">xarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">yarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">xin</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
	<span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">iters</span><span class="p">)</span> <span class="o">=</span> <span class="n">newton</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">xin</span><span class="p">)</span>
	<span class="n">xarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xout</span>
	<span class="n">yarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mf">0.6</span><span class="o">*</span><span class="n">xout</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">g1</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>

<span class="n">g2</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mf">0.6</span><span class="o">*</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x (-)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y (-)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Two functions and their intersecting points&quot;</span><span class="p">)</span>
<span class="c1">#p1 = plt.plot(x, g1, &#39;b&#39;, label=r&#39;$y(x) = xcos(\pix)$&#39;)</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$y(x) = xcos(\pi x)$&#39;</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$y(x) = 1-(0.6x^2)$&#39;</span><span class="p">)</span>
<span class="n">p3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarray</span><span class="p">,</span> <span class="n">yarray</span><span class="p">,</span> <span class="s1">&#39;ko&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$intersection$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="c1">#plt.legend([p1, p2, p3],[&quot;g1(x) = xcos(pi*x)&quot;, &quot;g2(x) = 1-(0.6x**2)&quot;, &quot;intersection&quot;])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1">#show the plot on the screen</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;intersection.png&#39;</span><span class="p">)</span>   <span class="c1"># save figure as .png file</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>test1.f90, newton.f90, intersections.f90, functions.f90, Makefile</strong> (fortran code for the intersection problem using max iterations for convergence)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $MYHPSC/homework3/test1.f90</span>

<span class="k">program </span><span class="n">test1</span>

    <span class="k">use </span><span class="n">newton</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">solve</span>
    <span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">f_sqrt</span><span class="p">,</span> <span class="n">fprime_sqrt</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fx</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x0vals</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">iters</span><span class="p">,</span> <span class="n">i</span>
	<span class="kt">logical</span> <span class="kd">::</span> <span class="n">debug</span>         <span class="c">! set to .true. or .false.</span>

    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Test routine for computing zero of f&quot;</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>

    <span class="c">! values to test as x0:</span>
    <span class="n">x0vals</span> <span class="o">=</span> <span class="p">(</span><span class="o">/</span><span class="mf">1.</span><span class="n">d0</span><span class="p">,</span> <span class="mf">2.</span><span class="n">d0</span><span class="p">,</span> <span class="mi">10</span><span class="mf">0.</span><span class="n">d0</span> <span class="o">/</span><span class="p">)</span>

    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x0vals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39; &#39;</span>  <span class="c">! blank line</span>
        <span class="k">call </span><span class="n">solve</span><span class="p">(</span><span class="n">f_sqrt</span><span class="p">,</span> <span class="n">fprime_sqrt</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">iters</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>

        <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">iters</span>
<span class="mi">11</span>      <span class="k">format</span><span class="p">(</span><span class="s1">&#39;solver returns x = &#39;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39; after&#39;</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="s1">&#39; iterations&#39;</span><span class="p">)</span>

        <span class="n">fx</span> <span class="o">=</span> <span class="n">f_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">print </span><span class="mi">12</span><span class="p">,</span> <span class="n">fx</span>
<span class="mi">12</span>      <span class="k">format</span><span class="p">(</span><span class="s1">&#39;the value of f(x) is &#39;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">15</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mf">2.</span><span class="n">d0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="n">d</span><span class="o">-</span><span class="mi">14</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            print </span><span class="mi">13</span><span class="p">,</span> <span class="n">x</span>
<span class="mi">13</span>          <span class="k">format</span><span class="p">(</span><span class="s1">&#39;*** Unexpected result: x = &#39;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">endif</span>
        <span class="n">enddo</span>

<span class="k">end program </span><span class="n">test1</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $MYHPSC/homework3/newton.f90</span>

<span class="k">module </span><span class="n">newton</span>

    <span class="c">! module parameters:</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d</span><span class="o">-</span><span class="mi">14</span>

<span class="k">contains</span>

<span class="k">subroutine </span><span class="n">solve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">iters</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>

    <span class="c">! Estimate the zero of f(x) using Newton&#39;s method. </span>
    <span class="c">! Input:</span>
    <span class="c">!   f:  the function to find a root of</span>
    <span class="c">!   fp: function returning the derivative f&#39;</span>
    <span class="c">!   x0: the initial guess</span>
    <span class="c">!   debug: logical, prints iterations if debug=.true.</span>
    <span class="c">! Returns:</span>
    <span class="c">!   the estimate x satisfying f(x)=0 (assumes Newton converged!) </span>
    <span class="c">!   the number of iterations iters</span>
     
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x0</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span><span class="p">,</span> <span class="n">fp</span>
    <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">debug</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iters</span>

    <span class="c">! Declare any local variables:</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fxprime</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span>


    <span class="c">! initial guess</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print </span><span class="mi">11</span><span class="p">,</span> <span class="n">x</span>
 <span class="mi">11</span>     <span class="k">format</span><span class="p">(</span><span class="s1">&#39;Initial guess: x = &#39;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">endif</span>

    <span class="c">! Newton iteration to find a zero of f(x) </span>

    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">maxiter</span>

        <span class="c">! evaluate function and its derivative:</span>
        <span class="n">fx</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">fxprime</span> <span class="o">=</span> <span class="n">fp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            exit</span>  <span class="c">! jump out of do loop</span>
            <span class="n">endif</span>

        <span class="c">! compute Newton increment x:</span>
        <span class="n">deltax</span> <span class="o">=</span> <span class="n">fx</span><span class="o">/</span><span class="n">fxprime</span>

        <span class="c">! update x:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">deltax</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            print </span><span class="mi">12</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">x</span>
 <span class="mi">12</span>         <span class="k">format</span><span class="p">(</span><span class="s1">&#39;After&#39;</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="s1">&#39; iterations, x = &#39;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">endif</span>

        <span class="n">enddo</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">maxiter</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! might not have converged</span>

        <span class="n">fx</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            print</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;*** Warning: has not yet converged&#39;</span>
            <span class="n">endif</span>
        <span class="n">endif</span> 

    <span class="c">! number of iterations taken:</span>
    <span class="n">iters</span> <span class="o">=</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span>


<span class="k">end subroutine </span><span class="n">solve</span>

<span class="k">end module </span><span class="n">newton</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $MYHPSC/homework3/intersections.f90</span>

<span class="k">program </span><span class="n">intersections</span>

    <span class="k">use </span><span class="n">newton</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">solve</span>
    <span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">f_function</span><span class="p">,</span> <span class="n">fprime_function</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fx</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x0vals</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">iters</span><span class="p">,</span> <span class="n">i</span>
	<span class="kt">logical</span> <span class="kd">::</span> <span class="n">debug</span>         <span class="c">! set to .true. or .false.</span>

    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Test routine for computing zero of f&quot;</span>
    <span class="n">debug</span> <span class="o">=</span> <span class="p">.</span><span class="n">true</span><span class="p">.</span>

    <span class="c">! values to test as x0:</span>
    <span class="n">x0vals</span> <span class="o">=</span> <span class="p">(</span><span class="o">/-</span><span class="mf">2.2</span><span class="n">d0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.6</span><span class="n">d0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8</span><span class="n">d0</span><span class="p">,</span> <span class="mf">1.4</span><span class="n">d0</span> <span class="o">/</span><span class="p">)</span>

    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x0vals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39; &#39;</span>  <span class="c">! blank line</span>
        <span class="k">call </span><span class="n">solve</span><span class="p">(</span><span class="n">f_function</span><span class="p">,</span> <span class="n">fprime_function</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">iters</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>

        <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">iters</span>
<span class="mi">11</span>      <span class="k">format</span><span class="p">(</span><span class="s1">&#39;solver returns x = &#39;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">15</span><span class="p">,</span> <span class="s1">&#39; after&#39;</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="s1">&#39; iterations&#39;</span><span class="p">)</span>

        <span class="n">fx</span> <span class="o">=</span> <span class="n">f_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">print </span><span class="mi">12</span><span class="p">,</span> <span class="n">fx</span>
<span class="mi">12</span>      <span class="k">format</span><span class="p">(</span><span class="s1">&#39;the value of f(x) is &#39;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">15</span><span class="p">)</span>

<span class="c">!        if (abs(x-2.d0) &gt; 1d-14) then</span>
<span class="c">!            print 13, x</span>
<span class="c">!13          format(&#39;*** Unexpected result: x = &#39;, es22.15)</span>
<span class="c">!            endif</span>
        <span class="n">enddo</span>

<span class="k">end program </span><span class="n">intersections</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $MYHPSC/homework3/functions.f90</span>

<span class="k">module </span><span class="n">functions</span>
	
	<span class="c">! parameters for module</span>
<span class="c">!	implicit none</span>
<span class="c">!	real(kind=8) :: pi</span>
<span class="c">!	save</span>
	

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>

    <span class="n">f_sqrt</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">4.</span><span class="n">d0</span>

<span class="k">end function </span><span class="n">f_sqrt</span>


<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">fprime_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>
    
    <span class="n">fprime_sqrt</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">end function </span><span class="n">fprime_sqrt</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pi</span> <span class="o">=</span> <span class="mf">3.141592653589793</span>

    <span class="n">f_function</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="mf">1.0</span><span class="n">d0</span><span class="o">-</span><span class="p">(</span><span class="mf">0.6</span><span class="n">d0</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

<span class="k">end function </span><span class="n">f_function</span>

	
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">fprime_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pi</span> <span class="o">=</span> <span class="mf">3.141592653589793</span>

    <span class="n">fprime_function</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">))</span><span class="o">+</span><span class="nb">cos</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mf">1.2</span><span class="n">d0</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>

<span class="k">end function </span><span class="n">fprime_function</span>


<span class="k">end module </span><span class="n">functions</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span># $MYHPSC/homework3/Makefile
# Example usage:
#	$ make test1
#	$ make clean
#	$ make intersections

OBJECTS = functions.o newton.o test1.o
OBJECTS2 = functions.o newton.o intersections.o
MODULES = functions.mod newton.mod

FFLAGS = -g

.PHONY: test1 clean intersections

test1: test1.exe
	./test1.exe

intersections: intersections.exe
	./intersections.exe

test1.exe: $(MODULES) $(OBJECTS)
	gfortran $(FFLAGS) $(OBJECTS) -o test1.exe

intersections.exe: $(MODULES) $(OBJECTS2)
	gfortran $(FFLAGS) $(OBJECTS2) -o intersections.exe

%.o : %.f90
	gfortran $(FFLAGS) -c  $&lt; 

%.mod: %.f90
	gfortran $(FFLAGS) -c $&lt;

clean:
	rm -f *.o *.exe *.mod
</pre></div>
</div>
<ul class="simple">
<li><strong>problem7/newton.f90, problem7/functions.f90, problem7/test_quartic.f90, problem7/Makefile, problem7/intersections.py</strong> (intersection problem using residual error for convergence)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $MYHPSC/homework3/problem7/newton.f90</span>

<span class="k">module </span><span class="n">newton</span>

    <span class="c">! module parameters:</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">maxiter</span> <span class="o">=</span> <span class="mi">40</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tol</span>
	<span class="k">save</span>

<span class="k">contains</span>

<span class="k">subroutine </span><span class="n">solve</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fp</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">iters</span><span class="p">,</span> <span class="n">debug</span><span class="p">)</span>

    <span class="c">! Estimate the zero of f(x) using Newton&#39;s method. </span>
    <span class="c">! Input:</span>
    <span class="c">!   f:  the function to find a root of</span>
    <span class="c">!   fp: function returning the derivative f&#39;</span>
    <span class="c">!   x0: the initial guess</span>
    <span class="c">!   debug: logical, prints iterations if debug=.true.</span>
    <span class="c">! Returns:</span>
    <span class="c">!   the estimate x satisfying f(x)=0 (assumes Newton converged!) </span>
    <span class="c">!   the number of iterations iters</span>
     
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x0</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span><span class="p">,</span> <span class="n">fp</span>
    <span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">debug</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iters</span>

    <span class="c">! Declare any local variables:</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">deltax</span><span class="p">,</span> <span class="n">fx</span><span class="p">,</span> <span class="n">fxprime</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">k</span>


    <span class="c">! initial guess</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print </span><span class="mi">11</span><span class="p">,</span> <span class="n">x</span>
 <span class="mi">11</span>     <span class="k">format</span><span class="p">(</span><span class="s1">&#39;Starting with initial guess: x = &#39;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">endif</span>

    <span class="c">! Newton iteration to find a zero of f(x) </span>

    <span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">maxiter</span>

        <span class="c">! evaluate function and its derivative:</span>
        <span class="n">fx</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">fxprime</span> <span class="o">=</span> <span class="n">fp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fx</span><span class="o">/</span><span class="n">fxprime</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            exit</span>  <span class="c">! jump out of do loop</span>
            <span class="n">endif</span>

        <span class="c">! compute Newton increment x:</span>
        <span class="n">deltax</span> <span class="o">=</span> <span class="n">fx</span><span class="o">/</span><span class="n">fxprime</span>

        <span class="c">! update x:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">deltax</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            print </span><span class="mi">12</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span><span class="n">x</span>
 <span class="mi">12</span>         <span class="k">format</span><span class="p">(</span><span class="s1">&#39;After&#39;</span><span class="p">,</span> <span class="n">i3</span><span class="p">,</span> <span class="s1">&#39; iterations, x = &#39;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">endif</span>

        <span class="n">enddo</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="n">maxiter</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! might not have converged</span>

        <span class="n">fx</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">fx</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tol</span><span class="p">)</span> <span class="k">then</span>
<span class="k">            print</span> <span class="o">*</span><span class="p">,</span> <span class="s1">&#39;*** Warning: has not yet converged&#39;</span>
            <span class="n">endif</span>
        <span class="n">endif</span> 

    <span class="c">! number of iterations taken:</span>
    <span class="n">iters</span> <span class="o">=</span> <span class="n">k</span><span class="o">-</span><span class="mi">1</span>


<span class="k">end subroutine </span><span class="n">solve</span>

<span class="k">end module </span><span class="n">newton</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $MYHPSC/homework3/problem7/functions.f90</span>

<span class="k">module </span><span class="n">functions</span>
	
	<span class="c">! parameters for module</span>
	<span class="k">implicit none</span>
<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">alpha</span>
	<span class="k">save</span>
<span class="k">	</span>

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>

    <span class="n">f_sqrt</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">4.</span><span class="n">d0</span>

<span class="k">end function </span><span class="n">f_sqrt</span>


<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">fprime_sqrt</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>
    
    <span class="n">fprime_sqrt</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span> <span class="o">*</span> <span class="n">x</span>

<span class="k">end function </span><span class="n">fprime_sqrt</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pi</span> <span class="o">=</span> <span class="mf">3.141592653589793</span>

    <span class="n">f_function</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="nb">cos</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="mf">1.0</span><span class="n">d0</span><span class="o">-</span><span class="p">(</span><span class="mf">0.6</span><span class="n">d0</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

<span class="k">end function </span><span class="n">f_function</span>

	
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">fprime_function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">pi</span> <span class="o">=</span> <span class="mf">3.141592653589793</span>

    <span class="n">fprime_function</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">pi</span><span class="p">)</span><span class="o">*</span><span class="nb">sin</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">))</span><span class="o">+</span><span class="nb">cos</span><span class="p">(</span><span class="n">pi</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mf">1.2</span><span class="n">d0</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>

<span class="k">end function </span><span class="n">fprime_function</span>


<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f_quartic</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>

    <span class="n">f_quartic</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">alpha</span>

<span class="k">end function </span><span class="n">f_quartic</span>

	
<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">fprime_quartic</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>

    <span class="n">fprime_quartic</span> <span class="o">=</span> <span class="mi">4</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">3</span>

<span class="k">end function </span><span class="n">fprime_quartic</span>

<span class="k">end module </span><span class="n">functions</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span>! $MYHPSC/homework3/problem7/test_quartic.f90

program test_quartic

    use newton, only: solve, tol
    use functions, only: f_quartic, fprime_quartic, alpha

    implicit none
    real(kind=8) :: x, x0, fx, dfx, xstar
    real(kind=8) :: tolvals(3), alphavals(3)
    integer :: iters, i, j
	logical :: debug         ! set to .true. or .false.

    ! values to test as x0:
    x0 = 4.0d0

    print 10, x0
10	format(&quot;Starting with initial guess x = &quot;, es22.15)

    debug = .false.

	! values to use as tolerance:
	tolvals = (/1.0d-5, 1.0d-10, 1.0d-14/)

	! values to use as alpha:
	alphavals = (/1.0d-4, 1.0d-8, 1.0d-12/)

	print *, &#39; &#39;  ! blank line
	print *, &#39;   alpha        tol        iters          x              f(x)/f`(x)   x-xstar&#39;

    do i=1,3
		do j =1,3
			tol = tolvals(j)
		    alpha = alphavals(i)
			xstar = 1+(alpha**0.25)
		    call solve(f_quartic, fprime_quartic, x0, x, iters, debug)
			fx = f_quartic(x)
			dfx = fprime_quartic(x)
		    print 11, alpha, tol, iters, x, fx/dfx, x-xstar
11 			format(2es13.3, i4, es24.15, 2es13.3)

        enddo
		print *, &#39; &#39;  ! blank line
	enddo

end program test_quartic
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span># $MYHPSC/homework3/problem7/Makefile
# Example usage:
#	$ make clean
#	$ make test_quartic

OBJECTS = functions.o newton.o test_quartic.o
MODULES = functions.mod newton.mod

FFLAGS = -g

.PHONY: clean test_quartic

test_quartic: test_quartic.exe
	./test_quartic.exe

test_quartic.exe: $(MODULES) $(OBJECTS)
	gfortran $(FFLAGS) $(OBJECTS) -o test_quartic.exe

%.o : %.f90
	gfortran $(FFLAGS) -c  $&lt; 

%.mod: %.f90
	gfortran $(FFLAGS) -c $&lt;

clean:
	rm -f *.o *.exe *.mod
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Script to plot g1(x) and g2(x) versus x</span>
<span class="sd">and to show where they intersect with black dots</span>

<span class="sd">Example use:</span>
<span class="sd">	&gt;&gt;&gt; run intersections</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">newton</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">guesses</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">])</span>
<span class="n">xarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">yarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">for</span> <span class="n">xin</span> <span class="ow">in</span> <span class="n">guesses</span><span class="p">:</span>
	<span class="p">(</span><span class="n">xout</span><span class="p">,</span> <span class="n">iters</span><span class="p">)</span> <span class="o">=</span> <span class="n">newton</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">xin</span><span class="p">)</span>
	<span class="n">xarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">xout</span>
	<span class="n">yarray</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">xout</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="mf">4.0</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0e-4</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">g1</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="mf">1.0</span><span class="p">)</span><span class="o">**</span><span class="mf">4.0</span><span class="p">)</span><span class="o">-</span><span class="mf">1.0e-4</span>
<span class="n">g2</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">x</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="n">e</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;x (-)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;y (-)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Two functions and their intersecting points&quot;</span><span class="p">)</span>
<span class="c1">#p1 = plt.plot(x, g1, &#39;b&#39;, label=r&#39;$y(x) = xcos(\pix)$&#39;)</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">g1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$y(x) = (x - 1)^4 - 1\times 10^{-4}$&#39;</span><span class="p">)</span>
<span class="n">p2</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">g2</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$y(x) = 0$&#39;</span><span class="p">)</span>
<span class="n">p3</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xarray</span><span class="p">,</span> <span class="n">yarray</span><span class="p">,</span> <span class="s1">&#39;ko&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">r&#39;$intersection$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span> <span class="c1">#show the plot on the screen</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;intersection.png&#39;</span><span class="p">)</span>   <span class="c1"># save figure as .png file</span>
</pre></div>
</div>
</div>
<div class="section" id="workspace-4-openmp">
<h2>3.4. Workspace 4: OpenMP<a class="headerlink" href="#workspace-4-openmp" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>quadrature.f90</strong> (module for integrating a function)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">quadrature</span>

<span class="c">! Performs integration using quadrature integration </span>
<span class="c">! and creates a table of the error between this and</span>
<span class="c">! the known solution. </span>

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

	<span class="k">implicit none</span>
<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">h</span>
	<span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xpoints</span><span class="p">,</span> <span class="n">ypoints</span>

	<span class="n">h</span><span class="o">=</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="c">!	print *, &quot; &quot;  ! blank line</span>
<span class="c">!	print 12, h</span>

<span class="mi">12</span>  <span class="k">format</span><span class="p">(</span><span class="s2">&quot;h: &quot;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">)</span>
	<span class="n">xpoints</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="p">((</span><span class="n">i</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="n">a</span><span class="p">),</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="p">)</span>
	<span class="n">ypoints</span><span class="o">=</span><span class="p">(</span><span class="o">/</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">xpoints</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span><span class="p">)</span><span class="o">/</span><span class="p">)</span>
	
	<span class="n">trapezoid</span> <span class="o">=</span> <span class="n">h</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">ypoints</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="p">(</span><span class="n">ypoints</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ypoints</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
<span class="c">!	do i=1,5	</span>
<span class="c">!		print 13, xpoints(i), ypoints(i)</span>
<span class="c">!13		format(&quot;x,y = &quot; es22.14, es22.14)</span>
<span class="c">!	enddo</span>

<span class="k">end function </span><span class="n">trapezoid</span>

<span class="k">subroutine </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">nvals</span><span class="p">,</span><span class="n">int_true</span><span class="p">)</span>
	<span class="k">implicit none</span>
<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">int_true</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nvals</span>
	<span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">int_trap</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ratio</span>

	<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;      n  trapezoid               error        ratio&quot;</span>
	<span class="n">last_error</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
	<span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">nvals</span><span class="p">)</span>
		<span class="n">int_trap</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nvals</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">int_trap</span> <span class="o">-</span> <span class="n">int_true</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">last_error</span> <span class="o">/</span> <span class="n">error</span>
		<span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>
		<span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">nvals</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">int_trap</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ratio</span>
<span class="mi">11</span>		<span class="k">format</span><span class="p">(</span><span class="n">i8</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
	<span class="n">enddo</span>

<span class="k">end subroutine </span><span class="n">error_table</span>

<span class="k">end module </span><span class="n">quadrature</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>test1.f90</strong> (cubic function - uses quadrature module)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $MYHPSC/homework4/test1.f90</span>
<span class="c">! The purpose is to print a table for the effect of the number</span>
<span class="c">! of integration points on the accuracy of the integration</span>

<span class="c">! Example use: </span>
<span class="c">! $ gfortran quadrature.f90 test1.f90</span>
<span class="c">! $ ./a.out</span>

<span class="k">program </span><span class="n">test1</span>

	<span class="c">! To provide input values to print error_table to the screen</span>

    <span class="k">use </span><span class="n">quadrature</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">trapezoid</span><span class="p">,</span> <span class="n">error_table</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">int_true</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nvals</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span>

    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="n">d0</span>

<span class="c">!    print 10, int_true</span>
<span class="c">! 10 format(&quot;true integral: &quot;, es22.14)</span>
<span class="c">!    print *, &quot; &quot;  ! blank line</span>

<span class="c">!	n=5</span>

<span class="c">!	print 11, trapezoid(f,a,b,n)</span>
<span class="c">!11  format(&quot;calculated integral: &quot;, es22.14)</span>
<span class="c">!   values of n to test:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">7</span>
        <span class="n">nvals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">enddo</span>

    <span class="k">call </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nvals</span><span class="p">,</span> <span class="n">int_true</span><span class="p">)</span>

<span class="k">contains</span>

	<span class="c">! To return the the value of the function to integrate, f</span>

    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">implicit none</span>
<span class="k">        </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span> 
        
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d0</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span>
    <span class="k">end function </span><span class="n">f</span>

<span class="k">end program </span><span class="n">test1</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>test2.f90</strong> (sinusoidal function - uses quadrature module)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $MYHPSC/homework4/test2.f90</span>
<span class="c">! The purpose is to print a table for the effect of the number</span>
<span class="c">! of integration points on the accuracy of the integration</span>

<span class="c">! Example use: </span>
<span class="c">! $ gfortran quadrature.f90 test2.f90</span>
<span class="c">! $ ./a.out</span>

<span class="k">program </span><span class="n">test2</span>

	<span class="c">! To provide input values to print error_table to the screen</span>

    <span class="k">use </span><span class="n">quadrature</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">trapezoid</span><span class="p">,</span> <span class="n">error_table</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">int_true</span><span class="p">,</span><span class="n">k</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nvals</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span>

    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
	<span class="n">k</span> <span class="o">=</span> <span class="mi">100</span><span class="mf">0.</span><span class="n">d0</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="n">d0</span> <span class="o">-</span> <span class="p">&amp;</span>
			   <span class="p">((</span><span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">a</span><span class="p">))</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span>

<span class="c">!   values of n to test:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span>
        <span class="n">nvals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">enddo</span>

    <span class="k">call </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nvals</span><span class="p">,</span> <span class="n">int_true</span><span class="p">)</span>

<span class="k">contains</span>

	<span class="c">! To return the the value of the function to integrate, f</span>

    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">implicit none</span>
<span class="k">        </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span> 
        
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d0</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">sin</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
    <span class="k">end function </span><span class="n">f</span>

<span class="k">end program </span><span class="n">test2</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>quadrature_omp.f90, test2_omp.f90</strong> (same as above but using OpenMP)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">quadrature_omp</span>

<span class="c">! Performs integration using quadrature integration </span>
<span class="c">! and creates a table of the error between this and</span>
<span class="c">! the known solution. </span>

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>

	<span class="k">use </span><span class="n">omp_lib</span>
	<span class="k">implicit none</span>
<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">h</span>
	<span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xpoints</span><span class="p">,</span> <span class="n">ypoints</span>


	<span class="n">h</span><span class="o">=</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
   
    <span class="c">!$omp parallel private(i)</span>

	<span class="c">!$omp do reduction(+ : trapezoid)</span>

	<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n</span>
		<span class="n">xpoints</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">h</span><span class="o">+</span><span class="n">a</span>
		<span class="n">ypoints</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">=</span><span class="n">f</span><span class="p">(</span><span class="n">xpoints</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
	<span class="n">enddo</span>

	<span class="n">trapezoid</span> <span class="o">=</span> <span class="n">h</span><span class="o">*</span><span class="nb">sum</span><span class="p">(</span><span class="n">ypoints</span><span class="p">)</span><span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">h</span><span class="o">*</span><span class="p">(</span><span class="n">ypoints</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">ypoints</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>

	<span class="c">!$omp end parallel</span>

<span class="k">end function </span><span class="n">trapezoid</span>

<span class="k">subroutine </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">nvals</span><span class="p">,</span><span class="n">int_true</span><span class="p">)</span>
	<span class="k">implicit none</span>
<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">int_true</span>
	<span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nvals</span>
	<span class="kt">integer</span> <span class="kd">::</span> <span class="n">n</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">int_trap</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ratio</span>

	<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;      n  trapezoid               error        ratio&quot;</span>
	<span class="n">last_error</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
	<span class="k">do </span><span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">nvals</span><span class="p">)</span>
		<span class="n">int_trap</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nvals</span><span class="p">(</span><span class="n">n</span><span class="p">))</span>
		<span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">int_trap</span> <span class="o">-</span> <span class="n">int_true</span><span class="p">)</span>
		<span class="n">ratio</span> <span class="o">=</span> <span class="n">last_error</span> <span class="o">/</span> <span class="n">error</span>
		<span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>
		<span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">nvals</span><span class="p">(</span><span class="n">n</span><span class="p">),</span> <span class="n">int_trap</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ratio</span>
<span class="mi">11</span>		<span class="k">format</span><span class="p">(</span><span class="n">i8</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
	<span class="n">enddo</span>

<span class="k">end subroutine </span><span class="n">error_table</span>

<span class="k">end module </span><span class="n">quadrature_omp</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $MYHPSC/homework4/test2_omp.f90</span>
<span class="c">! The purpose is to print a table for the effect of the number</span>
<span class="c">! of integration points on the accuracy of the integration</span>

<span class="c">! Example use: </span>
<span class="c">! $ gfortran -fopenmp quadrature_omp.f90 test2_omp.f90</span>
<span class="c">! $ ./a.out</span>

<span class="k">program </span><span class="n">test2_omp</span>

	<span class="c">! To provide input values to print error_table to the screen</span>
	<span class="k">use </span><span class="n">omp_lib</span>
    <span class="k">use </span><span class="n">quadrature_omp</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">trapezoid</span><span class="p">,</span> <span class="n">error_table</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">int_true</span><span class="p">,</span><span class="n">k</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nvals</span><span class="p">(</span><span class="mi">20</span><span class="p">),</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">nthreads</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">elapsed_time</span>
    <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tclock1</span><span class="p">,</span> <span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
	<span class="n">k</span> <span class="o">=</span> <span class="mi">100</span><span class="mf">0.</span><span class="n">d0</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="n">d0</span> <span class="o">-</span> <span class="p">&amp;</span>
			   <span class="p">((</span><span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">a</span><span class="p">))</span> <span class="o">/</span> <span class="n">k</span><span class="p">)</span>

	<span class="c">! Specify number of threads to use:</span>
    <span class="n">nthreads</span> <span class="o">=</span> <span class="mi">1</span>       <span class="c">! need this value in serial mode</span>
	<span class="c">!$ nthreads = 2    </span>
	<span class="c">!$ call omp_set_num_threads(nthreads)</span>
	<span class="c">!$ print &quot;(&#39;Using OpenMP with &#39;,i3,&#39; threads&#39;)&quot;, nthreads</span>

	<span class="c">! Specify number of threads to use:</span>
	<span class="c">!$ call omp_set_num_threads(2)</span>

<span class="c">!   values of n to test:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">20</span>
        <span class="n">nvals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">enddo</span>

	<span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock1</span><span class="p">)</span>  <span class="c">! start wall timer</span>
    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>   <span class="c">! start cpu timer</span>

    <span class="k">call </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nvals</span><span class="p">,</span> <span class="n">int_true</span><span class="p">)</span>

	<span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>   <span class="c">! end cpu timer</span>

    <span class="k">print </span><span class="mi">10</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span>
<span class="mi">10</span>  <span class="k">format</span><span class="p">(</span><span class="s2">&quot;CPU time = &quot;</span><span class="p">,</span><span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>
    
    <span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span><span class="p">)</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tclock2</span> <span class="o">-</span> <span class="n">tclock1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">clock_rate</span><span class="p">)</span>
    <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">elapsed_time</span>
<span class="mi">11</span>  <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Elapsed time = &quot;</span><span class="p">,</span><span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>

<span class="k">contains</span>

	<span class="c">! To return the the value of the function to integrate, f</span>

    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">implicit none</span>
<span class="k">        </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span> 
        
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d0</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">sin</span><span class="p">(</span><span class="mi">1000</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
    <span class="k">end function </span><span class="n">f</span>

<span class="k">end program </span><span class="n">test2_omp</span>
</pre></div>
</div>
</div>
<div class="section" id="workspace-5-load-balancing">
<h2>3.5. Workspace 5: Load Balancing<a class="headerlink" href="#workspace-5-load-balancing" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>Makefile</strong> (makefile for the 1D solution)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>
OBJECTS = functions.o quadrature.o test.o
OBJECTS2 = functions.o quadrature2.o test2.o
OBJECTS3 = functions.o quadrature3.o test3.o

FFLAGS = -fopenmp

.PHONY: test test2 test3 clean 

test: test.exe
	./test.exe

test2: test2.exe
	./test2.exe

test3: test3.exe
	./test3.exe

test.exe: $(OBJECTS)
	gfortran $(FFLAGS) $(OBJECTS) -o test.exe

test2.exe: $(OBJECTS2)
	gfortran $(FFLAGS) $(OBJECTS2) -o test2.exe

test3.exe: $(OBJECTS3)
	gfortran $(FFLAGS) $(OBJECTS3) -o test3.exe

%.o : %.f90
	gfortran $(FFLAGS) -c  $&lt; 

clean:
	rm -f *.o *.exe *.mod

</pre></div>
</div>
<ul class="simple">
<li><strong>functions.f90</strong> (sinusoial function module)</li>
</ul>
<p>functions.f90</p>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">functions</span>

    <span class="k">use </span><span class="n">omp_lib</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">fevals</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">k</span>
    <span class="k">save</span>

<span class="k">contains</span>

<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">implicit none</span>
<span class="k">        </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span> 
        <span class="kt">integer </span><span class="n">thread_num</span>

        <span class="c">! keep track of number of function evaluations by</span>
        <span class="c">! each thread:</span>
        <span class="n">thread_num</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c">! serial mode</span>
        <span class="c">!$ thread_num = omp_get_thread_num()</span>
        <span class="n">fevals</span><span class="p">(</span><span class="n">thread_num</span><span class="p">)</span> <span class="o">=</span> <span class="n">fevals</span><span class="p">(</span><span class="n">thread_num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d0</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">sin</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        
    <span class="k">end function </span><span class="n">f</span>

<span class="k">end module </span><span class="n">functions</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>quadrature.f90, test.f90</strong> (trapezoid rule module + test - serial)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">quadrature</span>

    <span class="k">use </span><span class="n">omp_lib</span>

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c">! Estimate the integral of f(x) from a to b using the</span>
    <span class="c">! Trapezoid Rule with n points.</span>

    <span class="c">! Input:</span>
    <span class="c">!   f:  the function to integrate</span>
    <span class="c">!   a:  left endpoint</span>
    <span class="c">!   b:  right endpoint</span>
    <span class="c">!   n:  number of points to use</span>
    <span class="c">! Returns:</span>
    <span class="c">!   the estimate of the integral</span>
     
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">h</span><span class="p">,</span> <span class="n">trap_sum</span><span class="p">,</span> <span class="n">xj</span>

    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">trap_sum</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">d0</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>  <span class="c">! endpoint contributions</span>
    
    <span class="c">!$omp parallel do private(xj) reduction(+ : trap_sum) </span>
    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">xj</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">h</span>
        <span class="n">trap_sum</span> <span class="o">=</span> <span class="n">trap_sum</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">xj</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="n">trapezoid</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">trap_sum</span>

<span class="k">end function </span><span class="n">trapezoid</span>


<span class="k">subroutine </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">nvals</span><span class="p">,</span><span class="n">int_true</span><span class="p">,</span><span class="n">method</span><span class="p">)</span>

    <span class="c">! Compute and print out a table of errors when the quadrature</span>
    <span class="c">! rule specified by the input function method is applied for</span>
    <span class="c">! each value of n in the array nvals.</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">int_true</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span><span class="p">,</span> <span class="n">method</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nvals</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">int_approx</span>

    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;      n         approximation        error       ratio&quot;</span>
    <span class="n">last_error</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>   
    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">nvals</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">nvals</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">int_approx</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">int_approx</span> <span class="o">-</span> <span class="n">int_true</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">last_error</span> <span class="o">/</span> <span class="n">error</span>
        <span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>  <span class="c">! for next n</span>

        <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">int_approx</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ratio</span>
 <span class="mi">11</span>     <span class="k">format</span><span class="p">(</span><span class="n">i8</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">enddo</span>

<span class="k">end subroutine </span><span class="n">error_table</span>


<span class="k">end module </span><span class="n">quadrature</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test</span>

    <span class="k">use </span><span class="n">omp_lib</span>

    <span class="k">use </span><span class="n">quadrature</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">trapezoid</span><span class="p">,</span> <span class="n">error_table</span>
    <span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="n">fevals</span><span class="p">,</span> <span class="n">k</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">int_true</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nvals</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">nthreads</span>

    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">elapsed_time</span>
    <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tclock1</span><span class="p">,</span> <span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span>

    <span class="n">nthreads</span> <span class="o">=</span> <span class="mi">1</span>      <span class="c">! for serial mode</span>
    <span class="c">!$ nthreads = 4   ! for openmp</span>
    <span class="c">!$ call omp_set_num_threads(nthreads)</span>
    <span class="k">print </span><span class="mi">100</span><span class="p">,</span> <span class="n">nthreads</span>
<span class="mi">100</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Using &quot;</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="s2">&quot; threads&quot;</span><span class="p">)</span>

    <span class="n">fevals</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d3</span>   <span class="c">! functions module variable for function f2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="n">d0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="n">d0</span><span class="o">/</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>

    <span class="k">print </span><span class="mi">10</span><span class="p">,</span> <span class="n">int_true</span>
 <span class="mi">10</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;true integral: &quot;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>  <span class="c">! blank line</span>

    <span class="c">! values of n to test:   (larger values than before)</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span>
        <span class="n">nvals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="c">! time the call to error_table:</span>
    <span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock1</span><span class="p">)</span>  
    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
    <span class="k">call </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nvals</span><span class="p">,</span> <span class="n">int_true</span><span class="p">,</span> <span class="n">trapezoid</span><span class="p">)</span>
    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>   
    <span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span><span class="p">)</span>

    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tclock2</span> <span class="o">-</span> <span class="n">tclock1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">clock_rate</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>
    <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">elapsed_time</span>
 <span class="mi">11</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Elapsed time = &quot;</span><span class="p">,</span><span class="n">f12</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>

    <span class="k">print </span><span class="mi">12</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span>
 <span class="mi">12</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;CPU time = &quot;</span><span class="p">,</span><span class="n">f12</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>

    
    <span class="c">! print the number of function evaluations by each thread:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nthreads</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">print </span><span class="mi">101</span><span class="p">,</span>  <span class="n">i</span><span class="p">,</span> <span class="n">fevals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="mi">101</span>     <span class="k">format</span><span class="p">(</span><span class="s2">&quot;fevals by thread &quot;</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="s2">&quot;: &quot;</span><span class="p">,</span><span class="n">i13</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="k">print </span><span class="mi">102</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fevals</span><span class="p">)</span>
<span class="mi">102</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Total number of fevals: &quot;</span><span class="p">,</span><span class="n">i10</span><span class="p">)</span>

<span class="k">end program </span><span class="n">test</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>quadrature2.f90, test2.f90</strong> (simpson&#8217;s rule module + test - serial)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">quadrature2</span>

    <span class="k">use </span><span class="n">omp_lib</span>

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">simpson</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c">! Estimate the integral of f(x) from a to b using the</span>
    <span class="c">! Simpson Rule with n points.</span>

    <span class="c">! Input:</span>
    <span class="c">!   f:  the function to integrate</span>
    <span class="c">!   a:  left endpoint</span>
    <span class="c">!   b:  right endpoint</span>
    <span class="c">!   n:  number of points to use</span>
    <span class="c">! Returns:</span>
    <span class="c">!   the estimate of the integral</span>
     
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">h</span><span class="p">,</span> <span class="n">simp_sum</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="n">xj2</span>

    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">simp_sum</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.</span><span class="n">d0</span><span class="o">/</span><span class="mf">6.</span><span class="n">d0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>  <span class="c">! endpoint contributions</span>
    <span class="n">simp_sum</span> <span class="o">=</span> <span class="n">simp_sum</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span><span class="n">d0</span><span class="o">/</span><span class="mf">3.</span><span class="n">d0</span><span class="p">)</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mf">0.5</span><span class="n">d0</span><span class="o">*</span><span class="n">h</span><span class="p">)</span> <span class="c">!for the half before the loop</span>
    <span class="c">!$omp parallel do private(xj,xj2) reduction(+ : simp_sum) </span>
    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">xj</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mf">1.</span><span class="n">d0</span><span class="p">)</span><span class="o">*</span><span class="n">h</span>
		<span class="n">xj2</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mf">0.5</span><span class="n">d0</span><span class="p">)</span><span class="o">*</span><span class="n">h</span>
        <span class="n">simp_sum</span> <span class="o">=</span> <span class="n">simp_sum</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1.</span><span class="n">d0</span><span class="o">/</span><span class="mf">3.</span><span class="n">d0</span><span class="p">)</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">xj</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mf">2.</span><span class="n">d0</span><span class="o">/</span><span class="mf">3.</span><span class="n">d0</span><span class="p">)</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">xj2</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="n">simpson</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">simp_sum</span>

<span class="k">end function </span><span class="n">simpson</span>


<span class="k">subroutine </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">nvals</span><span class="p">,</span><span class="n">int_true</span><span class="p">,</span><span class="n">method</span><span class="p">)</span>

    <span class="c">! Compute and print out a table of errors when the quadrature</span>
    <span class="c">! rule specified by the input function method is applied for</span>
    <span class="c">! each value of n in the array nvals.</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">int_true</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span><span class="p">,</span> <span class="n">method</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nvals</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">int_approx</span>

    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;      n         approximation        error       ratio&quot;</span>
    <span class="n">last_error</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>   
    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">nvals</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">nvals</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">int_approx</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">int_approx</span> <span class="o">-</span> <span class="n">int_true</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">last_error</span> <span class="o">/</span> <span class="n">error</span>
        <span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>  <span class="c">! for next n</span>

        <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">int_approx</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ratio</span>
 <span class="mi">11</span>     <span class="k">format</span><span class="p">(</span><span class="n">i8</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">enddo</span>

<span class="k">end subroutine </span><span class="n">error_table</span>


<span class="k">end module </span><span class="n">quadrature2</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test2</span>

    <span class="k">use </span><span class="n">omp_lib</span>

    <span class="k">use </span><span class="n">quadrature2</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">simpson</span><span class="p">,</span> <span class="n">error_table</span>
    <span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="n">fevals</span><span class="p">,</span> <span class="n">k</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">int_true</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nvals</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">nthreads</span>

    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">elapsed_time</span>
    <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tclock1</span><span class="p">,</span> <span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span>

    <span class="n">nthreads</span> <span class="o">=</span> <span class="mi">1</span>      <span class="c">! for serial mode</span>
    <span class="c">!$ nthreads = 4   ! for openmp</span>
    <span class="c">!$ call omp_set_num_threads(nthreads)</span>
    <span class="k">print </span><span class="mi">100</span><span class="p">,</span> <span class="n">nthreads</span>
<span class="mi">100</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Using &quot;</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="s2">&quot; threads&quot;</span><span class="p">)</span>

    <span class="n">fevals</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d3</span>   <span class="c">! functions module variable for function f2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="n">d0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="n">d0</span><span class="o">/</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>

    <span class="k">print </span><span class="mi">10</span><span class="p">,</span> <span class="n">int_true</span>
 <span class="mi">10</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;true integral: &quot;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>  <span class="c">! blank line</span>

    <span class="c">! values of n to test:   (larger values than before)</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span>
        <span class="n">nvals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="c">! time the call to error_table:</span>
    <span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock1</span><span class="p">)</span>  
    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
    <span class="k">call </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nvals</span><span class="p">,</span> <span class="n">int_true</span><span class="p">,</span> <span class="n">simpson</span><span class="p">)</span>
    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>   
    <span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span><span class="p">)</span>

    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tclock2</span> <span class="o">-</span> <span class="n">tclock1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">clock_rate</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>
    <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">elapsed_time</span>
 <span class="mi">11</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Elapsed time = &quot;</span><span class="p">,</span><span class="n">f12</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>

    <span class="k">print </span><span class="mi">12</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span>
 <span class="mi">12</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;CPU time = &quot;</span><span class="p">,</span><span class="n">f12</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>

    
    <span class="c">! print the number of function evaluations by each thread:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nthreads</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">print </span><span class="mi">101</span><span class="p">,</span>  <span class="n">i</span><span class="p">,</span> <span class="n">fevals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="mi">101</span>     <span class="k">format</span><span class="p">(</span><span class="s2">&quot;fevals by thread &quot;</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="s2">&quot;: &quot;</span><span class="p">,</span><span class="n">i13</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="k">print </span><span class="mi">102</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fevals</span><span class="p">)</span>
<span class="mi">102</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Total number of fevals: &quot;</span><span class="p">,</span><span class="n">i10</span><span class="p">)</span>

<span class="k">end program </span><span class="n">test2</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>quadrature3.f90, test3.f90</strong> (trapezoid rule module + test - OpenMP)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">quadrature3</span>

    <span class="k">use </span><span class="n">omp_lib</span>

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c">! Estimate the integral of f(x) from a to b using the</span>
    <span class="c">! Trapezoid Rule with n points.</span>

    <span class="c">! Input:</span>
    <span class="c">!   f:  the function to integrate</span>
    <span class="c">!   a:  left endpoint</span>
    <span class="c">!   b:  right endpoint</span>
    <span class="c">!   n:  number of points to use</span>
    <span class="c">! Returns:</span>
    <span class="c">!   the estimate of the integral</span>
     
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">h</span><span class="p">,</span> <span class="n">trap_sum</span><span class="p">,</span> <span class="n">xj</span>

    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">trap_sum</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">d0</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>  <span class="c">! endpoint contributions</span>
    
    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">xj</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">h</span>
        <span class="n">trap_sum</span> <span class="o">=</span> <span class="n">trap_sum</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">xj</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="n">trapezoid</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">trap_sum</span>

<span class="k">end function </span><span class="n">trapezoid</span>


<span class="k">subroutine </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">nvals</span><span class="p">,</span><span class="n">int_true</span><span class="p">,</span><span class="n">method</span><span class="p">)</span>

    <span class="c">! Compute and print out a table of errors when the quadrature</span>
    <span class="c">! rule specified by the input function method is applied for</span>
    <span class="c">! each value of n in the array nvals.</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span> <span class="n">int_true</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span><span class="p">,</span> <span class="n">method</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nvals</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">int_approx</span>
	<span class="kt">integer </span><span class="n">thread_num</span>

    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;      n         approximation        error       ratio     thread no.&quot;</span>
    <span class="n">last_error</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>   
	<span class="c">!$omp parallel do firstprivate(last_error) private(n, int_approx, error, ratio) &amp; </span>
    <span class="c">!$omp schedule(dynamic)</span>
	<span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="n">size</span><span class="p">(</span><span class="n">nvals</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">nvals</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">int_approx</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">int_approx</span> <span class="o">-</span> <span class="n">int_true</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">last_error</span> <span class="o">/</span> <span class="n">error</span>
        <span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>  <span class="c">! for next n -- last_error is firstprivate variable - </span>
<span class="c">! each thead must start with last_error as zero - so ratio will be wrong.</span>
	 	<span class="n">thread_num</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c">! serial mode</span>
        <span class="c">!$ thread_num = omp_get_thread_num()</span>
        <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">int_approx</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">thread_num</span>
 <span class="mi">11</span>     <span class="k">format</span><span class="p">(</span><span class="n">i8</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">i8</span><span class="p">)</span>
        <span class="n">enddo</span>

<span class="k">end subroutine </span><span class="n">error_table</span>


<span class="k">end module </span><span class="n">quadrature3</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test3</span>

    <span class="k">use </span><span class="n">omp_lib</span>

    <span class="k">use </span><span class="n">quadrature3</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">trapezoid</span><span class="p">,</span> <span class="n">error_table</span>
    <span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="n">fevals</span><span class="p">,</span> <span class="n">k</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">int_true</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nvals</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">nthreads</span>

    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">elapsed_time</span>
    <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tclock1</span><span class="p">,</span> <span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span>

    <span class="n">nthreads</span> <span class="o">=</span> <span class="mi">1</span>      <span class="c">! for serial mode</span>
    <span class="c">!$ nthreads = 4  ! for openmp</span>
    <span class="c">!$ call omp_set_num_threads(nthreads)</span>
    <span class="k">print </span><span class="mi">100</span><span class="p">,</span> <span class="n">nthreads</span>
<span class="mi">100</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Using &quot;</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="s2">&quot; threads&quot;</span><span class="p">)</span>

    <span class="n">fevals</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d3</span>   <span class="c">! functions module variable for function f2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="n">d0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="n">d0</span><span class="o">/</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>

    <span class="k">print </span><span class="mi">10</span><span class="p">,</span> <span class="n">int_true</span>
 <span class="mi">10</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;true integral: &quot;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>  <span class="c">! blank line</span>

    <span class="c">! values of n to test:   (larger values than before)</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">12</span>
        <span class="n">nvals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">50</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="c">! time the call to error_table:</span>
    <span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock1</span><span class="p">)</span>  
    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
    <span class="k">call </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">nvals</span><span class="p">,</span> <span class="n">int_true</span><span class="p">,</span> <span class="n">trapezoid</span><span class="p">)</span>
    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>   
    <span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span><span class="p">)</span>

    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tclock2</span> <span class="o">-</span> <span class="n">tclock1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">clock_rate</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>
    <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">elapsed_time</span>
 <span class="mi">11</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Elapsed time = &quot;</span><span class="p">,</span><span class="n">f12</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>

    <span class="k">print </span><span class="mi">12</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span>
 <span class="mi">12</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;CPU time = &quot;</span><span class="p">,</span><span class="n">f12</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>

    
    <span class="c">! print the number of function evaluations by each thread:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nthreads</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">print </span><span class="mi">101</span><span class="p">,</span>  <span class="n">i</span><span class="p">,</span> <span class="n">fevals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="mi">101</span>     <span class="k">format</span><span class="p">(</span><span class="s2">&quot;fevals by thread &quot;</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="s2">&quot;: &quot;</span><span class="p">,</span><span class="n">i13</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="k">print </span><span class="mi">102</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fevals</span><span class="p">)</span>
<span class="mi">102</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Total number of fevals: &quot;</span><span class="p">,</span><span class="n">i10</span><span class="p">)</span>

<span class="k">end program </span><span class="n">test3</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>quad2d/functions.f90, quad2d/quadrature.f90, quad2d/test.f90, quad2d/Makefile</strong> (integrate a sinusoid with trapezoid rule in 2D with Open MP and load balancing)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">functions</span>

    <span class="k">use </span><span class="n">omp_lib</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">fevals</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">),</span> <span class="n">gevals</span><span class="p">(</span><span class="mi">0</span><span class="p">:</span><span class="mi">7</span><span class="p">)</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">k</span>
    <span class="k">save</span>

<span class="k">contains</span>

<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">implicit none</span>
<span class="k">		</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">c</span><span class="p">,</span><span class="n">d</span>
        <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">g</span>

        <span class="kt">integer </span><span class="n">thread_num</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">j</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">h</span><span class="p">,</span> <span class="n">trap_sum</span><span class="p">,</span> <span class="n">y</span>

        <span class="c">! keep track of number of function evaluations by </span>
        <span class="c">! each thread: </span>
        <span class="n">thread_num</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c">! serial mode</span>
        <span class="c">!$ thread_num = omp_get_thread_num()</span>
        <span class="n">fevals</span><span class="p">(</span><span class="n">thread_num</span><span class="p">)</span> <span class="o">=</span> <span class="n">fevals</span><span class="p">(</span><span class="n">thread_num</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
		<span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">d</span><span class="o">-</span><span class="n">c</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    	<span class="n">trap_sum</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">d0</span><span class="o">*</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">c</span><span class="p">)</span> <span class="o">+</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">d</span><span class="p">))</span>  <span class="c">! endpoint contributions</span>
    
<span class="c">!    	!$omp parallel do private(y) reduction(+ : trap_sum) </span>
    	<span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span>
       		<span class="n">y</span> <span class="o">=</span> <span class="n">c</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">h</span>
        	<span class="n">trap_sum</span> <span class="o">=</span> <span class="n">trap_sum</span> <span class="o">+</span> <span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        	<span class="n">enddo</span>

    	<span class="n">f</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">trap_sum</span>

    <span class="k">end function </span><span class="n">f</span>

	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>
		<span class="kt">integer </span><span class="n">thread_num_g</span>

		<span class="n">thread_num_g</span> <span class="o">=</span> <span class="mi">0</span>

		<span class="c">!$ thread_num_g = omp_get_thread_num()</span>
		<span class="n">gevals</span><span class="p">(</span><span class="n">thread_num_g</span><span class="p">)</span> <span class="o">=</span> <span class="n">gevals</span><span class="p">(</span><span class="n">thread_num_g</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

		<span class="n">g</span> <span class="o">=</span> <span class="nb">sin</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span>

	<span class="k">end function </span><span class="n">g</span>

<span class="k">end module </span><span class="n">functions</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">quadrature</span>

    <span class="k">use </span><span class="n">omp_lib</span>

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c">! Estimate the integral of f(x) from a to b using the</span>
    <span class="c">! Trapezoid Rule with n points.</span>

    <span class="c">! Input:</span>
    <span class="c">!   f:  the function to integrate</span>
    <span class="c">!   a:  left endpoint x</span>
    <span class="c">!   b:  right endpoint x</span>
    <span class="c">!   c:  left endpoint y</span>
    <span class="c">!   d:  right endpoint y</span>
    <span class="c">!   n:  number of points to use</span>
    <span class="c">! Returns:</span>
    <span class="c">!   the estimate of the integral</span>
     
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span><span class="p">,</span><span class="n">g</span>

    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">h</span><span class="p">,</span> <span class="n">trap_sum</span><span class="p">,</span> <span class="n">xj</span>

    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">trap_sum</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">d0</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">))</span>  <span class="c">! endpoint contributions</span>
    
    <span class="c">!$omp parallel do private(xj) reduction(+ : trap_sum) </span>
    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">xj</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">h</span>
        <span class="n">trap_sum</span> <span class="o">=</span> <span class="n">trap_sum</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">xj</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="n">trapezoid</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">trap_sum</span>

<span class="k">end function </span><span class="n">trapezoid</span>


<span class="k">subroutine </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">nvals</span><span class="p">,</span><span class="n">int_true</span><span class="p">,</span><span class="n">method</span><span class="p">)</span>

    <span class="c">! Compute and print out a table of errors when the quadrature</span>
    <span class="c">! rule specified by the input function method is applied for</span>
    <span class="c">! each value of n in the array nvals.</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span> <span class="n">int_true</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">method</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">nvals</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span><span class="p">,</span> <span class="n">n</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">last_error</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">int_approx</span>

    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;      n         approximation        error       ratio&quot;</span>
    <span class="n">last_error</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>   
    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">size</span><span class="p">(</span><span class="n">nvals</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">nvals</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
        <span class="n">int_approx</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">int_approx</span> <span class="o">-</span> <span class="n">int_true</span><span class="p">)</span>
        <span class="n">ratio</span> <span class="o">=</span> <span class="n">last_error</span> <span class="o">/</span> <span class="n">error</span>
        <span class="n">last_error</span> <span class="o">=</span> <span class="n">error</span>  <span class="c">! for next n</span>

        <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">int_approx</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ratio</span>
 <span class="mi">11</span>     <span class="k">format</span><span class="p">(</span><span class="n">i8</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="n">es13</span><span class="p">.</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">enddo</span>

<span class="k">end subroutine </span><span class="n">error_table</span>


<span class="k">end module </span><span class="n">quadrature</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test</span>

    <span class="k">use </span><span class="n">omp_lib</span>

    <span class="k">use </span><span class="n">quadrature</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">trapezoid</span><span class="p">,</span> <span class="n">error_table</span>
    <span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">fevals</span><span class="p">,</span> <span class="n">gevals</span><span class="p">,</span> <span class="n">k</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">d</span><span class="p">,</span><span class="n">int_true</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">nvals</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">nthreads</span>

    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">elapsed_time</span>
    <span class="kt">integer</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">tclock1</span><span class="p">,</span> <span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span>

    <span class="n">nthreads</span> <span class="o">=</span> <span class="mi">1</span>      <span class="c">! for serial mode</span>
    <span class="c">!$ nthreads = 4   ! for openmp</span>
    <span class="c">!$ call omp_set_num_threads(nthreads)</span>
    <span class="k">print </span><span class="mi">100</span><span class="p">,</span> <span class="n">nthreads</span>
<span class="mi">100</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Using &quot;</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="s2">&quot; threads&quot;</span><span class="p">)</span>

    <span class="n">fevals</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d3</span>   <span class="c">! functions module variable for function f2</span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
	<span class="n">c</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d0</span>
	<span class="n">d</span> <span class="o">=</span> <span class="mf">4.</span><span class="n">d0</span>
<span class="c">!    int_true = (-sin(b+c)+sin(b+d))-(-sin(a+c)+sin(a+d))</span>
	<span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="nb">sin</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="nb">sin</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">c</span><span class="p">))</span><span class="o">-</span><span class="p">(</span><span class="o">-</span><span class="nb">sin</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">d</span><span class="p">)</span><span class="o">+</span><span class="nb">sin</span><span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="n">c</span><span class="p">))</span>
    <span class="k">print </span><span class="mi">10</span><span class="p">,</span> <span class="n">int_true</span>
 <span class="mi">10</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;true integral: &quot;</span><span class="p">,</span> <span class="n">es22</span><span class="p">.</span><span class="mi">14</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>  <span class="c">! blank line</span>

    <span class="c">! values of n to test:   (larger values than before)</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">10</span>
        <span class="n">nvals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="c">! time the call to error_table:</span>
    <span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock1</span><span class="p">)</span>  
    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
    <span class="k">call </span><span class="n">error_table</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">nvals</span><span class="p">,</span> <span class="n">int_true</span><span class="p">,</span> <span class="n">trapezoid</span><span class="p">)</span>
    <span class="k">call </span><span class="nb">cpu_time</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span>   
    <span class="k">call </span><span class="nb">system_clock</span><span class="p">(</span><span class="n">tclock2</span><span class="p">,</span> <span class="n">clock_rate</span><span class="p">)</span>

    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">tclock2</span> <span class="o">-</span> <span class="n">tclock1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">clock_rate</span><span class="p">)</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>
    <span class="k">print </span><span class="mi">11</span><span class="p">,</span> <span class="n">elapsed_time</span>
 <span class="mi">11</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Elapsed time = &quot;</span><span class="p">,</span><span class="n">f12</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>

    <span class="k">print </span><span class="mi">12</span><span class="p">,</span> <span class="n">t2</span><span class="o">-</span><span class="n">t1</span>
 <span class="mi">12</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;CPU time = &quot;</span><span class="p">,</span><span class="n">f12</span><span class="p">.</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot; seconds&quot;</span><span class="p">)</span>

    
    <span class="c">! print the number of function evaluations by each thread:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nthreads</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">print </span><span class="mi">101</span><span class="p">,</span>  <span class="n">i</span><span class="p">,</span> <span class="n">fevals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="mi">101</span>     <span class="k">format</span><span class="p">(</span><span class="s2">&quot;fevals by thread &quot;</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="s2">&quot;: &quot;</span><span class="p">,</span><span class="n">i13</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="k">print </span><span class="mi">102</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">fevals</span><span class="p">)</span>
<span class="mi">102</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Total number of fevals: &quot;</span><span class="p">,</span><span class="n">i10</span><span class="p">)</span>

    <span class="c">! print the number of function evaluations by each thread:</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">nthreads</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">print </span><span class="mi">103</span><span class="p">,</span>  <span class="n">i</span><span class="p">,</span> <span class="n">gevals</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
<span class="mi">103</span>     <span class="k">format</span><span class="p">(</span><span class="s2">&quot;gevals by thread &quot;</span><span class="p">,</span><span class="n">i2</span><span class="p">,</span><span class="s2">&quot;: &quot;</span><span class="p">,</span><span class="n">i13</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="k">print </span><span class="mi">104</span><span class="p">,</span> <span class="nb">sum</span><span class="p">(</span><span class="n">gevals</span><span class="p">)</span>
<span class="mi">104</span> <span class="k">format</span><span class="p">(</span><span class="s2">&quot;Total number of gevals: &quot;</span><span class="p">,</span><span class="n">i10</span><span class="p">)</span>



<span class="k">end program </span><span class="n">test</span>
</pre></div>
</div>
</div>
<div class="section" id="workspace-6-mpi">
<h2>3.6. Workspace 6: MPI<a class="headerlink" href="#workspace-6-mpi" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>Makefile</strong> (makefile for this directory)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span># $MYHPSC/codes/mpi/Makefile

# Usage:  to try out test1.f90, for example:
#     make test FNAME=test1
# or
#     make test FNAME=test1 NUM_PROCS=8

NUM_PROCS ?= 4   # default if not specified on command line or env variable

FC = mpif90
FFLAGS = 
LFLAGS = 

.PHONY: clean, test

FNAME ?= test

%.o : %.f90
	$(FC) $(FFLAGS) -c $&lt;

$(FNAME).exe: $(FNAME).f90
	$(FC) $(FFLAGS) $(LFLAGS) $(FNAME).f90 -o $(FNAME).exe

test: $(FNAME).exe
	mpiexec -n $(NUM_PROCS) ./$(FNAME).exe

clean:
	rm -f *.o *.exe
</pre></div>
</div>
<ul class="simple">
<li><strong>copyvalue.f90</strong> (passes a value from Process 0 to Processes 1-3 using MPI)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $UWHPSC/codes/mpi/copyvalue.f90</span>
<span class="c">!</span>
<span class="c">! Set value in Process 0 and copy this through a chain of processes</span>
<span class="c">! and finally print result from Process numprocs-1.</span>
<span class="c">!</span>

<span class="k">program </span><span class="n">copyvalue</span>

    <span class="k">use </span><span class="n">mpi</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span><span class="n">ierr</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">MPI_STATUS_SIZE</span><span class="p">)</span> <span class="kd">::</span> <span class="n">status</span>

    <span class="k">call </span><span class="n">MPI_INIT</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">num_procs</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Only one process, cannot do anything&quot;</span>
        <span class="k">call </span><span class="n">MPI_FINALIZE</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
        <span class="k">stop</span>
<span class="k">        </span><span class="n">endif</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">i</span> <span class="o">=</span> <span class="mi">55</span>
        <span class="k">print</span> <span class="s1">&#39;(&quot;Process &quot;,i3,&quot; setting      i = &quot;,i3)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">i</span>

        <span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

      <span class="k">else if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="o">&lt;</span> <span class="n">num_procs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="n">proc_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

        <span class="k">print</span> <span class="s1">&#39;(&quot;Process &quot;,i3,&quot; receives     i = &quot;,i3)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">i</span>
        <span class="k">print</span> <span class="s1">&#39;(&quot;Process &quot;,i3,&quot; sends        i = &quot;,i3)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">i</span>

        <span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="n">proc_num</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>


      <span class="k">else if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="o">==</span> <span class="n">num_procs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="n">proc_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

        <span class="k">print</span> <span class="s1">&#39;(&quot;Process &quot;,i3,&quot; ends up with i = &quot;,i3)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">i</span>
      <span class="n">endif</span>

    <span class="k">call </span><span class="n">MPI_FINALIZE</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="n">copyvalue</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>copyvalue2.f90</strong> (passes a value from Process 3 to Processes 0-2 using MPI)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! $UWHPSC/codes/mpi/copyvalue2.f90</span>
<span class="c">!</span>
<span class="c">! Set value in Process numprocs-1 and copy this through a chain of processes</span>
<span class="c">! and finally print result from Process 0.</span>
<span class="c">!</span>

<span class="k">program </span><span class="n">copyvalue2</span>

    <span class="k">use </span><span class="n">mpi</span>

    <span class="k">implicit none</span>

<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span><span class="n">ierr</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">MPI_STATUS_SIZE</span><span class="p">)</span> <span class="kd">::</span> <span class="n">status</span>

    <span class="k">call </span><span class="n">MPI_INIT</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">num_procs</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Only one process, cannot do anything&quot;</span>
        <span class="k">call </span><span class="n">MPI_FINALIZE</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
        <span class="k">stop</span>
<span class="k">        </span><span class="n">endif</span>


    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="n">num_procs</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        </span><span class="n">i</span> <span class="o">=</span> <span class="mi">55</span>
        <span class="k">print</span> <span class="s1">&#39;(&quot;Process &quot;,i3,&quot; setting      i = &quot;,i3)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">i</span>

        <span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="n">num_procs</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

      <span class="k">else if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">GT</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="n">proc_num</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

        <span class="k">print</span> <span class="s1">&#39;(&quot;Process &quot;,i3,&quot; receives     i = &quot;,i3)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">i</span>
        <span class="k">print</span> <span class="s1">&#39;(&quot;Process &quot;,i3,&quot; sends        i = &quot;,i3)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>

        <span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="n">proc_num</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>


      <span class="k">else if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">        call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_INTEGER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="p">&amp;</span>
                      <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

        <span class="k">print</span> <span class="s1">&#39;(&quot;Process &quot;,i3,&quot; ends up with i = &quot;,i3)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">i</span>
      <span class="n">endif</span>

    <span class="k">call </span><span class="n">MPI_FINALIZE</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="n">copyvalue2</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>part2/functions.f90, part2/quadrature.f90, part2/Makefile</strong> (the sinusoidal function, quadrature module and makefile)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">functions</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">fevals_proc</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">k</span>
    <span class="k">save</span>

<span class="k">contains</span>

<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">implicit none</span>
<span class="k">        </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span> 
        <span class="kt">integer </span><span class="n">proc_num</span><span class="p">,</span> <span class="n">ierr</span>

        <span class="c">! keep track of number of function evaluations by</span>
        <span class="c">! each process:</span>
        <span class="n">fevals_proc</span> <span class="o">=</span> <span class="n">fevals_proc</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d0</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">sin</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        
    <span class="k">end function </span><span class="n">f</span>

<span class="k">end module </span><span class="n">functions</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">quadrature</span>

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c">! Estimate the integral of f(x) from a to b using the</span>
    <span class="c">! Trapezoid Rule with n points.</span>

    <span class="c">! Input:</span>
    <span class="c">!   f:  the function to integrate</span>
    <span class="c">!   a:  left endpoint</span>
    <span class="c">!   b:  right endpoint</span>
    <span class="c">!   n:  number of points to use</span>
    <span class="c">! Returns:</span>
    <span class="c">!   the estimate of the integral</span>
     
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">h</span><span class="p">,</span> <span class="n">trap_sum</span><span class="p">,</span> <span class="n">xj</span>

    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">trap_sum</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">d0</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>  <span class="c">! endpoint contributions</span>
    
    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">xj</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">h</span>
        <span class="n">trap_sum</span> <span class="o">=</span> <span class="n">trap_sum</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">xj</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="n">trapezoid</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">trap_sum</span>

<span class="k">end function </span><span class="n">trapezoid</span>

<span class="k">end module </span><span class="n">quadrature</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>
OBJECTS = functions.o quadrature.o test.o
OBJECTS2 = functions.o quadrature.o test2.o
FFLAGS = 
NUM_PROCS ?= 4   # default if not specified on command line or env variable

.PHONY: test clean test2

test: test.exe
	mpiexec -n $(NUM_PROCS) test.exe

test2: test2.exe
	mpiexec -n $(NUM_PROCS) test2.exe

test.exe: $(OBJECTS)
	mpif90 $(FFLAGS) $(OBJECTS) -o test.exe

test2.exe: $(OBJECTS2)
	mpif90 $(FFLAGS) $(OBJECTS2) -o test2.exe

%.o : %.f90
	mpif90 $(FFLAGS) -c  $&lt; 

clean:
	rm -f *.o *.exe *.mod

</pre></div>
</div>
<ul class="simple">
<li><strong>part2/test.f90</strong> (compute the same integral over all Processes using MPI)</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test</span>

    <span class="k">use </span><span class="n">mpi</span>

    <span class="k">use </span><span class="n">quadrature</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">trapezoid</span>
    <span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="n">fevals_proc</span><span class="p">,</span> <span class="n">k</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">int_true</span><span class="p">,</span> <span class="n">int_approx</span>

    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> <span class="n">ierr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fevals_total</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">MPI_STATUS_SIZE</span><span class="p">)</span> <span class="kd">::</span> <span class="n">status</span>

    <span class="k">call </span><span class="n">MPI_INIT</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

    <span class="c">! All processes set these values so we don&#39;t have to broadcast:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d3</span>   <span class="c">! functions module variable </span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="n">d0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="n">d0</span><span class="o">/</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>

    <span class="c">! Each process keeps track of number of fevals:</span>
    <span class="n">fevals_proc</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span> <span class="s1">&#39;(&quot;Using &quot;,i3,&quot; processes&quot;)&#39;</span><span class="p">,</span> <span class="n">num_procs</span>
        <span class="k">print</span> <span class="s1">&#39;(&quot;true integral: &quot;, es22.14)&#39;</span><span class="p">,</span> <span class="n">int_true</span>
        <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>  <span class="c">! blank line</span>
        <span class="n">endif</span>

    <span class="k">call </span><span class="n">MPI_BARRIER</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span> <span class="c">! wait for process 0 to print</span>

    <span class="c">! Note: In this version all processes call trap and repeat the</span>
    <span class="c">!       same work, so each should get the same answer.  </span>
    <span class="n">int_approx</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">n</span><span class="p">)</span>
    <span class="k">print</span> <span class="s1">&#39;(&quot;Process &quot;,i3,&quot; with n = &quot;,i8,&quot; computes int_approx = &quot;,es22.14)&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
            <span class="n">proc_num</span><span class="p">,</span><span class="n">n</span><span class="p">,</span> <span class="n">int_approx</span>

    <span class="k">call </span><span class="n">MPI_BARRIER</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span> <span class="c">! wait for all process to print</span>

    <span class="c">! print the number of function evaluations by each thread:</span>
    <span class="k">print</span> <span class="s1">&#39;(&quot;fevals by Process &quot;,i2,&quot;: &quot;,i13)&#39;</span><span class="p">,</span>  <span class="n">proc_num</span><span class="p">,</span> <span class="n">fevals_proc</span>

    <span class="k">call </span><span class="n">MPI_BARRIER</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span> <span class="c">! wait for all process to print</span>
	
	<span class="k">call </span><span class="n">MPI_REDUCE</span><span class="p">(</span><span class="n">fevals_proc</span><span class="p">,</span> <span class="n">fevals_total</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">&amp;</span>
			<span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="n">MPI_SUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">&amp;</span>
		    <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
        <span class="c">! This is wrong -- part of homework is to fix this:</span>
		
    <span class="c">!    fevals_total = 0   !! need to fix</span>
        <span class="k">print</span> <span class="s1">&#39;(&quot;Total number of fevals:  &quot;,i10)&#39;</span><span class="p">,</span> <span class="n">fevals_total</span>
        <span class="n">endif</span>

    <span class="k">call </span><span class="n">MPI_FINALIZE</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="n">test</span>
</pre></div>
</div>
<ul class="simple">
<li><strong>part2/test2.f90</strong> (integral using Master-Worker paradigm)Makefile for this directory</li>
</ul>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test2</span>

    <span class="k">use </span><span class="n">mpi</span>

    <span class="k">use </span><span class="n">quadrature</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">trapezoid</span>
    <span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="n">fevals_proc</span><span class="p">,</span> <span class="n">k</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">int_true</span><span class="p">,</span> <span class="n">int_approx</span><span class="p">,</span> <span class="n">dx_sub</span><span class="p">,</span> <span class="n">int_sub</span>

    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> <span class="n">ierr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fevals_total</span><span class="p">,</span> <span class="n">n_sub</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">jj</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">MPI_STATUS_SIZE</span><span class="p">)</span> <span class="kd">::</span> <span class="n">status</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:)</span> <span class="kd">::</span> <span class="n">ab_sub</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:)</span> <span class="kd">::</span> <span class="n">sub</span><span class="p">,</span> <span class="n">int_array</span>
 
    <span class="k">call </span><span class="n">MPI_INIT</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

    <span class="c">! All processes set these values so we don&#39;t have to broadcast:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d3</span>   <span class="c">! functions module variable </span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="n">d0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="n">d0</span><span class="o">/</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
	
	<span class="n">n_sub</span> <span class="o">=</span> <span class="n">num_procs</span><span class="o">-</span><span class="mi">1</span> <span class="c">! Set the number of Worker Processes</span>

    <span class="c">! Each process keeps track of number of fevals:</span>
    <span class="n">fevals_proc</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">GT</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        allocate</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>   <span class="c">! to hold a column vector sent from master</span>
    <span class="n">endif</span> 

    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span> <span class="s1">&#39;(&quot;Using &quot;,i3,&quot; processes&quot;)&#39;</span><span class="p">,</span> <span class="n">num_procs</span>
        <span class="k">print</span> <span class="s1">&#39;(&quot;true integral: &quot;, es22.14)&#39;</span><span class="p">,</span> <span class="n">int_true</span>
        <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>  <span class="c">! blank line</span>

		<span class="k">allocate</span><span class="p">(</span><span class="n">ab_sub</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n_sub</span><span class="p">))</span>    <span class="c">! to hold a-b values for Workers</span>
		<span class="k">allocate</span><span class="p">(</span><span class="n">int_array</span><span class="p">(</span><span class="n">n_sub</span><span class="p">))</span>	 <span class="c">! to hold integral from Workers</span>

		<span class="n">ab_sub</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d0</span>

		<span class="c">! Process 0 (Master) sends other processes (Workers) left and right edges</span>
		<span class="c">! of the integral      		</span>

		<span class="n">dx_sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_sub</span>

    	<span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_sub</span>
      		<span class="n">ab_sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dx_sub</span>
      		<span class="n">ab_sub</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">dx_sub</span>
      		<span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">ab_sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
      	<span class="n">enddo</span>

   		<span class="c">! Master recieves part of the integral from the Workers and stores it in</span>
		<span class="c">! an array from any process</span>

		<span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_sub</span>
			<span class="k">call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">int_sub</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">MPI_ANY_SOURCE</span><span class="p">,</span> <span class="n">MPI_ANY_TAG</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
			<span class="n">jj</span> <span class="o">=</span> <span class="n">status</span><span class="p">(</span><span class="n">MPI_TAG</span><span class="p">)</span>
			<span class="n">int_array</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span> <span class="o">=</span> <span class="n">int_sub</span>       	
		<span class="n">enddo</span>

		<span class="n">int_approx</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">int_array</span><span class="p">))</span>

    <span class="n">endif</span>

	<span class="c">! Process 0 (Master) sends other processes (Workers) left and right edges</span>
	<span class="c">! of the integral </span>

	<span class="k">if</span><span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">GT</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">		call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
		              <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_ANY_TAG</span><span class="p">,</span> <span class="p">&amp;</span>
		              <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

		<span class="n">int_sub</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">n</span><span class="p">)</span>

		<span class="n">j</span> <span class="o">=</span> <span class="n">status</span><span class="p">(</span><span class="n">MPI_TAG</span><span class="p">)</span>   <span class="c">! this is the row number</span>
		                      <span class="c">! (should agree with proc_num)</span>

	 	<span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">int_sub</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
	 	               <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

		<span class="c">! print the number of function evaluations by each thread:</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot;fevals by Process &quot;,i2,&quot;: &quot;,i13)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">fevals_proc</span>
	
	<span class="n">endif</span>

	<span class="c">! Master Process prints out the result:</span>
	<span class="k">call </span><span class="n">MPI_BARRIER</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span> <span class="c">! wait for all processes to print</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">   		print</span> <span class="s1">&#39;(&quot;Trapezoid approximation with &quot;,i8,&quot; total points: &quot;,es22.14)&#39;</span><span class="p">,&amp;</span>
        <span class="n">n_sub</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">int_approx</span>
    <span class="n">endif</span>

    <span class="k">call </span><span class="n">MPI_FINALIZE</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="n">test2</span>
</pre></div>
</div>
</div>
<div class="section" id="project-1-1d-integral-and-mpi">
<h2>3.7. Project 1: 1D Integral and MPI<a class="headerlink" href="#project-1-1d-integral-and-mpi" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>functions.f90, quadrature.f90, test2.f90, Makefile</strong> (compute a 1D integral using MPI by dividing up intervals between an indeterminate number of processes)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>
OBJECTS = functions.o quadrature.o test.o
OBJECTS2 = functions.o quadrature.o test2.o
OBJECTS3 = functions.o quadrature.o test3.o
FFLAGS = 
NUM_PROCS ?= 4   # default if not specified on command line or env variable

.PHONY: test clean test2 test3

test: test.exe
	mpiexec -n $(NUM_PROCS) test.exe

test2: test2.exe
	mpiexec -n $(NUM_PROCS) test2.exe

test3: test3.exe
	mpiexec -n $(NUM_PROCS) test3.exe

test.exe: $(OBJECTS)
	mpif90 $(FFLAGS) $(OBJECTS) -o test.exe

test2.exe: $(OBJECTS2)
	mpif90 $(FFLAGS) $(OBJECTS2) -o test2.exe

test3.exe: $(OBJECTS3)
	mpif90 $(FFLAGS) $(OBJECTS3) -o test3.exe

%.o : %.f90
	mpif90 $(FFLAGS) -c  $&lt; 

clean:
	rm -f *.o *.exe *.mod

</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">functions</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">fevals_proc</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">k</span>
    <span class="k">save</span>

<span class="k">contains</span>

<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">implicit none</span>
<span class="k">        </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span> 
        <span class="kt">integer </span><span class="n">proc_num</span><span class="p">,</span> <span class="n">ierr</span>

        <span class="c">! keep track of number of function evaluations by</span>
        <span class="c">! each process:</span>
        <span class="n">fevals_proc</span> <span class="o">=</span> <span class="n">fevals_proc</span> <span class="o">+</span> <span class="mi">1</span>
        
        <span class="n">f</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d0</span> <span class="o">+</span> <span class="n">x</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span> <span class="nb">sin</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        
    <span class="k">end function </span><span class="n">f</span>

<span class="k">end module </span><span class="n">functions</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">quadrature</span>

<span class="k">contains</span>

<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">function </span><span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>

    <span class="c">! Estimate the integral of f(x) from a to b using the</span>
    <span class="c">! Trapezoid Rule with n points.</span>

    <span class="c">! Input:</span>
    <span class="c">!   f:  the function to integrate</span>
    <span class="c">!   a:  left endpoint</span>
    <span class="c">!   b:  right endpoint</span>
    <span class="c">!   n:  number of points to use</span>
    <span class="c">! Returns:</span>
    <span class="c">!   the estimate of the integral</span>
     
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">f</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n</span>

    <span class="c">! Local variables:</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">j</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">h</span><span class="p">,</span> <span class="n">trap_sum</span><span class="p">,</span> <span class="n">xj</span>

    <span class="n">h</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">trap_sum</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">d0</span><span class="o">*</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>  <span class="c">! endpoint contributions</span>
    
    <span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span>
        <span class="n">xj</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">h</span>
        <span class="n">trap_sum</span> <span class="o">=</span> <span class="n">trap_sum</span> <span class="o">+</span> <span class="n">f</span><span class="p">(</span><span class="n">xj</span><span class="p">)</span>
        <span class="n">enddo</span>

    <span class="n">trapezoid</span> <span class="o">=</span> <span class="n">h</span> <span class="o">*</span> <span class="n">trap_sum</span>

<span class="k">end function </span><span class="n">trapezoid</span>

<span class="k">end module </span><span class="n">quadrature</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test2</span>

    <span class="k">use </span><span class="n">mpi</span>

    <span class="k">use </span><span class="n">quadrature</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">trapezoid</span>
    <span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">f</span><span class="p">,</span> <span class="n">fevals_proc</span><span class="p">,</span> <span class="n">k</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">int_true</span><span class="p">,</span> <span class="n">int_approx</span><span class="p">,</span> <span class="n">dx_sub</span><span class="p">,</span> <span class="n">int_sub</span>

    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> <span class="n">ierr</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">fevals_total</span><span class="p">,</span> <span class="n">n_sub</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">jj</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">MPI_STATUS_SIZE</span><span class="p">)</span> <span class="kd">::</span> <span class="n">status</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:,:)</span> <span class="kd">::</span> <span class="n">ab_sub</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:)</span> <span class="kd">::</span> <span class="n">sub</span><span class="p">,</span> <span class="n">int_array</span>
 
    <span class="k">call </span><span class="n">MPI_INIT</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">num_procs</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

    <span class="c">! All processes set these values so we don&#39;t have to broadcast:</span>
    <span class="n">k</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d3</span>   <span class="c">! functions module variable </span>
    <span class="n">a</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">**</span><span class="mi">4</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span> <span class="o">/</span> <span class="mf">4.</span><span class="n">d0</span> <span class="o">-</span> <span class="p">(</span><span class="mf">1.</span><span class="n">d0</span><span class="o">/</span><span class="n">k</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="nb">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">a</span><span class="p">))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
	
	<span class="n">n_sub</span> <span class="o">=</span> <span class="n">num_procs</span><span class="o">-</span><span class="mi">1</span> <span class="c">! Set the number of Worker Processes</span>

    <span class="c">! Each process keeps track of number of fevals:</span>
    <span class="n">fevals_proc</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">GT</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        allocate</span><span class="p">(</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>   <span class="c">! to hold a column vector sent from master</span>
    <span class="n">endif</span> 

    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">        print</span> <span class="s1">&#39;(&quot;Using &quot;,i3,&quot; processes&quot;)&#39;</span><span class="p">,</span> <span class="n">num_procs</span>
        <span class="k">print</span> <span class="s1">&#39;(&quot;true integral: &quot;, es22.14)&#39;</span><span class="p">,</span> <span class="n">int_true</span>
        <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot; &quot;</span>  <span class="c">! blank line</span>

		<span class="k">allocate</span><span class="p">(</span><span class="n">ab_sub</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">n_sub</span><span class="p">))</span>    <span class="c">! to hold a-b values for Workers</span>
		<span class="k">allocate</span><span class="p">(</span><span class="n">int_array</span><span class="p">(</span><span class="n">n_sub</span><span class="p">))</span>	 <span class="c">! to hold integral from Workers</span>

		<span class="n">ab_sub</span> <span class="o">=</span> <span class="mf">1.</span><span class="n">d0</span>

		<span class="c">! Process 0 (Master) sends other processes (Workers) left and right edges</span>
		<span class="c">! of the integral      		</span>

		<span class="n">dx_sub</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_sub</span>

    	<span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_sub</span>
      		<span class="n">ab_sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">dx_sub</span>
      		<span class="n">ab_sub</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="n">j</span><span class="p">)</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">dx_sub</span>
      		<span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">ab_sub</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
      	<span class="n">enddo</span>

   		<span class="c">! Master recieves part of the integral from the Workers and stores it in</span>
		<span class="c">! an array from any process</span>

		<span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_sub</span>
			<span class="k">call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">int_sub</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">MPI_ANY_SOURCE</span><span class="p">,</span> <span class="n">MPI_ANY_TAG</span><span class="p">,</span> <span class="p">&amp;</span>
                    <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
			<span class="n">jj</span> <span class="o">=</span> <span class="n">status</span><span class="p">(</span><span class="n">MPI_TAG</span><span class="p">)</span>
			<span class="n">int_array</span><span class="p">(</span><span class="n">jj</span><span class="p">)</span> <span class="o">=</span> <span class="n">int_sub</span>       	
		<span class="n">enddo</span>

		<span class="n">int_approx</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">int_array</span><span class="p">))</span>

    <span class="n">endif</span>

	<span class="c">! Process 0 (Master) sends other processes (Workers) left and right edges</span>
	<span class="c">! of the integral </span>

	<span class="k">if</span><span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">GT</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">		call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
		              <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_ANY_TAG</span><span class="p">,</span> <span class="p">&amp;</span>
		              <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

		<span class="n">int_sub</span> <span class="o">=</span> <span class="n">trapezoid</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">sub</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">sub</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span><span class="n">n</span><span class="p">)</span>

		<span class="n">j</span> <span class="o">=</span> <span class="n">status</span><span class="p">(</span><span class="n">MPI_TAG</span><span class="p">)</span>   <span class="c">! this is the row number</span>
		                      <span class="c">! (should agree with proc_num)</span>

	 	<span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">int_sub</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
	 	               <span class="mi">0</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

		<span class="c">! print the number of function evaluations by each thread:</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot;fevals by Process &quot;,i2,&quot;: &quot;,i13)&#39;</span><span class="p">,</span> <span class="n">proc_num</span><span class="p">,</span> <span class="n">fevals_proc</span>
	
	<span class="n">endif</span>

	<span class="c">! Master Process prints out the result:</span>
	<span class="k">call </span><span class="n">MPI_BARRIER</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span> <span class="c">! wait for all processes to print</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">proc_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">   		print</span> <span class="s1">&#39;(&quot;Trapezoid approximation with &quot;,i8,&quot; total points: &quot;,es22.14)&#39;</span><span class="p">,&amp;</span>
        <span class="n">n_sub</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">int_approx</span>
    <span class="n">endif</span>

    <span class="k">call </span><span class="n">MPI_FINALIZE</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="n">test2</span>
</pre></div>
</div>
</div>
<div class="section" id="project-2-20d-integral-and-the-monte-carlo-method">
<h2>3.8. Project 2: 20D Integral and the Monte Carlo Method<a class="headerlink" href="#project-2-20d-integral-and-the-monte-carlo-method" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>functions.f90, quadrature_mc.f90, random_util.f90, test_quad_mc.f90, Makefile</strong> (compute integral using Monte Carlo method for a 20 dimensional integral - serial)</li>
<li><strong>plot_mc_quad_error.py</strong> (plot the result)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span>OBJECTS = random_util.o functions.o quadrature_mc.o test_quad_mc.o
FFLAGS = 

.PHONY: test plot clean clobber

test: test.exe
	./test.exe

test.exe: $(OBJECTS)
	gfortran $(FFLAGS) $(OBJECTS) -o test.exe

%.o : %.f90
	gfortran $(FFLAGS) -c  $&lt; 

mc_quad_error.txt: test.exe
	./test.exe

plot: mc_quad_error.txt
	python plot_mc_quad_error.py

clean:
	rm -f *.o *.exe *.mod

clobber: clean
	rm -f mc_quad_error.txt mc_quad_error.png

</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This module returns the value of a function:</span>
<span class="c">! sum(x**2) over all dimensions</span>
<span class="c">! it also sets the number of evaulations of this function</span>
<span class="c">! ---</span>
<span class="k">module </span><span class="n">functions</span>
<span class="c">! ---</span>
<span class="c">! gevals is a module variable</span>
<span class="c">! Example use: use functions, only gevals</span>
<span class="c">! ---</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">gevals</span>
    <span class="k">save</span>

<span class="k">contains</span>
<span class="c">! ---</span>
<span class="c">! Multiple dimension function</span>
<span class="c">! Example use: f = g(xin,ndim)</span>
<span class="c">! Inputs: x (vector of length ndim), ndim (number of dimensions)</span>
<span class="c">! Output: g (the value of the function over all dimensions)	</span>
<span class="c">! ---		</span>
    <span class="k">function </span><span class="n">g</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">ndim</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Declare parameters and vectors</span>
	<span class="c">! ---</span>
		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ndim</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">g</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span>
	<span class="c">! ---</span>
	<span class="c">! We need to initialise the number of evaluations to zero</span>
	<span class="c">! ---</span>
		<span class="n">g</span> <span class="o">=</span> <span class="mf">0.</span><span class="n">d0</span>
	<span class="c">! ---</span>
	<span class="c">! Evaluate function in 20 dimensions</span>
	<span class="c">! ---</span>
		<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ndim</span>
		    <span class="n">g</span> <span class="o">=</span> <span class="n">g</span> <span class="o">+</span> <span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
		<span class="n">enddo</span>
	<span class="c">! ---</span>
	<span class="c">! Update the number of function evaluations</span>
	<span class="c">! ---</span>
		<span class="n">gevals</span> <span class="o">=</span> <span class="n">gevals</span> <span class="o">+</span> <span class="mi">1</span>

	<span class="k">end function </span><span class="n">g</span>

<span class="k">end module </span><span class="n">functions</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This module performs Monte Carlo Integration by:</span>
<span class="c">! 1) Generating random input over a number of points</span>
<span class="c">! 2) Evaluating the function at these points for 20 dimensions</span>
<span class="c">! 3) Summing the function and dividing by the number of points for the average</span>
<span class="c">! 4) Multiplying the average by the base for the integral</span>
<span class="c">! ---</span>
<span class="k">module </span><span class="n">quadrature_mc</span>
<span class="c">! ---</span>
<span class="c">! Uses random seed and functions modules</span>
<span class="c">! ---</span>
	<span class="k">use </span><span class="n">random_util</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">init_random_seed</span>
	<span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">g</span>

<span class="k">contains</span>
<span class="c">! ---</span>
<span class="c">! Monte Carlo Integration function</span>
<span class="c">! Example use: int_mc = quad_mc(g,a,b,ndim,npoints)</span>
<span class="c">! Inputs: g (from functions module), a and b (vectors of length ndim)</span>
<span class="c">!		  ndim (number of dimensions) npoints (number of points)</span>
<span class="c">! Output: quad_mc (the value of the integral)	</span>
<span class="c">! ---		</span>
	<span class="k">function </span><span class="n">quad_mc</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">npoints</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Declare parameters and arrays.</span>
	<span class="c">! ---</span>
		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">external</span> <span class="kd">::</span> <span class="n">g</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ndim</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ndim</span><span class="p">,</span> <span class="n">npoints</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">seed1</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">f</span><span class="p">,</span> <span class="n">xin</span><span class="p">,</span> <span class="n">x</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">quad_mc</span> 
	<span class="c">! ---</span>
	<span class="c">! Number of points &amp; dimensions is unknown, so must allocate:</span>
	<span class="c">! ---</span>
		<span class="k">allocate</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">npoints</span><span class="p">))</span> <span class="c">! random number array 0 to 1  </span>
		<span class="k">allocate</span><span class="p">(</span><span class="n">xin</span><span class="p">(</span><span class="n">ndim</span><span class="p">))</span>  <span class="c">! random number array a+(b-a)x</span>
		<span class="k">allocate</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">npoints</span><span class="p">))</span> <span class="c">! result of sum(x**2) over all dimensions</span>
							 <span class="c">! for n points</span>
	<span class="c">! ---</span>
	<span class="c">! Generate random number array x once per call of quad_mc</span>
	<span class="c">! Length of the array is the number of random points </span>
	<span class="c">! ---</span>
		<span class="n">seed1</span> <span class="o">=</span> <span class="mi">12345</span>   <span class="c">! seed1 = 12345 for repeatable seed</span>
						<span class="c">! seed1 = 0 for random seed</span>
 		<span class="k">call </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
		<span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Generate random input based on a and b and </span>
	<span class="c">! compute sum(x**2) for all dimensions</span>
	<span class="c">! ---</span>
		<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">npoints</span>
			<span class="k">do </span><span class="n">j</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ndim</span>
				<span class="n">xin</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">=</span><span class="n">a</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">b</span><span class="p">(</span><span class="n">j</span><span class="p">)</span><span class="o">-</span><span class="n">a</span><span class="p">(</span><span class="n">j</span><span class="p">))</span><span class="o">*</span><span class="n">x</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
			<span class="n">enddo</span>
			<span class="n">f</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">g</span><span class="p">(</span><span class="n">xin</span><span class="p">,</span><span class="n">ndim</span><span class="p">)</span>
		<span class="n">enddo</span>
	<span class="c">! ---</span>
	<span class="c">! Return the value of the Monte Carlo Integral by multiplying the</span>
	<span class="c">! average value by the base</span>
	<span class="c">! ---</span>
		<span class="n">quad_mc</span> <span class="o">=</span> <span class="nb">product</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="n">npoints</span><span class="p">)</span>

	<span class="k">end function </span><span class="n">quad_mc</span>

<span class="k">end module </span><span class="n">quadrature_mc</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This module returns seed for the random_number function</span>
<span class="c">! ---</span>
<span class="k">module </span><span class="n">random_util</span>

<span class="k">contains</span>

<span class="k">	subroutine </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Declare the parameters</span>
	<span class="c">! ---</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">seed1</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">clock</span> 
		<span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">seed</span>
	<span class="c">! ---</span>
	<span class="c">! Determine how many numbers needed to seed and allocate</span>
	<span class="c">! ---</span>
		<span class="k">call </span><span class="nb">random_seed</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">nseed</span><span class="p">)</span>  
		<span class="k">allocate</span><span class="p">(</span><span class="n">seed</span><span class="p">(</span><span class="n">nseed</span><span class="p">))</span>
	<span class="c">! ---  </span>
	<span class="c">! If seed1 = 0 then set seed1 randomly using the system clock.</span>
	<span class="c">! This will give different sequences of random numbers</span>
	<span class="c">! from different runs, so results are not reproducible.</span>
	<span class="c">! ---</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seed1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		    call </span><span class="nb">system_clock</span><span class="p">(</span><span class="nb">count</span> <span class="o">=</span> <span class="n">clock</span><span class="p">)</span>
		    <span class="n">seed1</span> <span class="o">=</span> <span class="n">clock</span>
		<span class="n">endif</span>
	<span class="c">! ---</span>
	<span class="c">! If seed1 &gt; 0 then results will be reproducible since calling this</span>
	<span class="c">! twice with the same seed will initialize the random</span>
	<span class="c">! number generator so the same sequence is generated.</span>
	<span class="c">! Once seed1 is set, set the other elements of the seed array by adding</span>
	<span class="c">! multiples of 37 as suggested in the documentation. </span>
	<span class="c">! --- </span>
		<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nseed</span>
		    <span class="n">seed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">seed1</span> <span class="o">+</span> <span class="mi">37</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
		<span class="n">enddo</span>
	<span class="c">! ---</span>
	<span class="c">! Seed the generator</span>
	<span class="c">! ---</span>
		<span class="k">call </span><span class="nb">random_seed</span><span class="p">(</span><span class="n">put</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Deallocate the seed</span>
	<span class="c">! ---</span>
		<span class="k">deallocate</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

	<span class="k">end subroutine </span><span class="n">init_random_seed</span>

<span class="k">end module </span><span class="n">random_util</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This program computes the Monte Carlo Integral by doubling the number</span>
<span class="c">! of points every time</span>
<span class="c">! ---</span>
<span class="k">program </span><span class="n">test_quad_mc</span>
<span class="c">! ---</span>
<span class="c">! Uses functions, quadrature_mc and random_util modules</span>
<span class="c">! ---</span>
	<span class="k">use </span><span class="n">functions</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">g</span><span class="p">,</span> <span class="n">gevals</span>
    <span class="k">use </span><span class="n">quadrature_mc</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">quad_mc</span>
    <span class="k">use </span><span class="n">random_util</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">init_random_seed</span>
<span class="c">! ---</span>
<span class="c">! Declare the parameters</span>
<span class="c">! ---</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ndim</span> <span class="o">=</span> <span class="mi">20</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(</span><span class="n">ndim</span><span class="p">)</span> <span class="kd">::</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">volume</span><span class="p">,</span> <span class="n">int_true</span><span class="p">,</span> <span class="n">int_mc</span><span class="p">,</span> <span class="n">int_mc_total</span><span class="p">,</span> <span class="n">error</span>
    <span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">seed1</span><span class="p">,</span> <span class="n">n_total</span><span class="p">,</span> <span class="n">npoints</span>
<span class="c">! ---</span>
<span class="c">! Need to initialize number of g evaulations to zero, because it&#39;s a module variable</span>
<span class="c">! ---</span>
    <span class="n">gevals</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c">! ---</span>
<span class="c">! Open a file to write to</span>
<span class="c">! ---</span>
    <span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;mc_quad_error.txt&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
<span class="c">! ---</span>
<span class="c">! a and b are the vectors for the integral limits in all dimensions</span>
<span class="c">! and are the same in all directions</span>
<span class="c">! ---</span>
    <span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ndim</span>
        <span class="n">a</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">2.</span><span class="n">d0</span>
        <span class="n">b</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="mf">4.</span><span class="n">d0</span>
    <span class="n">enddo</span>
<span class="c">! ---</span>
<span class="c">! Compute the true integral for special case where</span>
<span class="c">! g(x) = sum(x**2) over all dimensions</span>
<span class="c">! True integral = base * height, </span>
<span class="c">! where height is the sum of the average value of the true integral in all dimensions</span>
<span class="c">! ---</span>
    <span class="n">volume</span> <span class="o">=</span> <span class="nb">product</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span>  <span class="c">! =  product of b(i)-a(i) of ndim dimensions</span>
    <span class="n">int_true</span> <span class="o">=</span> <span class="p">(</span><span class="n">volume</span><span class="p">)</span> <span class="o">*</span> <span class="nb">sum</span><span class="p">((</span><span class="n">b</span><span class="o">**</span><span class="mi">3</span> <span class="o">-</span> <span class="n">a</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.</span><span class="n">d0</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)))</span>

    <span class="k">print</span> <span class="s1">&#39;(&quot;Testing Monte Carlo quadrature in &quot;,i2,&quot; dimensions&quot;)&#39;</span><span class="p">,</span> <span class="n">ndim</span>
    <span class="k">print</span> <span class="s1">&#39;(&quot;True integral: &quot;, es22.14)&#39;</span><span class="p">,</span> <span class="n">int_true</span>

<span class="c">! ---</span>
<span class="c">! Start with Monte Carlo using only a few points.</span>
<span class="c">! ---    </span>
	<span class="n">npoints</span> <span class="o">=</span> <span class="mi">10</span>
<span class="c">! ---</span>
<span class="c">! Loop to successively and double the number of points used:</span>
<span class="c">! ---</span>
	<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">17</span>
	<span class="c">! ---</span>
    <span class="c">! Compute integral using Monte Carlo method for a given set of points</span>
	<span class="c">! compute relative error and write these to file with number of points</span>
	<span class="c">! ---     </span>
   		<span class="n">int_mc</span> <span class="o">=</span> <span class="n">quad_mc</span><span class="p">(</span><span class="n">g</span><span class="p">,</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">ndim</span><span class="p">,</span><span class="n">npoints</span><span class="p">)</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">int_mc</span> <span class="o">-</span> <span class="n">int_true</span><span class="p">)</span> <span class="o">/</span> <span class="nb">abs</span><span class="p">(</span><span class="n">int_true</span><span class="p">)</span>
		<span class="k">write</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="s1">&#39;(i10,e23.15,e15.6)&#39;</span><span class="p">)</span> <span class="n">npoints</span><span class="p">,</span> <span class="n">int_mc</span><span class="p">,</span> <span class="n">error</span>
	<span class="c">! ---</span>
	<span class="c">! Double the number of points</span>
	<span class="c">! ---</span>
        <span class="n">npoints</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">npoints</span>
    <span class="n">enddo</span>

    <span class="k">print</span> <span class="s1">&#39;(&quot;Final approximation to integral: &quot;,es22.14)&#39;</span><span class="p">,</span><span class="n">int_mc</span>
    <span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Total g evaluations: &quot;</span><span class="p">,</span><span class="n">gevals</span>

<span class="k">end program </span><span class="n">test_quad_mc</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylab</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1"># read in three columns from file and unpack into 3 arrays:</span>
<span class="n">n</span><span class="p">,</span><span class="n">int_approx</span><span class="p">,</span><span class="n">error</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;mc_quad_error.txt&#39;</span><span class="p">,</span><span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">clf</span><span class="p">()</span>
<span class="n">loglog</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">error</span><span class="p">,</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Monte-Carlo&#39;</span><span class="p">)</span>
<span class="n">loglog</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">e7</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span><span class="p">)],</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;1 / sqrt(N)&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">()</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of MC points used&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;abs(error)&#39;</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s1">&#39;Log-log plot of relative error in MC quadrature&#39;</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;mc_quad_error.png&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="section" id="project-3-laplace-s-equation-and-the-monte-carlo-method">
<h2>3.9. Project 3: Laplace&#8217;s Equation and the Monte Carlo Method<a class="headerlink" href="#project-3-laplace-s-equation-and-the-monte-carlo-method" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>laplace_mc.py</strong> (python version)</li>
<li><strong>problem_description.f90, laplace_mc.f90, mc_walk.f90, random_util.f90, Makefile</strong> (compute the solution to Laplace&#8217;s Equation using the Monte Carlo Method - serial)</li>
<li><strong>test1.f90, test2.f90</strong> (trials I made along the way)</li>
<li><strong>plot_mc_quad_error.py</strong> (plot the result)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Random walk approximate solution to Laplace&#39;s equation u_{xx} + u{yy} = 0.</span>

<span class="sd">Set demo==True to plot a few random walks interactively.</span>
<span class="sd">With demo==False many more walks are used to estimate the solution.</span>

<span class="sd">The boundary conditions are set for this test problem by evaluating the</span>
<span class="sd">true solution u(x,y) = x^2 - y^2 of Laplace&#39;s equation on the</span>
<span class="sd">boundary of the domain.</span>

<span class="sd">Moreover, the exact solution to the discrete equations</span>
<span class="sd">  U_{i-1,j} + U_{i+1,j} + U_{i,j-1} + U_{i,j+1} - 4u_{ij} = 0</span>
<span class="sd">with boundary values obtained in this way is easily computed. It is simply</span>
<span class="sd">given by evaluating the exact solution at the grid points,</span>
<span class="sd">  U_{ij} = x_i^2 - y_j^2</span>
<span class="sd">This is because the centered difference approximation to the second</span>
<span class="sd">derivative is exact when applied to a quadratic function.</span>

<span class="sd">This code implements a random walk on a lattice (rectangular grid) where in</span>
<span class="sd">each step the walk goes in one of 4 directions based on the value of a</span>
<span class="sd">random number that&#39;s uniformly distributed in [0,1].</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">pylab</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">numpy.random</span> <span class="k">import</span> <span class="n">RandomState</span>
<span class="kn">import</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">sys</span>


<span class="c1"># Set plot_walk to:</span>
<span class="c1">#   True ==&gt; 10 walks will be done, plotting each for illustration.</span>
<span class="c1">#   False ==&gt; Many more walks taken to investigate convergence.</span>

<span class="n">plot_walk</span> <span class="o">=</span> <span class="kc">False</span>


<span class="c1"># problem description:</span>
<span class="n">ax</span> <span class="o">=</span> <span class="mf">0.</span>
<span class="n">bx</span> <span class="o">=</span> <span class="mf">1.</span>  
<span class="n">ay</span> <span class="o">=</span> <span class="mf">0.4</span>
<span class="n">by</span> <span class="o">=</span> <span class="mf">1.</span>

<span class="n">nx</span> <span class="o">=</span> <span class="mi">19</span>
<span class="n">ny</span> <span class="o">=</span> <span class="mi">11</span>

<span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">bx</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
<span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">by</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

<span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>     <span class="c1"># to turn on some additional printing</span>



<span class="k">def</span> <span class="nf">utrue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return true solution for a test case where this is known.</span>
<span class="sd">    This function should satisfy u_{xx} + u_{yy} = 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">utrue</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">utrue</span>


<span class="k">def</span> <span class="nf">uboundary</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return u(x,y) if (x,y) is on the boundary.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">bx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">by</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;*** Not on the boundary&quot;</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;*** uboundary called at non-boundary point&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nan</span>

    <span class="c1"># assume we know the true solution and can just evaluate there:</span>
    <span class="n">ub</span> <span class="o">=</span> <span class="n">utrue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>  
    <span class="k">return</span> <span class="n">ub</span>


<span class="k">def</span> <span class="nf">plot_initialize</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span><span class="n">j0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up plot for demo.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
    <span class="n">clf</span><span class="p">()</span>
    <span class="n">axes</span><span class="p">([</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span><span class="o">.</span><span class="mi">3</span><span class="p">,</span><span class="o">.</span><span class="mi">8</span><span class="p">,</span><span class="o">.</span><span class="mi">6</span><span class="p">])</span> <span class="c1"># leave room for printing messages</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span><span class="n">bx</span><span class="p">,</span><span class="n">nx</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">linspace</span><span class="p">(</span><span class="n">ay</span><span class="p">,</span><span class="n">by</span><span class="p">,</span><span class="n">ny</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span><span class="n">Y</span> <span class="o">=</span> <span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># turn into 2d arrays</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span><span class="n">Y</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">([</span><span class="n">ax</span><span class="o">+</span><span class="n">i0</span><span class="o">*</span><span class="n">dx</span><span class="p">],[</span><span class="n">ay</span><span class="o">+</span><span class="n">j0</span><span class="o">*</span><span class="n">dy</span><span class="p">],</span><span class="s1">&#39;ro&#39;</span><span class="p">)</span>
    <span class="n">axis</span><span class="p">(</span><span class="s1">&#39;scaled&#39;</span><span class="p">)</span>
    <span class="n">title</span><span class="p">(</span><span class="s2">&quot;Initial point for random walk&quot;</span><span class="p">)</span>
    <span class="n">draw</span><span class="p">()</span>
    <span class="n">show</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># pause to see the initial location</span>
    

<span class="k">def</span> <span class="nf">plot_ub</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">ub</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called when we hit the boundary</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plot</span><span class="p">([</span><span class="n">xb</span><span class="p">],</span> <span class="p">[</span><span class="n">yb</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
    <span class="n">text</span><span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="s1">&#39;Hit boundary where u = </span><span class="si">%9.6f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">ub</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
    <span class="n">draw</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plot_step</span><span class="p">(</span><span class="n">iold</span><span class="p">,</span> <span class="n">jold</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">istep</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Called each step of the random walk to plot progress</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># plot next segment of walk and new point in red:</span>
    <span class="n">plot</span><span class="p">([</span><span class="n">ax</span><span class="o">+</span><span class="n">iold</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">ax</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">dx</span><span class="p">],</span> <span class="p">[</span><span class="n">ay</span><span class="o">+</span><span class="n">jold</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span> <span class="n">ay</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">dy</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">([</span><span class="n">ax</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">dx</span><span class="p">],</span> <span class="p">[</span><span class="n">ay</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">dy</span><span class="p">],</span> <span class="s1">&#39;ro&#39;</span><span class="p">)</span>
    <span class="n">title</span><span class="p">(</span><span class="s2">&quot;After </span><span class="si">%6i</span><span class="s2"> random steps&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">istep</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">draw</span><span class="p">()</span>

    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="c1"># redraw last segment and point in blue:</span>
    <span class="n">plot</span><span class="p">([</span><span class="n">ax</span><span class="o">+</span><span class="n">iold</span><span class="o">*</span><span class="n">dx</span><span class="p">,</span> <span class="n">ax</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">dx</span><span class="p">],</span> <span class="p">[</span><span class="n">ay</span><span class="o">+</span><span class="n">jold</span><span class="o">*</span><span class="n">dy</span><span class="p">,</span> <span class="n">ay</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">dy</span><span class="p">],</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">plot</span><span class="p">([</span><span class="n">ax</span><span class="o">+</span><span class="n">i</span><span class="o">*</span><span class="n">dx</span><span class="p">],</span> <span class="p">[</span><span class="n">ay</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">dy</span><span class="p">],</span> <span class="s1">&#39;bo&#39;</span><span class="p">)</span>
    <span class="n">draw</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">random_walk</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Take one random walk starting at (i0,j0) until we reach the boundary or</span>
<span class="sd">    exceed max_steps steps.</span>
<span class="sd">    Return the value at the boundary point reached, or nan if we failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># starting point:</span>
    <span class="n">i</span> <span class="o">=</span> <span class="n">i0</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">j0</span>
    <span class="k">if</span> <span class="n">plot_walk</span><span class="p">:</span>
        <span class="n">plot_initialize</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>

    <span class="c1"># generate as many random numbers as we could possibly need</span>
    <span class="c1"># for this walk, since this is much faster than generating one at a time:</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">random_generator</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">max_steps</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;+++ generated r: &quot;</span><span class="p">,</span> <span class="n">r</span>
    

    <span class="k">for</span> <span class="n">istep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_steps</span><span class="p">):</span>
        <span class="n">iold</span><span class="p">,</span><span class="n">jold</span> <span class="o">=</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span>  <span class="c1"># needed for plotting only</span>
    
        <span class="c1"># Take the next random step with equal probability in each</span>
        <span class="c1"># direction:</span>

        <span class="k">if</span> <span class="n">r</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.25</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>   <span class="c1"># step left</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>   <span class="c1"># step right</span>
        <span class="k">elif</span> <span class="n">r</span><span class="p">[</span><span class="n">istep</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.75</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>   <span class="c1"># step down</span>
        <span class="k">else</span><span class="p">:</span>   
            <span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>   <span class="c1"># step up</span>

        <span class="k">if</span> <span class="n">plot_walk</span><span class="p">:</span>
            <span class="n">plot_step</span><span class="p">(</span><span class="n">iold</span><span class="p">,</span><span class="n">jold</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">istep</span><span class="p">)</span>

        <span class="c1"># check if we hit the boundary:</span>
        <span class="k">if</span> <span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">j</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">xb</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">dx</span>
            <span class="n">yb</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">dy</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">uboundary</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">plot_walk</span><span class="p">:</span>
                <span class="n">plot_ub</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">ub</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Hit boundary at (</span><span class="si">%7.3f</span><span class="s2">, </span><span class="si">%7.3f</span><span class="s2">) after </span><span class="si">%i</span><span class="s2">7 steps, ub = </span><span class="si">%7.3f</span><span class="s2">&quot;</span> \
                       <span class="o">%</span> <span class="p">(</span><span class="n">xb</span><span class="p">,</span><span class="n">yb</span><span class="p">,</span><span class="n">istep</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">ub</span><span class="p">)</span>
            <span class="k">break</span>  <span class="c1"># end the walk</span>

        <span class="k">if</span> <span class="n">istep</span><span class="o">==</span><span class="p">(</span><span class="n">max_steps</span><span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;Did not hit boundary after </span><span class="si">%i</span><span class="s2"> steps&quot;</span> <span class="o">%</span> <span class="n">max_steps</span>
            <span class="k">if</span> <span class="n">plot_walk</span><span class="p">:</span>
                <span class="n">text</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="s2">&quot;Did not hit boundary after </span><span class="si">%i</span><span class="s2"> steps&quot;</span> \
                        <span class="o">%</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
                <span class="n">draw</span><span class="p">()</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ub</span> <span class="o">=</span> <span class="n">nan</span>
            
    <span class="k">return</span> <span class="n">ub</span>


<span class="k">def</span> <span class="nf">many_walks</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span><span class="p">):</span>

    <span class="n">ub_sum</span> <span class="o">=</span> <span class="mf">0.</span>   <span class="c1"># to accumulate boundary values reached from all walks</span>
    <span class="n">n_success</span> <span class="o">=</span> <span class="mi">0</span>    <span class="c1"># to keep track of how many walks reached boundary</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_mc</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">i0</span>
        <span class="n">j</span> <span class="o">=</span> <span class="n">j0</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">random_walk</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">isnan</span><span class="p">(</span><span class="n">ub</span><span class="p">):</span>
            <span class="c1"># use this result unless walk didn&#39;t reach boundary</span>
            <span class="n">ub_sum</span> <span class="o">+=</span> <span class="n">ub</span>
            <span class="n">n_success</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">u_mc</span> <span class="o">=</span> <span class="n">ub_sum</span> <span class="o">/</span> <span class="n">n_success</span>   <span class="c1"># average over successful walks</span>

    <span class="k">return</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">n_success</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    
    <span class="c1"># MAIN PROGRAM</span>
    
    <span class="c1"># Try it out from a specific (x0,y0):</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.9</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.6</span>
    
    <span class="n">i0</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span>
    <span class="n">j0</span> <span class="o">=</span> <span class="nb">round</span><span class="p">((</span><span class="n">y0</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

    <span class="c1"># shift (x0,y0) to a grid point if it wasn&#39;t already:</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">i0</span><span class="o">*</span><span class="n">dx</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">+</span> <span class="n">j0</span><span class="o">*</span><span class="n">dy</span>

    <span class="n">u_true</span> <span class="o">=</span> <span class="n">utrue</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;True solution of PDE: u(</span><span class="si">%7.3f</span><span class="s2">, </span><span class="si">%7.3f</span><span class="s2">) = </span><span class="si">%9.5f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">,</span><span class="n">u_true</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;Note: with solution used in demo this is also the solution to the&quot;</span>
    <span class="nb">print</span> <span class="s2">&quot;      the finite-difference equations on the same grid.&quot;</span>

    <span class="n">ans</span> <span class="o">=</span> <span class="n">raw_input</span><span class="p">(</span><span class="s2">&quot;Enter seed for random generator or &lt;return&gt; .... &quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ans</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span>       <span class="c1"># will cause a random seed to be used</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">seed</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>   <span class="c1"># convert string returned from raw_input into integer</span>

    <span class="n">random_generator</span> <span class="o">=</span> <span class="n">RandomState</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>  

    <span class="c1"># maximum number of step in each before giving up:</span>
    <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>

    <span class="c1"># initial number of Monte-Carlo walks to take:</span>
    <span class="n">n_mc</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="n">u_mc</span><span class="p">,</span> <span class="n">n_success</span> <span class="o">=</span> <span class="n">many_walks</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span><span class="p">)</span>

    <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">u_mc</span> <span class="o">-</span> <span class="n">u_true</span><span class="p">)</span> <span class="o">/</span> <span class="n">u_true</span><span class="p">)</span>

    <span class="nb">print</span> <span class="s2">&quot;After </span><span class="si">%8i</span><span class="s2"> random walks, u = </span><span class="si">%15.9f</span><span class="s2">, rel. error = </span><span class="si">%15.6e</span><span class="s2">&quot;</span> \
            <span class="o">%</span> <span class="p">(</span><span class="n">n_success</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">plot_walk</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>   <span class="c1"># quit after a few walks</span>

    <span class="c1"># start accumulating totals:</span>
    <span class="n">u_mc_total</span> <span class="o">=</span> <span class="n">u_mc</span>
    <span class="n">n_total</span> <span class="o">=</span> <span class="n">n_success</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">):</span>
        <span class="n">u_sum_old</span> <span class="o">=</span> <span class="n">u_mc_total</span> <span class="o">*</span> <span class="n">n_total</span>
        <span class="n">u_mc</span><span class="p">,</span> <span class="n">n_success</span> <span class="o">=</span> <span class="n">many_walks</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span><span class="p">)</span>
        <span class="n">u_sum_new</span> <span class="o">=</span> <span class="n">u_mc</span> <span class="o">*</span> <span class="n">n_success</span>
        <span class="n">n_total</span> <span class="o">=</span> <span class="n">n_total</span> <span class="o">+</span> <span class="n">n_success</span>
        <span class="n">u_mc_total</span> <span class="o">=</span> <span class="p">(</span><span class="n">u_sum_old</span> <span class="o">+</span> <span class="n">u_sum_new</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_total</span>
        <span class="n">error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">((</span><span class="n">u_mc_total</span> <span class="o">-</span> <span class="n">u_true</span><span class="p">)</span> <span class="o">/</span> <span class="n">u_true</span><span class="p">)</span>

        <span class="nb">print</span> <span class="s2">&quot;After </span><span class="si">%8i</span><span class="s2"> random walks, u = </span><span class="si">%15.9f</span><span class="s2">, rel. error = </span><span class="si">%15.6e</span><span class="s2">&quot;</span> \
                <span class="o">%</span> <span class="p">(</span><span class="n">n_total</span><span class="p">,</span> <span class="n">u_mc_total</span><span class="p">,</span> <span class="n">error</span><span class="p">)</span>
        <span class="n">n_mc</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">n_mc</span>   <span class="c1"># double number of trials for next iteration</span>
        
        

</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span>OBJECTS = random_util.o problem_description.o mc_walk.o test1.o
OBJECTS2 = random_util.o problem_description.o mc_walk.o test2.o
OBJECTS3 = random_util.o problem_description.o mc_walk.o laplace_mc.o
FFLAGS = 

.PHONY: test test2 laplace

test: test.exe
	./test.exe

test2: test2.exe
	./test2.exe

laplace: laplace.exe
	./laplace.exe

test.exe: $(OBJECTS)
	gfortran $(FFLAGS) $(OBJECTS) -o test.exe

test2.exe: $(OBJECTS2)
	gfortran $(FFLAGS) $(OBJECTS2) -o test2.exe

laplace.exe: $(OBJECTS3)
	gfortran $(FFLAGS) $(OBJECTS3) -o laplace.exe

%.o : %.f90
	gfortran $(FFLAGS) -c  $&lt; 

clean:
	rm -f *.o *.exe *.mod

</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">module </span><span class="n">problem_description</span>

    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ax</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">d0</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">bx</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">d0</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ay</span> <span class="o">=</span> <span class="mf">0.4</span><span class="n">d0</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">by</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">d0</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">19</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ny</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">bx</span> <span class="o">-</span> <span class="n">ax</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">by</span> <span class="o">-</span> <span class="n">ay</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
	<span class="k">save</span>

<span class="k">contains</span>

<span class="k">	function </span><span class="n">utrue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

		<span class="c">! True solution for comparison, if known.</span>

		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">utrue</span>

		<span class="n">utrue</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span>

	<span class="k">end function </span><span class="n">utrue</span>

	<span class="k">function </span><span class="n">uboundary</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

		<span class="c">! Return u(x,y) assuming (x,y) is a boundary point.</span>

		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uboundary</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">bx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">by</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mf">0.</span><span class="n">d0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		    print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;*** Error -- called uboundary at non-boundary point&quot;</span>
		    <span class="k">stop</span>
<span class="k">		    </span><span class="n">endif</span>

		<span class="n">uboundary</span> <span class="o">=</span> <span class="n">utrue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>   <span class="c">! assuming we know this</span>

	<span class="k">end function </span><span class="n">uboundary</span>
    
<span class="k">end module </span><span class="n">problem_description</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">laplace_mc</span>
<span class="c">! ---</span>
<span class="c">! Uses random seed module</span>
<span class="c">! ---</span>
	<span class="k">use </span><span class="n">mc_walk</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">random_walk</span><span class="p">,</span> <span class="n">many_walks</span><span class="p">,</span> <span class="n">nwalks</span>
	<span class="k">use </span><span class="n">problem_description</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">utrue</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>

		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">rel_error</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span>

		<span class="c">! Try it out from a specific (x0,y0):</span>
		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.9</span>
		<span class="n">y0</span> <span class="o">=</span> <span class="mf">0.6</span>
		
		<span class="n">i0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span>
		<span class="n">j0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">y0</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

		<span class="c">! shift (x0,y0) to a grid point if it wasn&#39;t already:</span>
		<span class="n">x0</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">i0</span><span class="o">*</span><span class="n">dx</span>
		<span class="n">y0</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">+</span> <span class="n">j0</span><span class="o">*</span><span class="n">dy</span>

		<span class="n">u_true</span> <span class="o">=</span> <span class="n">utrue</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span>
		<span class="c">!nwalks = 0</span>
		<span class="n">n_mc</span> <span class="o">=</span> <span class="mi">10</span>
    	<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
		<span class="c">! do i=1,13</span>
		<span class="c">! call many_walks(i0, j0, max_steps, n_mc, u_mc, n_success)</span>

		<span class="c">! ---</span>
		<span class="c">! Open a file to write to</span>
		<span class="c">! ---</span>
    		<span class="k">open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;laplace_mc.txt&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
		<span class="c">!rel_error = abs(u_true-u_mc)/u_true</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot; True solution of PDE at x =&quot;,f10.4,&quot; y =&quot;,f10.4)&#39;</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot; u_true =   &quot;,es13.3)&#39;</span><span class="p">,</span> <span class="n">u_true</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;    Walks    Monte Carlo Solution    Relative Error&quot;</span>
		<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span>
			<span class="n">nwalks</span><span class="o">=</span><span class="mi">0</span>
			<span class="k">call </span><span class="n">many_walks</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">)</span>
			<span class="n">n_mc</span> <span class="o">=</span> <span class="mf">2.0</span><span class="n">d0</span> <span class="o">*</span> <span class="n">n_mc</span>
			<span class="n">rel_error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">u_true</span><span class="o">-</span><span class="n">u_mc</span><span class="p">)</span><span class="o">/</span><span class="n">u_true</span>
			<span class="k">print</span> <span class="s1">&#39;(&quot;  &quot;,i8,&quot;      &quot;,es13.3,&quot;        &quot;,es13.3)&#39;</span><span class="p">,</span> <span class="n">nwalks</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">rel_error</span>
			<span class="k">write</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="s1">&#39;(i10,e23.15,e15.6)&#39;</span><span class="p">)</span> <span class="n">nwalks</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">rel_error</span>
		<span class="n">enddo</span>
<span class="k">end program </span><span class="n">laplace_mc</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This has two functions random_walk and many_walks</span>
<span class="c">! ---</span>
<span class="k">module </span><span class="n">mc_walk</span>
<span class="c">! ---</span>
<span class="c">! Uses random seed module</span>
<span class="c">! ---</span>
	<span class="k">use </span><span class="n">random_util</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">init_random_seed</span>
	<span class="k">use </span><span class="n">problem_description</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">uboundary</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span>
<span class="c">! ---</span>
<span class="c">! nwalks is a module variable</span>
<span class="c">! Example use: use mc_walk, only nwalks</span>
<span class="c">! ---</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">nwalks</span>
	<span class="c">!integer :: iabort </span>
    <span class="k">save</span>

<span class="k">contains</span>

<span class="c">! ---</span>
<span class="c">! A single random walk</span>
<span class="c">! Inputs: i (step in x), j (step in y), max_steps (maximum number of steps)</span>
<span class="c">! Outputs: ub (value at boundary), iabort (0 for success, 1 for failure)</span>
<span class="c">! Example use: ub, iabort = random_walk(0, 0, 100, ub, iabort) </span>
<span class="c">!     </span>
<span class="c">!    i:  0,  1,.. nx, nx+1</span>
<span class="c">! j:</span>
<span class="c">! 0,   (BC) (BC) (BC) (BC)</span>
<span class="c">! 1,   (BC)           (BC)</span>
<span class="c">! ...  (BC)           (BC)</span>
<span class="c">! nj   (BC)           (BC)</span>
<span class="c">! nj+1 (BC) (BC) (BC) (BC)</span>
<span class="c">! ---</span>
	<span class="k">subroutine </span><span class="n">random_walk</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">iabort</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Declare parameters</span>
	<span class="c">! ---</span>
		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span> 	<span class="c">! i0 and j0 are inputs (static)</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> 							<span class="c">! i and j are dummy variables</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ub</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iabort</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">x</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">istep</span><span class="p">,</span> <span class="n">seed1</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span>
	<span class="c">! ---</span>
	<span class="c">! Number of steps is unknown, so we must allocate:</span>
	<span class="c">! ---</span>
		<span class="k">allocate</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">max_steps</span><span class="p">))</span> <span class="c">! random number array 0 to 1 </span>
	<span class="c">! ---</span>
	<span class="c">! Generate random number array x (0 to 1)</span>
	<span class="c">! ---</span>
		<span class="n">seed1</span> <span class="o">=</span> <span class="mi">0</span>   <span class="c">! seed1 = 12345 for repeatable seed</span>
						<span class="c">! seed1 = 0 for random seed</span>
		<span class="k">call </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
		<span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">i0</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">j0</span>
		<span class="c">!nwalks = 0</span>
	<span class="c">! ---</span>
	<span class="c">! Go through the vector of random numbers and</span>
	<span class="c">! make moves depending on the value of x</span>
	<span class="c">! ---</span>
		<span class="k">do </span><span class="n">istep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">max_steps</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span> <span class="p">.</span><span class="n">LT</span><span class="p">.</span> <span class="mf">0.25</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>    <span class="c">! go left</span>
				<span class="c">! print *, &quot;go left&quot;</span>
				<span class="c">! print *, &quot;i=&quot;, i</span>
				<span class="c">! print *, &quot;istep=&quot;, istep</span>
				<span class="c">! print *, &quot;x=&quot;, x(istep)</span>
			<span class="k">else if</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span> <span class="p">.</span><span class="n">LT</span><span class="p">.</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>    <span class="c">! go right</span>
				<span class="c">! print *, &quot;go right&quot;</span>
				<span class="c">! print *, &quot;i=&quot;, i</span>
				<span class="c">! print *, &quot;istep=&quot;, istep</span>
				<span class="c">! print *, &quot;x=&quot;, x(istep)</span>
			<span class="k">else if</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span> <span class="p">.</span><span class="n">LT</span><span class="p">.</span> <span class="mf">0.75</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>    <span class="c">! go down</span>
				<span class="c">! print *, &quot;go up&quot;</span>
				<span class="c">! print *, &quot;j=&quot;, j</span>
				<span class="c">! print *, &quot;istep=&quot;, istep</span>
				<span class="c">! print *, &quot;x=&quot;, x(istep)</span>
			<span class="k">else</span>
<span class="k">				</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>    <span class="c">! go up</span>
				<span class="c">! print *, &quot;go down&quot;</span>
				<span class="c">! print *, &quot;j=&quot;, j</span>
				<span class="c">! print *, &quot;istep=&quot;, istep</span>
				<span class="c">! print *, &quot;x=&quot;, x(istep)</span>
			<span class="n">endif</span>
		
		<span class="c">! ---</span>
		<span class="c">! What if we are at the boundary?</span>
		<span class="c">! ---			</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
				<span class="c">! print *, &quot;we are at the boundary&quot;</span>
				<span class="c">! print *, &quot; &quot;</span>
				<span class="n">xb</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">dx</span> 			<span class="c">! x is ax or ax+i*dx</span>
				<span class="n">yb</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">dy</span>			<span class="c">! y is ay or ay+j*dy</span>
				<span class="c">! print *, &quot;xb=&quot;,xb</span>
				<span class="c">! print *, &quot;yb=&quot;,yb</span>
				<span class="n">ub</span> <span class="o">=</span> <span class="n">uboundary</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>	<span class="c">! the boundary value is then computed</span>
				<span class="n">iabort</span> <span class="o">=</span> <span class="mi">0</span>				<span class="c">! success</span>
				<span class="n">go</span> <span class="n">to</span> <span class="mi">99</span>				<span class="c">! end do loop</span>
			<span class="n">endif</span>
		<span class="c">! ---</span>
		<span class="c">! What if we never reach the boundary within max steps?		</span>
		<span class="c">! ---</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">istep</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="n">max_steps</span><span class="p">)</span> <span class="k">then</span> 
			<span class="c">! 	print *, &quot;we aborted&quot;</span>
			<span class="c">! 	print *, &quot; &quot;</span>
				<span class="n">ub</span> <span class="o">=</span> <span class="mi">0</span>					<span class="c">! set ub to zero</span>
				<span class="n">iabort</span> <span class="o">=</span> <span class="mi">1</span>				<span class="c">! failure</span>
			<span class="n">endif</span>
		<span class="n">enddo</span>

<span class="mi">99</span>  <span class="k">continue</span>


<span class="k">	end subroutine </span><span class="n">random_walk</span> 

	<span class="k">subroutine </span><span class="n">many_walks</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Declare parameters</span>
	<span class="c">! ---</span>
		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span> 		<span class="c">! i0 and j0 are inputs (static)</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n_mc</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iabort</span> <span class="c">!, nwalks		! i and j are dummy variables</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u_mc</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n_success</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ub_sum</span><span class="p">,</span> <span class="n">ub</span>

		<span class="n">ub_sum</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">n_success</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="c">!nwalks = 0</span>
		<span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_mc</span>
			<span class="c">!nwalks = 0</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">i0</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">j0</span>
			<span class="k">call </span><span class="n">random_walk</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">iabort</span><span class="p">)</span>
			<span class="k">if</span><span class="p">(</span><span class="n">iabort</span> <span class="p">.</span><span class="n">NE</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="n">ub_sum</span> <span class="o">=</span> <span class="n">ub_sum</span> <span class="o">+</span> <span class="n">ub</span>
				<span class="n">n_success</span> <span class="o">=</span> <span class="n">n_success</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="n">nwalks</span> <span class="o">=</span> <span class="n">nwalks</span> <span class="o">+</span><span class="mi">1</span>	
			<span class="n">endif</span>
			<span class="n">u_mc</span> <span class="o">=</span> <span class="n">ub_sum</span><span class="o">/</span><span class="n">n_success</span>
	
		<span class="n">enddo</span>

	<span class="k">end subroutine </span><span class="n">many_walks</span>

<span class="k">end module </span><span class="n">mc_walk</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This module returns seed for the random_number function</span>
<span class="c">! ---</span>
<span class="k">module </span><span class="n">random_util</span>

<span class="k">contains</span>

<span class="k">	subroutine </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Declare the parameters</span>
	<span class="c">! ---</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">seed1</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">clock</span> 
		<span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">seed</span>
	<span class="c">! ---</span>
	<span class="c">! Determine how many numbers needed to seed and allocate</span>
	<span class="c">! ---</span>
		<span class="k">call </span><span class="nb">random_seed</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">nseed</span><span class="p">)</span>  
		<span class="k">allocate</span><span class="p">(</span><span class="n">seed</span><span class="p">(</span><span class="n">nseed</span><span class="p">))</span>
	<span class="c">! ---  </span>
	<span class="c">! If seed1 = 0 then set seed1 randomly using the system clock.</span>
	<span class="c">! This will give different sequences of random numbers</span>
	<span class="c">! from different runs, so results are not reproducible.</span>
	<span class="c">! ---</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seed1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		    call </span><span class="nb">system_clock</span><span class="p">(</span><span class="nb">count</span> <span class="o">=</span> <span class="n">clock</span><span class="p">)</span>
		    <span class="n">seed1</span> <span class="o">=</span> <span class="n">clock</span>
		<span class="n">endif</span>
	<span class="c">! ---</span>
	<span class="c">! If seed1 &gt; 0 then results will be reproducible since calling this</span>
	<span class="c">! twice with the same seed will initialize the random</span>
	<span class="c">! number generator so the same sequence is generated.</span>
	<span class="c">! Once seed1 is set, set the other elements of the seed array by adding</span>
	<span class="c">! multiples of 37 as suggested in the documentation. </span>
	<span class="c">! --- </span>
		<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nseed</span>
		    <span class="n">seed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">seed1</span> <span class="o">+</span> <span class="mi">37</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
		<span class="n">enddo</span>
	<span class="c">! ---</span>
	<span class="c">! Seed the generator</span>
	<span class="c">! ---</span>
		<span class="k">call </span><span class="nb">random_seed</span><span class="p">(</span><span class="n">put</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Deallocate the seed</span>
	<span class="c">! ---</span>
		<span class="k">deallocate</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

	<span class="k">end subroutine </span><span class="n">init_random_seed</span>

<span class="k">end module </span><span class="n">random_util</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test1</span>
<span class="c">! ---</span>
<span class="c">! Uses random seed module</span>
<span class="c">! ---</span>
	<span class="k">use </span><span class="n">mc_walk</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">random_walk</span><span class="p">,</span> <span class="n">nwalks</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ub</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">iabort</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span>
 		<span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">19</span>
    	<span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ny</span> <span class="o">=</span> <span class="mi">11</span>
		<span class="c">! range of i is 1 to nx</span>
		<span class="c">! range of j is 1 to nj</span>
		
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
    	<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
		<span class="k">call </span><span class="n">random_walk</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">iabort</span><span class="p">)</span> 
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;ub=&quot;</span><span class="p">,</span> <span class="n">ub</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;iabort=&quot;</span><span class="p">,</span> <span class="n">iabort</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;nwalks=&quot;</span><span class="p">,</span> <span class="n">nwalks</span>

<span class="k">end program </span><span class="n">test1</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test2</span>
<span class="c">! ---</span>
<span class="c">! Uses random seed module</span>
<span class="c">! ---</span>
	<span class="k">use </span><span class="n">mc_walk</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">random_walk</span><span class="p">,</span> <span class="n">many_walks</span><span class="p">,</span> <span class="n">nwalks</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u_mc</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span>
 		<span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">19</span>
    	<span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ny</span> <span class="o">=</span> <span class="mi">11</span>
		<span class="c">! range of i is 1 to nx</span>
		<span class="c">! range of j is 1 to nj</span>
		
		<span class="n">i</span> <span class="o">=</span> <span class="mi">1</span>
		<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span>
    	<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
		<span class="k">call </span><span class="n">many_walks</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">)</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;u_mc=&quot;</span><span class="p">,</span> <span class="n">u_mc</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;n_success=&quot;</span><span class="p">,</span> <span class="n">n_success</span>

<span class="k">end program </span><span class="n">test2</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylab</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1"># read in three columns from file and unpack into 3 arrays:</span>
<span class="n">n</span><span class="p">,</span><span class="n">int_approx</span><span class="p">,</span><span class="n">error</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;laplace_mc.txt&#39;</span><span class="p">,</span><span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">clf</span><span class="p">()</span>
<span class="n">loglog</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">error</span><span class="p">,</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Monte-Carlo&#39;</span><span class="p">)</span>
<span class="n">loglog</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">e7</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span><span class="p">)],</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;1 / sqrt(N)&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">()</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of MC points used&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;abs(error)&#39;</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s1">&#39;Log-log plot of relative error in MC quadrature&#39;</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;mc_quad_error.png&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="section" id="project-4-laplace-s-equation-mpi-and-the-monte-carlo-method">
<h2>3.10. Project 4: Laplace&#8217;s Equation, MPI and the Monte Carlo Method<a class="headerlink" href="#project-4-laplace-s-equation-mpi-and-the-monte-carlo-method" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><strong>problem_description.f90, laplace_mc.f90, mc_walk.f90, random_util.f90, Makefile</strong> (compute the solution to Laplace&#8217;s Equation using the Monte Carlo Method - using MPI)</li>
<li><strong>test1.f90, test1b.f90, test2.f90</strong> (trials I made along the way)</li>
<li><strong>plot_mc_quad_error.py</strong> (plot the result)</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span></span># $MYHPSC/project/part4/Makefile

OBJECTS = random_util.o problem_description.o mc_walk.o laplace_mc.o
OBJECTS2 = random_util.o problem_description.o mc_walk.o test1.o
OBJECTS2b = random_util.o problem_description.o mc_walk.o test1b.o
OBJECTS3 = random_util.o problem_description.o mc_walk.o test2.o
NUMPROCS ?= 4
FLAGS ?= 

.PHONY: mpi laplace test1 test1b test2

mpi: testquad.exe
	mpiexec -n $(NUMPROCS) ./testquad.exe

test1: test1.exe
	./test1.exe

test1b: test1b.exe
	./test1b.exe

test2: test2.exe
	./test2.exe

testquad.exe: $(OBJECTS)
	mpif90 $(FLAGS) $(OBJECTS) -o testquad.exe

test1.exe: $(OBJECTS2)
	gfortran $(FFLAGS) $(OBJECTS2) -o test1.exe

test1b.exe: $(OBJECTS2b)
	gfortran $(FFLAGS) $(OBJECTS2b) -o test1b.exe

test2.exe: $(OBJECTS3)
	gfortran $(FFLAGS) $(OBJECTS3) -o test2.exe

%.o : %.f90
	mpif90 -c $(FLAGS) $&lt; 

laplace: laplace.exe
	./laplace.exe

laplace.exe: $(OBJECTS)
	gfortran $(FFLAGS) $(OBJECTS) -o laplace.exe

#%.o : %.f90
#	gfortran $(FFLAGS) -c  $&lt;

clean:
	rm -f *.o *.exe *.mod
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This module returns the true value and the value at the boundary</span>
<span class="c">! ---</span>
<span class="k">module </span><span class="n">problem_description</span>
<span class="c">! ---</span>
<span class="c">! Initilize parameters</span>
<span class="c">! ---</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ax</span> <span class="o">=</span> <span class="mf">0.0</span><span class="n">d0</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">bx</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">d0</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ay</span> <span class="o">=</span> <span class="mf">0.4</span><span class="n">d0</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">by</span> <span class="o">=</span> <span class="mf">1.0</span><span class="n">d0</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">nx</span> <span class="o">=</span> <span class="mi">19</span>
    <span class="kt">integer</span><span class="p">,</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">ny</span> <span class="o">=</span> <span class="mi">11</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">dx</span> <span class="o">=</span> <span class="p">(</span><span class="n">bx</span> <span class="o">-</span> <span class="n">ax</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">parameter</span> <span class="kd">::</span> <span class="n">dy</span> <span class="o">=</span> <span class="p">(</span><span class="n">by</span> <span class="o">-</span> <span class="n">ay</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
	<span class="k">save</span>

<span class="k">contains</span>
<span class="c">! ---</span>
<span class="c">! Function for the true solution (if known)</span>
<span class="c">! Inputs: x and y</span>
<span class="c">! Output: z</span>
<span class="c">! ---</span>
	<span class="k">function </span><span class="n">utrue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">utrue</span>

		<span class="n">utrue</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span>

	<span class="k">end function </span><span class="n">utrue</span>
<span class="c">! ---</span>
<span class="c">! Function for the value at the boundary</span>
<span class="c">! Inputs: x and y</span>
<span class="c">! Output: z</span>
<span class="c">! ---</span>
	<span class="k">function </span><span class="n">uboundary</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">uboundary</span>
	<span class="c">! ---</span>
	<span class="c">! If we are not at the boundary we print an error and stop</span>
	<span class="c">! ---</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">bx</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">by</span><span class="p">)</span> <span class="p">.</span><span class="n">ne</span><span class="p">.</span> <span class="mf">0.</span><span class="n">d0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		    print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;*** Error -- called uboundary at non-boundary point&quot;</span>
		    <span class="k">stop</span>
<span class="k">		</span><span class="n">endif</span>
	<span class="c">! ---</span>
	<span class="c">! If we are at the boundary we compute the solution</span>
	<span class="c">! ---</span>
		<span class="n">uboundary</span> <span class="o">=</span> <span class="n">utrue</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>   <span class="c">! assuming we know this</span>

	<span class="k">end function </span><span class="n">uboundary</span>
    
<span class="k">end module </span><span class="n">problem_description</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This program loops through the Monte Carlo solution of Laplace&#39;s equation,</span>
<span class="c">! doubling the number of sample points every loop using MPI</span>
<span class="c">! ---</span>
<span class="k">program </span><span class="n">laplace_mc</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: Modules and functions</span>
<span class="c">! ---</span>
    <span class="k">use </span><span class="n">mpi</span>
	<span class="k">use </span><span class="n">random_util</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">init_random_seed</span>
	<span class="k">use </span><span class="n">mc_walk</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">random_walk</span><span class="p">,</span> <span class="n">many_walks</span><span class="p">,</span> <span class="n">n_walks</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">n_success_proc</span>
	<span class="k">use </span><span class="n">problem_description</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">utrue</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: Parameters, vectors and arrays</span>
<span class="c">! ---	</span>
	<span class="k">implicit none</span>
<span class="k">	</span><span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">rel_error</span><span class="p">,</span> <span class="n">u_true</span>
	<span class="kt">integer</span> <span class="kd">::</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="p">&amp;</span>
	<span class="n">process_num</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">ierr</span><span class="p">,</span> <span class="p">&amp;</span>
	<span class="n">istep</span><span class="p">,</span> <span class="n">seed1</span><span class="p">,</span> <span class="n">n_success_total</span>
	<span class="kt">logical</span> <span class="kd">::</span> <span class="n">debug_many</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: Number of steps is unknown, so we must allocate -</span>
<span class="c">! 200000 is the maximum number of moves</span>
<span class="c">! ---</span>
	<span class="n">n_mc</span> <span class="o">=</span> <span class="mi">10</span>		<span class="c">! This must be at least 3 as there are 3 processes</span>
					<span class="c">! Use n_mc = 10 if not debugging random_walk</span>
	<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">200000</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
	<span class="k">allocate</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">max_steps</span><span class="p">))</span> <span class="c">! random number array 0 to 1 </span>
<span class="c">! ---- </span>
<span class="c">! ALL PROCESSES: Initialize MPI</span>
<span class="c">! ----</span>
    <span class="k">call </span><span class="n">MPI_INIT</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
    <span class="k">call </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">process_num</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span> 
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: Generate random number array x (0 to 1)</span>
<span class="c">! ---</span>
	<span class="n">seed1</span> <span class="o">=</span> <span class="mi">12345</span>   <span class="c">! seed1 = 12345 for repeatable seed</span>
					<span class="c">! seed1 = 0 for random seed</span>
	<span class="n">seed1</span> <span class="o">=</span> <span class="n">seed1</span> <span class="o">+</span> <span class="mi">97</span><span class="o">*</span><span class="n">process_num</span> 	<span class="c">! unique for each process</span>
	<span class="k">print</span> <span class="s1">&#39;(&quot; Seed for process&quot;,i2, &quot; is &quot;,i5)&#39;</span><span class="p">,</span> <span class="n">process_num</span><span class="p">,</span> <span class="n">seed1</span>
	<span class="k">call </span><span class="n">MPI_BARRIER</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span> <span class="c">! wait for processes to print</span>
	<span class="k">call </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
	<span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="c">! ----</span>
<span class="c">! ALL PROCESSES: Try it out from a specific (x0,y0):</span>
<span class="c">! ----</span>
	<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.9</span>
	<span class="n">y0</span> <span class="o">=</span> <span class="mf">0.6</span>
	<span class="n">i0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span>
	<span class="n">j0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">y0</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>
<span class="c">! ----</span>
<span class="c">! ALL PROCESSES: Shift (x0,y0) to a grid point if it wasn&#39;t already:</span>
<span class="c">! ----</span>
	<span class="n">x0</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">i0</span><span class="o">*</span><span class="n">dx</span>
	<span class="n">y0</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">+</span> <span class="n">j0</span><span class="o">*</span><span class="n">dy</span>
	<span class="n">u_true</span> <span class="o">=</span> <span class="n">utrue</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span>
	<span class="n">n_walks</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c">! ---</span>
<span class="c">! MASTER PROCESS: Open a file to write to, provide true solution and print output headers</span>
<span class="c">! ---</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">process_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		open</span><span class="p">(</span><span class="n">unit</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="k">file</span><span class="o">=</span><span class="s1">&#39;laplace_mc.txt&#39;</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s1">&#39;unknown&#39;</span><span class="p">)</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot; True solution of PDE at x =&quot;,f10.4,&quot; y =&quot;,f10.4)&#39;</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot; u_true =&quot;,e23.15)&#39;</span><span class="p">,</span> <span class="n">u_true</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;  Successes    Monte Carlo Solution   Relative Error&quot;</span>
	<span class="n">endif</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: Loop through and call many_walks, doubling the number</span>
<span class="c">! of Monte Carlo points by two each time</span>
<span class="c">! ---</span>
<span class="c">! MASTER PROCESS: Compute relative error and print output of many_walks  </span>
<span class="c">! ---</span>
	<span class="n">debug_many</span> <span class="o">=</span> <span class="p">.</span><span class="n">False</span><span class="p">.</span>		<span class="c">! Best to remove the do loop if you&#39;re trying this</span>
	<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span>
		<span class="k">call </span><span class="n">many_walks</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">debug_many</span><span class="p">)</span>
		<span class="n">n_mc</span> <span class="o">=</span> <span class="mf">2.0</span><span class="n">d0</span> <span class="o">*</span> <span class="n">n_mc</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">process_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			</span><span class="n">rel_error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">u_true</span><span class="o">-</span><span class="n">u_mc</span><span class="p">)</span><span class="o">/</span><span class="n">u_true</span>
			<span class="k">print</span> <span class="s1">&#39;(&quot;  &quot;,i10,&quot; &quot;,e23.15,&quot; &quot;,e23.15)&#39;</span><span class="p">,</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">rel_error</span>
			<span class="k">write</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="s1">&#39;(i10,e23.15,e15.6)&#39;</span><span class="p">)</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">rel_error</span>
		<span class="n">endif</span>
	<span class="n">enddo</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: Wait for process 0 to print</span>
<span class="c">! ---</span>
	<span class="k">call </span><span class="n">MPI_BARRIER</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span> 
<span class="c">! ---</span>
<span class="c">! MASTER PROCESS: Reduce n_success_proc to n_success_total  </span>
<span class="c">! ---</span>
	<span class="k">call </span><span class="n">MPI_REDUCE</span><span class="p">(</span><span class="n">n_success_proc</span><span class="p">,</span> <span class="n">n_success_total</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="p">&amp;</span>
		<span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="n">MPI_SUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
<span class="c">! ---</span>
<span class="c">! MASTER PROCESS: Reduce n_success_proc to n_success_total  </span>
<span class="c">! ---</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">process_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		print</span> <span class="s1">&#39;(&quot;Final approximation to u(x0,y0):&quot;,e23.15)&#39;</span><span class="p">,</span> <span class="n">u_mc</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot;Total number of walks by all processes:&quot;,i10)&#39;</span><span class="p">,</span> <span class="n">n_success_total</span>
	<span class="n">endif</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: Wait for process 0 to print</span>
<span class="c">! ---</span>
	<span class="k">call </span><span class="n">MPI_BARRIER</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span><span class="n">ierr</span><span class="p">)</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: Print out process number and number of successes</span>
<span class="c">! ---</span>
	<span class="k">print</span> <span class="s1">&#39;(&quot;Walks by process &quot;,i1,&quot;:&quot;,i8)&#39;</span><span class="p">,</span> <span class="n">process_num</span><span class="p">,</span> <span class="n">n_success_proc</span>
<span class="c">! ----</span>
<span class="c">! ALL PROCESSES: COMPLETE MPI</span>
<span class="c">! ----</span>
    <span class="k">call </span><span class="n">MPI_FINALIZE</span><span class="p">(</span><span class="n">ierr</span><span class="p">)</span>

<span class="k">end program </span><span class="n">laplace_mc</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This module performs a random walk and also many random walks</span>
<span class="c">! ---</span>
<span class="k">module </span><span class="n">mc_walk</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: Use random seed module &amp; mpi</span>
<span class="c">! ---</span>
 	<span class="k">use </span><span class="n">mpi</span>
	<span class="k">use </span><span class="n">problem_description</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">uboundary</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: nwalks &amp; n_success_proc are module variables</span>
<span class="c">! Example use: use mc_walk, only nwalks, n_success_proc</span>
<span class="c">! ---</span>
    <span class="k">implicit none</span>
<span class="k">    </span><span class="kt">integer</span> <span class="kd">::</span> <span class="n">n_walks</span><span class="p">,</span> <span class="n">n_success_proc</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">x</span>
    <span class="k">save</span>

<span class="k">contains</span>
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: A single random walk</span>
<span class="c">! Inputs: i0 (step in x), j0 (step in y), max_steps (maximum number of steps)</span>
<span class="c">! Outputs: ub (value at boundary), iabort (0 for success, 1 for failure)</span>
<span class="c">! Example use: random_walk(0, 0, 100, ub, iabort) </span>
<span class="c">!     </span>
<span class="c">!    i:  0,  1,.. nx, nx+1</span>
<span class="c">! j:</span>
<span class="c">! 0,   (BC) (BC) (BC) (BC)</span>
<span class="c">! 1,   (BC)           (BC)</span>
<span class="c">! ...  (BC)           (BC)</span>
<span class="c">! nj   (BC)           (BC)</span>
<span class="c">! nj+1 (BC) (BC) (BC) (BC)</span>
<span class="c">! ---</span>
	<span class="k">subroutine </span><span class="n">random_walk</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">iabort</span><span class="p">,</span> <span class="n">debug_random</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! ALL PROCESSES: Declare parameters</span>
	<span class="c">! ---</span>
		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span>
		<span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">debug_random</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ub</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">iabort</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">seed1</span><span class="p">,</span> <span class="n">start</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">xb</span><span class="p">,</span> <span class="n">yb</span>
	<span class="c">! ---</span>
	<span class="c">! ALL PROCESSES: Initialize the walk from it&#39;s starting point</span>
	<span class="c">! ---</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">i0</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">j0</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">n_walks</span>
	<span class="c">! ---</span>
	<span class="c">! ALL PROCESSES: Go through the vector of random numbers and</span>
	<span class="c">! make moves depending on the value of x</span>
	<span class="c">! ---</span>
		<span class="k">do </span><span class="n">istep</span><span class="o">=</span><span class="n">start</span><span class="p">,</span><span class="n">max_steps</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span> <span class="p">.</span><span class="n">LT</span><span class="p">.</span> <span class="mf">0.25</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">-</span><span class="mi">1</span>    <span class="c">! go left</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_random</span><span class="p">)</span> <span class="k">then</span>
<span class="k">					print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;go left&quot;</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;i=&quot;</span><span class="p">,</span> <span class="n">i</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;istep=&quot;</span><span class="p">,</span> <span class="n">istep</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;x=&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span>
				<span class="n">endif</span>
				<span class="n">n_walks</span> <span class="o">=</span> <span class="n">n_walks</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="k">else if</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span> <span class="p">.</span><span class="n">LT</span><span class="p">.</span> <span class="mf">0.5</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="n">i</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>    <span class="c">! go right</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_random</span><span class="p">)</span> <span class="k">then</span>
<span class="k">					print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;go right&quot;</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;i=&quot;</span><span class="p">,</span> <span class="n">i</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;istep=&quot;</span><span class="p">,</span> <span class="n">istep</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;x=&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span>
				<span class="n">endif</span>
				<span class="n">n_walks</span> <span class="o">=</span> <span class="n">n_walks</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="k">else if</span> <span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span> <span class="p">.</span><span class="n">LT</span><span class="p">.</span> <span class="mf">0.75</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span>    <span class="c">! go down</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_random</span><span class="p">)</span> <span class="k">then</span>
<span class="k">					print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;go up&quot;</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;j=&quot;</span><span class="p">,</span> <span class="n">j</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;istep=&quot;</span><span class="p">,</span> <span class="n">istep</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;x=&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span>
				<span class="n">endif</span>
				<span class="n">n_walks</span> <span class="o">=</span> <span class="n">n_walks</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="k">else</span>
<span class="k">				</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span><span class="o">+</span><span class="mi">1</span>    <span class="c">! go up</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_random</span><span class="p">)</span> <span class="k">then</span>
<span class="k">					print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;go down&quot;</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;j=&quot;</span><span class="p">,</span> <span class="n">j</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;istep=&quot;</span><span class="p">,</span> <span class="n">istep</span>
					<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;x=&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">(</span><span class="n">istep</span><span class="p">)</span>
				<span class="n">endif</span>
				<span class="n">n_walks</span> <span class="o">=</span> <span class="n">n_walks</span> <span class="o">+</span> <span class="mi">1</span>
			<span class="n">endif</span>
		<span class="c">! ---</span>
		<span class="c">! ALL PROCESSES: What if we are at the boundary?</span>
		<span class="c">! ---			</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				</span><span class="n">xb</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="n">dx</span> 			<span class="c">! x is ax or ax+i*dx</span>
				<span class="n">yb</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">+</span> <span class="n">j</span><span class="o">*</span><span class="n">dy</span>			<span class="c">! y is ay or ay+j*dy</span>
				<span class="n">ub</span> <span class="o">=</span> <span class="n">uboundary</span><span class="p">(</span><span class="n">xb</span><span class="p">,</span> <span class="n">yb</span><span class="p">)</span>	<span class="c">! the boundary value is then computed</span>
				<span class="n">iabort</span> <span class="o">=</span> <span class="mi">0</span>				<span class="c">! success</span>
				<span class="n">n_success_proc</span> <span class="o">=</span> <span class="n">n_success_proc</span> <span class="o">+</span> <span class="mi">1</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_random</span><span class="p">)</span> <span class="k">then</span>
<span class="k">					print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Reached the boundary&quot;</span>
				<span class="n">endif</span>				
				<span class="n">go</span> <span class="n">to</span> <span class="mi">99</span>				<span class="c">! end do loop</span>
			<span class="n">endif</span>
		<span class="c">! ---</span>
		<span class="c">! ALL PROCESSES: What if we never reach the boundary within max steps?		</span>
		<span class="c">! ---</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">istep</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="n">max_steps</span><span class="p">)</span> <span class="k">then </span>
<span class="k">				</span><span class="n">ub</span> <span class="o">=</span> <span class="mi">0</span>					<span class="c">! set ub to zero</span>
				<span class="n">iabort</span> <span class="o">=</span> <span class="mi">1</span>				<span class="c">! failure</span>
				<span class="n">n_success_proc</span> <span class="o">=</span> <span class="n">n_success_proc</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_random</span><span class="p">)</span> <span class="k">then</span>
<span class="k">					print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;Failed to reach boundary&quot;</span>
				<span class="n">endif</span>	
			<span class="n">endif</span>
		<span class="n">enddo</span>

<span class="mi">99</span>  <span class="k">continue</span>

<span class="k">	end subroutine </span><span class="n">random_walk</span> 
<span class="c">! ---</span>
<span class="c">! ALL PROCESSES: A single random walk</span>
<span class="c">! Inputs: i0 (step in x), j0 (step in y), max_steps (maximum number of steps)</span>
<span class="c">! Outputs: ub (value at boundary), iabort (0 for success, 1 for failure)</span>
<span class="c">! Example use: many_walks(0, 0, 100, ub, iabort)</span>
<span class="c">! ---</span>
	<span class="k">subroutine </span><span class="n">many_walks</span><span class="p">(</span><span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">debug_many</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! ALL PROCESSES: Declare parameters</span>
	<span class="c">! ---</span>
		<span class="k">implicit none</span>
<span class="k">		</span><span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u_mc</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="kd">::</span> <span class="n">n_success</span>
		<span class="kt">logical</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span> <span class="kd">::</span> <span class="n">debug_many</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ub_sum</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">answer_r</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span> <span class="k">allocatable</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:)</span> <span class="kd">::</span> <span class="n">int_array</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">iabort</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">process_num</span><span class="p">,</span> <span class="p">&amp;</span>
		<span class="n">ierr</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">sender</span><span class="p">,</span> <span class="n">iabort_r</span><span class="p">,</span> <span class="n">answer</span><span class="p">,</span> <span class="n">num_sent</span><span class="p">,</span> <span class="n">next_walk</span><span class="p">,</span> <span class="n">jj</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(</span><span class="n">MPI_STATUS_SIZE</span><span class="p">)</span> <span class="kd">::</span> <span class="n">status</span>
		<span class="kt">logical</span> <span class="kd">::</span> <span class="n">debug_random</span>
    	<span class="k">call </span><span class="n">MPI_COMM_SIZE</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">num_processes</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
    	<span class="k">call </span><span class="n">MPI_COMM_RANK</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">process_num</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>

		<span class="n">ub_sum</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">n_success</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">num_sent</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="n">n_success_proc</span> <span class="o">=</span> <span class="mi">0</span>
	<span class="c">! ---</span>
	<span class="c">! MASTER PROCESS</span>
	<span class="c">! ---</span>
		<span class="k">if</span><span class="p">(</span><span class="n">process_num</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			allocate</span><span class="p">(</span><span class="n">int_array</span><span class="p">(</span><span class="n">n_mc</span><span class="p">))</span>	 <span class="c">! to hold answer from Workers</span>
 			<span class="c">! ---</span>
			<span class="c">! INITIALIZE THE PROCESS</span>
			<span class="c">! Send: 0, Tag: 1, To: Processes 1 to 3</span>
			<span class="c">! Increment number sent by 1</span>
 			<span class="c">! ---</span>
				<span class="k">do </span><span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">num_processes</span><span class="o">-</span><span class="mi">1</span>
					<span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">MPI_BOTTOM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
				    	<span class="n">m</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
					<span class="n">num_sent</span> <span class="o">=</span> <span class="n">num_sent</span> <span class="o">+</span> <span class="mi">1</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">debug_many</span><span class="p">)</span> <span class="k">then</span>
<span class="k">						print</span> <span class="s1">&#39;(&quot;Process &quot;,i1,&quot; sent tag = &quot;,i1, &quot; to process &quot;,i1)&#39;</span><span class="p">,</span><span class="n">process_num</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">m</span>
					<span class="n">endif</span>				
				<span class="n">enddo</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_many</span><span class="p">)</span> <span class="k">then</span>
<span class="k">					print</span> <span class="s1">&#39;(&quot;Number of values sent initially &quot;,i1)&#39;</span><span class="p">,</span><span class="n">num_sent</span>
				<span class="n">endif</span>			
			<span class="c">! ---</span>
			<span class="c">! RECIEVE ALL POSSIBLE CALLS TO RANDOM WALK</span>
			<span class="c">! Receive: answer_r, Tag: iabort (0 or 1), From: Any Process (1 to 3)</span>
			<span class="c">! Sender is now free</span>
			<span class="c">! ---</span>
				<span class="k">do </span><span class="n">m</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_mc</span>
					<span class="k">call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">answer_r</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
				        <span class="n">MPI_ANY_SOURCE</span><span class="p">,</span> <span class="n">MPI_ANY_TAG</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
					<span class="n">iabort_r</span> <span class="o">=</span> <span class="n">status</span><span class="p">(</span><span class="n">MPI_TAG</span><span class="p">)</span>
					<span class="n">sender</span> <span class="o">=</span> <span class="n">status</span><span class="p">(</span><span class="n">MPI_SOURCE</span><span class="p">)</span>    <span class="c">! Whichever process sent it is now free</span>
				<span class="c">! ---</span>
				<span class="c">! HAVE WE REACHED THE BOUNDARY?</span>
				<span class="c">! If the walk reached the boundary, iabort = 0, so add it to the array</span>
				<span class="c">! ---</span>
					<span class="k">if</span><span class="p">(</span><span class="n">iabort_r</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">						</span><span class="n">int_array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">=</span> <span class="n">answer_r</span>
						<span class="n">n_success</span> <span class="o">=</span> <span class="n">n_success</span> <span class="o">+</span> <span class="mi">1</span>
					<span class="k">else</span>
<span class="k">						</span><span class="n">int_array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
						<span class="n">n_success</span> <span class="o">=</span> <span class="n">n_success</span>
					<span class="n">endif</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">debug_many</span><span class="p">)</span> <span class="k">then</span>
<span class="k">						print</span> <span class="s1">&#39;(&quot;Process &quot;,i1,&quot; recieved answer = &quot;,es22.14,&quot; tag = &quot;,i3, &quot; from process &quot;,i1)&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
						<span class="n">process_num</span><span class="p">,</span><span class="n">int_array</span><span class="p">(</span><span class="n">m</span><span class="p">),</span><span class="n">iabort_r</span><span class="p">,</span><span class="n">sender</span>
					<span class="n">endif</span>
				<span class="c">! ---</span>
				<span class="c">! SEND ADDITIONAL CALLS TO RANDOM WALK </span>
				<span class="c">! If the number sent is less than the number of Monte Carlo points</span>
				<span class="c">! Send: 0, Tag: 1, To: Processes 1 to 3 (whichever is free)</span>
				<span class="c">! Increment number sent by 1</span>
				<span class="c">! ---</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">num_sent</span> <span class="p">.</span><span class="n">LT</span><span class="p">.</span> <span class="n">n_mc</span><span class="p">)</span> <span class="k">then</span>
<span class="k">						call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">MPI_BOTTOM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
				    	<span class="n">sender</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
						<span class="n">num_sent</span> <span class="o">=</span> <span class="n">num_sent</span> <span class="o">+</span> <span class="mi">1</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">debug_many</span><span class="p">)</span> <span class="k">then</span>
<span class="k">							print</span> <span class="s1">&#39;(&quot;Process &quot;,i1,&quot; sent tag = &quot;,i1, &quot; to process &quot;,i1)&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
							<span class="n">process_num</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">sender</span>
						<span class="n">endif</span>
				<span class="c">! ---</span>
				<span class="c">! END WORKER PROCESSES</span>
				<span class="c">! Send: 0, Tag: 0, To: Processes 1 to 3 (whichever is free)</span>
				<span class="c">! ---</span>
				  	<span class="k">else</span>
<span class="k">						call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">MPI_BOTTOM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
						<span class="n">sender</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
				  	<span class="n">endif</span>
				<span class="n">enddo</span>
			<span class="c">! ---</span>
			<span class="c">! SUM OVER THE ARRAY TO RETURN U_MC TO MANY_WALKS</span>
			<span class="c">! ---</span>
				<span class="n">ub_sum</span><span class="o">=</span><span class="nb">sum</span><span class="p">(</span><span class="n">int_array</span><span class="p">)</span> 		<span class="c">! Summation of the values from each process</span>
				<span class="n">u_mc</span> <span class="o">=</span> <span class="n">ub_sum</span><span class="o">/</span><span class="n">n_success</span>		<span class="c">! Returned to many_walks</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug_many</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			 		print</span> <span class="s1">&#39;(&quot;Returned answer &quot;,es22.14)&#39;</span><span class="p">,</span> <span class="n">u_mc</span>
		 			<span class="k">print</span> <span class="s1">&#39;(&quot;Number of values sent finally &quot;,i10)&#39;</span><span class="p">,</span> <span class="n">num_sent</span>
				<span class="n">endif</span>
 		<span class="n">endif</span>

	<span class="c">! ---</span>
	<span class="c">! WORKER PROCESS</span>
	<span class="c">! ---</span>
 		<span class="k">if</span><span class="p">(</span><span class="n">process_num</span> <span class="p">.</span><span class="n">GT</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>

<span class="k">			do while</span> <span class="p">(.</span><span class="n">true</span><span class="p">.)</span>
				<span class="c">! ---</span>
				<span class="c">! RECIEVE CALLS FROM MASTER PROCESS</span>
				<span class="c">! Receive: 0, Tag: 1, From: Master (0)</span>
				<span class="c">! Sender is now free</span>
				<span class="c">! ---</span>
					<span class="k">call </span><span class="n">MPI_RECV</span><span class="p">(</span><span class="n">MPI_BOTTOM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
				        <span class="n">MPI_ANY_SOURCE</span><span class="p">,</span> <span class="n">MPI_ANY_TAG</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
					<span class="n">r</span> <span class="o">=</span> <span class="n">status</span><span class="p">(</span><span class="n">MPI_TAG</span><span class="p">)</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">debug_many</span><span class="p">)</span> <span class="k">then</span>
<span class="k">				 		print</span> <span class="s1">&#39;(&quot;Process &quot;,i1,&quot; recieved tag = &quot;,i1, &quot; from process &quot;,i1)&#39;</span><span class="p">,</span><span class="n">process_num</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="mi">0</span>
					<span class="n">endif</span>
				<span class="c">! ---</span>
				<span class="c">! THERE IS ANOTHER WALK TO DO</span>
				<span class="c">! Call Random Walk again</span>
				<span class="c">! ---</span>
					<span class="k">if</span><span class="p">(</span><span class="n">r</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">						</span><span class="n">i</span> <span class="o">=</span> <span class="n">i0</span>
						<span class="n">j</span> <span class="o">=</span> <span class="n">j0</span>
						<span class="n">debug_random</span> <span class="o">=</span> <span class="p">.</span><span class="n">False</span><span class="p">.</span>	<span class="c">! Change n_mc to 3 if debugging this</span>
						<span class="k">call </span><span class="n">random_walk</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">iabort</span><span class="p">,</span> <span class="n">debug_random</span><span class="p">)</span>
					<span class="c">! ---</span>
					<span class="c">! SEND THE ANSWER TO THE MASTER</span>
					<span class="c">! Send: ub, Tag: iabort(0 or 1), To: Master (Process 0)</span>
					<span class="c">! ---</span>
						<span class="k">call </span><span class="n">MPI_SEND</span><span class="p">(</span><span class="n">ub</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MPI_DOUBLE_PRECISION</span><span class="p">,</span> <span class="p">&amp;</span>
							<span class="mi">0</span><span class="p">,</span> <span class="n">iabort</span><span class="p">,</span> <span class="n">MPI_COMM_WORLD</span><span class="p">,</span> <span class="n">ierr</span><span class="p">)</span>
						<span class="k">if</span> <span class="p">(</span><span class="n">debug_many</span><span class="p">)</span> <span class="k">then</span>
<span class="k">							print</span> <span class="s1">&#39;(&quot;Process &quot;,i1,&quot; sent answer = &quot;,es22.14, &quot; &amp; tag = &quot;,i3, &quot; to process &quot;,i1)&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
						 	<span class="n">process_num</span><span class="p">,</span><span class="n">ub</span><span class="p">,</span><span class="n">iabort</span><span class="p">,</span><span class="mi">0</span>
						<span class="n">endif</span>
				<span class="c">! ---</span>
				<span class="c">! THERE ISN&#39;T ANOTHER WALK TO DO</span>
				<span class="c">! Worker finishes</span>
				<span class="c">! ---</span>
					<span class="k">else if</span><span class="p">(</span><span class="n">r</span> <span class="p">.</span><span class="n">EQ</span><span class="p">.</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">						if</span> <span class="p">(</span><span class="n">debug_many</span><span class="p">)</span> <span class="k">then</span>
<span class="k">							print</span> <span class="s1">&#39;(&quot;Process &quot;,i1,&quot; ended &quot;)&#39;</span><span class="p">,</span> <span class="n">process_num</span>
						<span class="n">endif</span>
						<span class="n">go</span> <span class="n">to</span> <span class="mi">100</span>
					<span class="n">endif</span>
			<span class="n">enddo</span>
 		<span class="n">endif</span>
<span class="c">! ----</span>
<span class="c">! COMPLETE MPI</span>
<span class="c">! ----</span>
<span class="mi">100</span> 	<span class="k">continue</span> <span class="c">! Jumps here if the Worker finishes</span>
 
	<span class="k">end subroutine </span><span class="n">many_walks</span>

<span class="k">end module </span><span class="n">mc_walk</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="c">! ---</span>
<span class="c">! This module returns seed for the random_number function</span>
<span class="c">! ---</span>
<span class="k">module </span><span class="n">random_util</span>

<span class="k">contains</span>

<span class="k">	subroutine </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Declare the parameters</span>
	<span class="c">! ---</span>
		<span class="kt">integer</span><span class="p">,</span> <span class="k">intent</span><span class="p">(</span><span class="n">inout</span><span class="p">)</span> <span class="kd">::</span> <span class="n">seed1</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">clock</span> 
		<span class="kt">integer</span><span class="p">,</span> <span class="k">dimension</span><span class="p">(:),</span> <span class="k">allocatable</span> <span class="kd">::</span> <span class="n">seed</span>
	<span class="c">! ---</span>
	<span class="c">! Determine how many numbers needed to seed and allocate</span>
	<span class="c">! ---</span>
		<span class="k">call </span><span class="nb">random_seed</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">nseed</span><span class="p">)</span>  
		<span class="k">allocate</span><span class="p">(</span><span class="n">seed</span><span class="p">(</span><span class="n">nseed</span><span class="p">))</span>
	<span class="c">! ---  </span>
	<span class="c">! If seed1 = 0 then set seed1 randomly using the system clock.</span>
	<span class="c">! This will give different sequences of random numbers</span>
	<span class="c">! from different runs, so results are not reproducible.</span>
	<span class="c">! ---</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">seed1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="k">then</span>
<span class="k">		    call </span><span class="nb">system_clock</span><span class="p">(</span><span class="nb">count</span> <span class="o">=</span> <span class="n">clock</span><span class="p">)</span>
		    <span class="n">seed1</span> <span class="o">=</span> <span class="n">clock</span>
		<span class="n">endif</span>
	<span class="c">! ---</span>
	<span class="c">! If seed1 &gt; 0 then results will be reproducible since calling this</span>
	<span class="c">! twice with the same seed will initialize the random</span>
	<span class="c">! number generator so the same sequence is generated.</span>
	<span class="c">! Once seed1 is set, set the other elements of the seed array by adding</span>
	<span class="c">! multiples of 37 as suggested in the documentation. </span>
	<span class="c">! --- </span>
		<span class="k">do </span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">nseed</span>
		    <span class="n">seed</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">=</span> <span class="n">seed1</span> <span class="o">+</span> <span class="mi">37</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  
		<span class="n">enddo</span>
	<span class="c">! ---</span>
	<span class="c">! Seed the generator</span>
	<span class="c">! ---</span>
		<span class="k">call </span><span class="nb">random_seed</span><span class="p">(</span><span class="n">put</span> <span class="o">=</span> <span class="n">seed</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Deallocate the seed</span>
	<span class="c">! ---</span>
		<span class="k">deallocate</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

	<span class="k">end subroutine </span><span class="n">init_random_seed</span>

<span class="k">end module </span><span class="n">random_util</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test1</span>
<span class="c">! ---</span>
<span class="c">! Uses random seed module</span>
<span class="c">! ---</span>
	<span class="k">use </span><span class="n">mc_walk</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">random_walk</span><span class="p">,</span> <span class="n">n_walks</span><span class="p">,</span> <span class="n">x</span>
	<span class="k">use </span><span class="n">random_util</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">init_random_seed</span>
	<span class="k">use </span><span class="n">problem_description</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">utrue</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>
		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ub</span><span class="p">,</span> <span class="n">rel_error</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">iabort</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">seed1</span><span class="p">,</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span>

	<span class="c">! ---</span>
	<span class="c">! Number of steps is unknown, so we must allocate:</span>
	<span class="c">! ---</span>
		<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
		<span class="k">allocate</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">max_steps</span><span class="p">))</span> <span class="c">! random number array 0 to 1 </span>

	<span class="c">! Try it out from a specific (x0,y0):</span>
		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.9</span>
		<span class="n">y0</span> <span class="o">=</span> <span class="mf">0.6</span>
		
		<span class="n">i0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span>
		<span class="n">j0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">y0</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

		<span class="c">! shift (x0,y0) to a grid point if it wasn&#39;t already:</span>
		<span class="n">x0</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">i0</span><span class="o">*</span><span class="n">dx</span>
		<span class="n">y0</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">+</span> <span class="n">j0</span><span class="o">*</span><span class="n">dy</span>

		<span class="n">u_true</span> <span class="o">=</span> <span class="n">utrue</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span>

	<span class="c">! ---</span>
	<span class="c">! Generate random number array x (0 to 1)</span>
	<span class="c">! ---</span>
		<span class="n">seed1</span> <span class="o">=</span> <span class="mi">12345</span>   	<span class="c">! seed1 = 12345 for repeatable seed</span>
						<span class="c">! seed1 = 0 for random seed</span>
		<span class="k">call </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
		<span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">i0</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">j0</span>

    	<span class="n">n_success</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot; True solution of PDE at x =&quot;,f10.4,&quot; y =&quot;,f10.4)&#39;</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot; i =&quot;,i8,&quot; j =&quot;,i8)&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot; u_true =   &quot;,es13.3)&#39;</span><span class="p">,</span> <span class="n">u_true</span>
		<span class="k">call </span><span class="n">random_walk</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">iabort</span><span class="p">)</span> 
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;ub=&quot;</span><span class="p">,</span> <span class="n">ub</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;x=&quot;</span><span class="p">,</span><span class="n">x</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;iabort=&quot;</span><span class="p">,</span> <span class="n">iabort</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;nwalks=&quot;</span><span class="p">,</span> <span class="n">n_walks</span>

<span class="k">end program </span><span class="n">test1</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test1b</span>
<span class="c">! ---</span>
<span class="c">! Uses random seed module</span>
<span class="c">! ---</span>
	<span class="k">use </span><span class="n">mc_walk</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">random_walk</span><span class="p">,</span> <span class="n">n_walks</span><span class="p">,</span> <span class="n">x</span>
	<span class="k">use </span><span class="n">random_util</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">init_random_seed</span>
	<span class="k">use </span><span class="n">problem_description</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">utrue</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>
	<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">ub</span><span class="p">,</span> <span class="n">rel_error</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span>
	<span class="kt">integer</span> <span class="kd">::</span> <span class="n">iabort</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">seed1</span><span class="p">,</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">n_mc</span>
<span class="c">!	integer, parameter :: nx = 19</span>
<span class="c">!	integer, parameter :: ny = 11</span>
<span class="c">! ---</span>
<span class="c">! Set the number of samples for the Monte Carlo Solution</span>
<span class="c">! ---</span>
	<span class="n">n_mc</span><span class="o">=</span><span class="mi">10</span>
<span class="c">! ---</span>
<span class="c">! Number of steps is unknown, so we must allocate:</span>
<span class="c">! ---</span>
	<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">20</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span><span class="o">*</span><span class="n">n_mc</span>
<span class="c">!	max_steps = 10</span>
	<span class="k">allocate</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">max_steps</span><span class="p">))</span> <span class="c">! random number array 0 to 1 </span>
<span class="c">! ---</span>
<span class="c">! Generate random number array x (0 to 1)</span>
<span class="c">! ---</span>
	<span class="n">seed1</span> <span class="o">=</span> <span class="mi">12345</span>   	<span class="c">! seed1 = 12345 for repeatable seed</span>
						<span class="c">! seed1 = 0 for random seed</span>
	<span class="k">call </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
	<span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="c">! Try it out from a specific (x0,y0):</span>
		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.9</span>
		<span class="n">y0</span> <span class="o">=</span> <span class="mf">0.6</span>
		
		<span class="n">i0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span>
		<span class="n">j0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">y0</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

		<span class="c">! shift (x0,y0) to a grid point if it wasn&#39;t already:</span>
		<span class="n">x0</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">i0</span><span class="o">*</span><span class="n">dx</span>
		<span class="n">y0</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">+</span> <span class="n">j0</span><span class="o">*</span><span class="n">dy</span>

		<span class="n">u_true</span> <span class="o">=</span> <span class="n">utrue</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span>

		<span class="n">i</span> <span class="o">=</span> <span class="n">i0</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">j0</span>
<span class="c">! ---</span>
<span class="c">! Record the number of times we successfully hit the boundary</span>
<span class="c">! ---</span>
	<span class="n">n_success</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c">! ---</span>
<span class="c">! Record the number of random walks we make</span>
<span class="c">! ---</span>
	<span class="n">n_walks</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c">! ---</span>
<span class="c">! Loop through and call a single random walk each time, indexing</span>
<span class="c">! You must start the walk using the last successful walk point</span>
<span class="c">! ---</span>
	<span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">n_mc</span> <span class="mi">0</span>
		<span class="k">call </span><span class="n">random_walk</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">ub</span><span class="p">,</span> <span class="n">iabort</span><span class="p">)</span> 
		<span class="k">if</span><span class="p">(</span><span class="n">iabort</span> <span class="p">.</span><span class="n">NE</span><span class="p">.</span> <span class="mi">1</span><span class="p">)</span> <span class="k">then</span>
<span class="k">			</span><span class="n">ub_sum</span> <span class="o">=</span> <span class="n">ub_sum</span> <span class="o">+</span> <span class="n">ub</span>
			<span class="n">n_success</span> <span class="o">=</span> <span class="n">n_success</span> <span class="o">+</span> <span class="mi">1</span>
		<span class="n">endif</span>
		<span class="n">u_mc</span> <span class="o">=</span> <span class="n">ub_sum</span><span class="o">/</span><span class="n">n_success</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;ub=&quot;</span><span class="p">,</span> <span class="n">ub</span>
	<span class="c">!	print *, &quot;x=&quot;,x(k)</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;iabort=&quot;</span><span class="p">,</span> <span class="n">iabort</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;nwalks=&quot;</span><span class="p">,</span> <span class="n">n_walks</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;n_success=&quot;</span><span class="p">,</span> <span class="n">n_success</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;u_mc=&quot;</span><span class="p">,</span> <span class="n">u_mc</span>
	<span class="n">enddo</span>
<span class="k">end program </span><span class="n">test1b</span>
</pre></div>
</div>
<div class="highlight-fortran"><div class="highlight"><pre><span></span><span class="k">program </span><span class="n">test2</span>
<span class="c">! ---</span>
<span class="c">! Uses random seed module</span>
<span class="c">! ---</span>
	<span class="k">use </span><span class="n">mc_walk</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">random_walk</span><span class="p">,</span> <span class="n">many_walks</span><span class="p">,</span> <span class="n">n_walks</span><span class="p">,</span> <span class="n">x</span>
	<span class="k">use </span><span class="n">random_util</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">init_random_seed</span>
	<span class="k">use </span><span class="n">problem_description</span><span class="p">,</span> <span class="n">only</span><span class="p">:</span> <span class="n">utrue</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ay</span><span class="p">,</span> <span class="n">bx</span><span class="p">,</span> <span class="n">by</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span>

		<span class="kt">real</span><span class="p">(</span><span class="nb">kind</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="kd">::</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">rel_error</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span>
		<span class="kt">integer</span> <span class="kd">::</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">seed1</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">j0</span>
	<span class="c">! ---</span>
	<span class="c">! Number of steps is unknown, so we must allocate</span>
	<span class="c">! 200000 is the maximum number of moves</span>
	<span class="c">! ---</span>
		<span class="n">n_mc</span> <span class="o">=</span> <span class="mi">10</span>
		<span class="n">max_steps</span> <span class="o">=</span> <span class="mi">200000</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">)</span>
		<span class="c">!max_steps = 25</span>
		<span class="k">allocate</span><span class="p">(</span><span class="n">x</span><span class="p">(</span><span class="n">max_steps</span><span class="p">))</span> <span class="c">! random number array 0 to 1 </span>
	<span class="c">! Try it out from a specific (x0,y0):</span>
		<span class="n">x0</span> <span class="o">=</span> <span class="mf">0.9</span>
		<span class="n">y0</span> <span class="o">=</span> <span class="mf">0.6</span>
		
		<span class="n">i0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">x0</span><span class="o">-</span><span class="n">ax</span><span class="p">)</span><span class="o">/</span><span class="n">dx</span><span class="p">)</span>
		<span class="n">j0</span> <span class="o">=</span> <span class="nb">nint</span><span class="p">((</span><span class="n">y0</span><span class="o">-</span><span class="n">ay</span><span class="p">)</span><span class="o">/</span><span class="n">dy</span><span class="p">)</span>

		<span class="c">! shift (x0,y0) to a grid point if it wasn&#39;t already:</span>
		<span class="n">x0</span> <span class="o">=</span> <span class="n">ax</span> <span class="o">+</span> <span class="n">i0</span><span class="o">*</span><span class="n">dx</span>
		<span class="n">y0</span> <span class="o">=</span> <span class="n">ay</span> <span class="o">+</span> <span class="n">j0</span><span class="o">*</span><span class="n">dy</span>

		<span class="n">u_true</span> <span class="o">=</span> <span class="n">utrue</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span><span class="n">y0</span><span class="p">)</span>

	<span class="c">! ---</span>
	<span class="c">! Generate random number array x (0 to 1)</span>
	<span class="c">! ---</span>
		<span class="n">seed1</span> <span class="o">=</span> <span class="mi">12345</span>   	<span class="c">! seed1 = 12345 for repeatable seed</span>
							<span class="c">! seed1 = 0 for random seed</span>
		<span class="k">call </span><span class="n">init_random_seed</span><span class="p">(</span><span class="n">seed1</span><span class="p">)</span>
		<span class="k">call </span><span class="nb">random_number</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
	<span class="c">! ---</span>
	<span class="c">! Set the point of interest</span>
	<span class="c">! ---</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">i0</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">j0</span>
	<span class="c">! ---</span>
	<span class="c">! Record the number of random walks we make</span>
	<span class="c">! ---</span>
		<span class="n">n_walks</span> <span class="o">=</span> <span class="mi">0</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot; True solution of PDE at x =&quot;,f10.4,&quot; y =&quot;,f10.4)&#39;</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span>
		<span class="k">print</span> <span class="s1">&#39;(&quot; u_true =   &quot;,es13.3)&#39;</span><span class="p">,</span> <span class="n">u_true</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
		<span class="k">print</span> <span class="o">*</span><span class="p">,</span> <span class="s2">&quot;    Successes  Walks    Monte Carlo Solution    Relative Error&quot;</span>
		<span class="k">do </span><span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">13</span>
			<span class="k">call </span><span class="n">many_walks</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">max_steps</span><span class="p">,</span> <span class="n">n_mc</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">n_success</span><span class="p">)</span>
			<span class="n">n_mc</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">n_mc</span>
			<span class="n">rel_error</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">u_true</span><span class="o">-</span><span class="n">u_mc</span><span class="p">)</span><span class="o">/</span><span class="n">u_true</span>
			<span class="k">print</span> <span class="s1">&#39;(&quot;  &quot;,i8,&quot; &quot;,i8,&quot;      &quot;,es13.3,&quot;        &quot;,es13.3)&#39;</span><span class="p">,</span> <span class="p">&amp;</span>
			<span class="n">n_success</span><span class="p">,</span> <span class="n">n_walks</span><span class="p">,</span> <span class="n">u_mc</span><span class="p">,</span> <span class="n">rel_error</span>
		<span class="n">enddo</span>

<span class="k">end program </span><span class="n">test2</span>
</pre></div>
</div>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">pylab</span> <span class="k">import</span> <span class="o">*</span>

<span class="c1"># read in three columns from file and unpack into 3 arrays:</span>
<span class="n">n</span><span class="p">,</span><span class="n">int_approx</span><span class="p">,</span><span class="n">error</span> <span class="o">=</span> <span class="n">loadtxt</span><span class="p">(</span><span class="s1">&#39;laplace_mc.txt&#39;</span><span class="p">,</span><span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">clf</span><span class="p">()</span>
<span class="n">loglog</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">error</span><span class="p">,</span><span class="s1">&#39;-o&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Monte-Carlo&#39;</span><span class="p">)</span>
<span class="n">loglog</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="n">e7</span><span class="p">],[</span><span class="mi">1</span><span class="p">,</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span><span class="p">)],</span><span class="s1">&#39;k&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;1 / sqrt(N)&#39;</span><span class="p">)</span>
<span class="n">legend</span><span class="p">()</span>
<span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;number of MC points used&#39;</span><span class="p">)</span>
<span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;abs(error)&#39;</span><span class="p">)</span>
<span class="n">title</span><span class="p">(</span><span class="s1">&#39;Log-log plot of relative error in MC quadrature&#39;</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;mc_quad_error.png&#39;</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>


      </div>
      <div class="bottomnav" role="navigation" aria-label="bottom navigation">
      
        <p>
        «&#160;&#160;<a href="../02_barba_projects/assignments.html">2.3.1. Finite Difference and Finite Volume Projects</a>
        &#160;&#160;::&#160;&#160;
        <a class="uplink" href="../index.html">Contents</a>
        &#160;&#160;::&#160;&#160;
        <a href="../04_literature/literature.html">4. Literature</a>&#160;&#160;»
        </p>

      </div>

    <div class="footer" role="contentinfo">
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.4.6.
    </div>
  </body>
</html>